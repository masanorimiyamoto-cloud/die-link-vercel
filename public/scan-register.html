<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>æ£šâ†’å‹ QRã‚¹ã‚­ãƒ£ãƒ³ç™»éŒ²_air_on</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root {
    --primary: #005f73; --primary-light: #e0f2f1;
    --secondary: #0a9396; --accent: #94d2bd;
    --danger: #9b2226; --danger-light: #fbeae5;
    --fg: #212529; --fg-sub: #6c757d; --bg: #f8f9fa;
    --border: #dee2e6; --shadow: rgba(0,0,0, .1);
    --success: #2a9d8f; --success-light: #e9f5f4;
  }
  body {
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
    margin: 0; background: var(--bg); color: var(--fg);
    display: flex; flex-direction: column; min-height: 100vh;
  }
  .container { max-width: 720px; margin: 0 auto; padding: 16px; width:100%; box-sizing:border-box; }
  header {
    background: #fff; border-bottom: 1px solid var(--border);
    padding: 12px 16px; position: sticky; top: 0; z-index: 100;
  }
  header h1 {
    font-size: 1.4rem; margin: 0; text-align: center;
  }
  .cam-controls { display: flex; gap: 12px; justify-content: center; margin-top: 12px; }

  /* --- Camera View --- */
  .view-wrapper { position: relative; width: 100%; max-width: 420px; margin: 20px auto; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px var(--shadow); }
  video { width: 100%; display: block; background: #000; }
  canvas#ov { position: absolute; inset: 0; width: 100%; height: 100%; }
  canvas#scanCanvas { display: none; } /* Hidden canvas for scanning */

  /* --- Workflow Steps --- */
  .workflow { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 10px; margin: 16px 0; }
  .step { padding: 10px; border: 2px solid var(--border); border-radius: 12px; text-align: center; background: #fff; transition: all .3s ease; }
  .step.active { border-color: var(--primary); background: var(--primary-light); font-weight: 700; transform: scale(1.05); }
  .step .num { font-size: 12px; color: var(--fg-sub); }
  .step .label { font-size: 16px; }
  .connector { height: 2px; background: var(--border); }

  /* --- Content Sections --- */
  .content-section { background: #fff; border: 1px solid var(--border); border-radius: 14px; margin-bottom: 16px; overflow: hidden; }
  .content-header { padding: 12px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
  .content-header h2 { margin: 0; font-size: 1.1rem; }
  .content-body { padding: 16px; }
  .placeholder { color: var(--fg-sub); text-align: center; padding: 20px; }
  #die-section { display: none; } /* Initially hidden */

  /* --- Fixed LOC/DIE Display --- */
  .loc-display { background: var(--success-light); border: 2px solid var(--success); padding: 16px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; gap: 12px; }
  .loc-display .val { font-size: 1.5rem; font-weight: 700; color: var(--success); }
  .die-list .item { border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
  .die-list .item .info { flex-grow: 1; }
  .die-list .item .head { font-weight: 700; }
  .die-list .item .head .wc { color: var(--primary); }
  .die-list .item .sub { font-size: 12px; color: var(--fg-sub); display: block; margin-top: 4px; word-break: break-all; }

  /* --- Controls & Buttons --- */
  .btn {
    display: inline-flex; align-items: center; gap: 8px; font-size: 1rem;
    padding: 10px 16px; border-radius: 10px; border: 1px solid var(--border);
    background: #fff; cursor: pointer; transition: all .2s ease; font-weight: 600;
  }
  .btn:hover { border-color: var(--fg-sub); }
  .btn:disabled { cursor: not-allowed; opacity: .6; }
  .btn-primary { background: var(--primary); color: #fff; border-color: var(--primary); }
  .btn-primary:hover { background: var(--secondary); border-color: var(--secondary); }
  .btn-danger { color: var(--danger); }
  .btn-sm { padding: 6px 10px; font-size: 0.9rem; }
  .btn svg { width: 1.2em; height: 1.2em; }
  .actions { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: flex-end; }
  #btnUpdate.loading { background: var(--fg-sub); }

  /* --- Misc --- */
  #err { color: var(--danger); background: var(--danger-light); padding: 10px; border-radius: 8px; margin-top: 12px; white-space: pre-wrap; display: none; }
  .toastWrap { position: fixed; right: 10px; top: 10px; display: flex; flex-direction: column; gap: 8px; z-index: 1000; }
  .toast { background: #111; color: #fff; padding: 8px 12px; border-radius: 10px; font-size: 14px; opacity: .95; box-shadow: 0 4px 16px var(--shadow); }
  .toast small { color: #9cc; margin-left: 6px; }

  /* SVG Icons */
  .icon-trash { stroke: currentColor; }
  .icon-clear { stroke: currentColor; }
  .icon-upload { stroke: #fff; }
</style>
</head>
<body>

<header>
  <h1>æ£šâ†’å‹ QRã‚¹ã‚­ãƒ£ãƒ³ç™»éŒ²_air_on</h1>
  <div class="cam-controls">
    <button id="btnStart" class="btn btn-primary">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
    <button id="btnStop" class="btn" disabled>åœæ­¢</button>
  </div>
</header>

<main class="container">
  <div class="view-wrapper">
    <video id="v" playsinline muted></video>
    <canvas id="ov"></canvas>
  </div>
  <canvas id="scanCanvas"></canvas>
  <div id="err"></div>

  <div class="workflow">
    <div id="step1" class="step active">
      <div class="num">STEP 1</div>
      <div class="label">æ£šã‚’ã‚¹ã‚­ãƒ£ãƒ³</div>
    </div>
    <div class="connector"></div>
    <div id="step2" class="step">
      <div class="num">STEP 2</div>
      <div class="label">å‹ã‚’ã‚¹ã‚­ãƒ£ãƒ³</div>
    </div>
  </div>

  <div id="loc-section" class="content-section">
    <div class="content-header">
      <h2>â‘  å›ºå®šä¸­ã®æ£š (LOC)</h2>
    </div>
    <div class="content-body">
      <div id="loc-content">
        <div class="placeholder">ã‚«ãƒ¡ãƒ©ã§æ£šã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>
      </div>
    </div>
  </div>

  <div id="die-section" class="content-section">
    <div class="content-header">
      <h2>â‘¡ ç™»éŒ²ã™ã‚‹å‹ (DIE)</h2>
      <span style="flex-grow:1"></span>
      <button id="btnClearDies" class="btn btn-danger btn-sm">
        <svg class="icon-clear" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
        <span>å…¨æ¶ˆå»</span>
      </button>
    </div>
    <div class="content-body">
      <div id="dieList" class="die-list">
        <div class="placeholder">æ¬¡ã«å‹ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™</div>
      </div>
    </div>
  </div>

  <div class="actions">
    <button id="btnUpdate" class="btn btn-primary" disabled>
      <svg class="icon-upload" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
      <span id="btnUpdateLabel">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç™»éŒ²</span>
    </button>
  </div>
</main>

<div class="toastWrap" id="toasts"></div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
<script>
// ========= è¨­å®š (Settings) =========
const SHEET_ENDPOINT = "/api/gsheet-seen-bulk";
const AIRTABLE_ENDPOINT = "/api/airtable-update"; // Airtable APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
const AIRTABLE_ENABLED = true; // â˜… Airtableæ›´æ–°ã‚’ä¸€æ™‚åœæ­¢
const SCAN_RESOLUTION = 600; // ã‚¹ã‚­ãƒ£ãƒ³è§£åƒåº¦(px)ã€‚é«˜ã„ã»ã©é«˜ç²¾ç´°ã ãŒé…ããªã‚‹ã€‚600-800ãŒãŠã™ã™ã‚ã€‚

// ========= çŠ¶æ…‹ (State) =========
let fixedLoc = null;
const fixedDies = new Map();
const flashes = [];
const bubbles = [];
let candidates = [];

// ========= DOMè¦ç´  (DOM Elements) =========
const $ = (q) => document.querySelector(q);
const v = $("#v"), scanCanvas = $("#scanCanvas"), ov = $("#ov");
const octx = ov.getContext("2d");
const sctx = scanCanvas.getContext("2d", { willReadFrequently: true });
const errEl = $("#err"), toasts = $("#toasts");
const btnUpdate = $("#btnUpdate");

// ========= UIæ›´æ–° (UI Updates) =========
function updateUIState() {
  const step1 = $("#step1"), step2 = $("#step2");
  const locSection = $("#loc-section"), dieSection = $("#die-section");
  const locContent = $("#loc-content");

  // Step 1: æ£š (LOC)
  if (fixedLoc) {
    step1.classList.add('active');
    locContent.innerHTML = `
      <div class="loc-display">
        <div>
          <div class="sub">å›ºå®šä¸­ã®æ£š</div>
          <div class="val">${escapeHtml(fixedLoc.loc)}</div>
        </div>
        <button id="btnClearLoc" class="btn btn-danger btn-sm">
          <svg class="icon-clear" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 4H8l-7 8 7 8h13a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"></path><line x1="18" y1="9" x2="12" y2="15"></line><line x1="12" y1="9" x2="18" y2="15"></line></svg>
          <span>è§£é™¤</span>
        </button>
      </div>`;
    $("#btnClearLoc").addEventListener("click", () => {
      fixedLoc = null;
      fixedDies.clear(); // æ£šã‚’è§£é™¤ã—ãŸã‚‰å‹ã‚‚ã‚¯ãƒªã‚¢
      updateUIState();
      renderDies();
    });
    dieSection.style.display = 'block';
  } else {
    step1.classList.add('active');
    step2.classList.remove('active');
    locContent.innerHTML = `<div class="placeholder">ã‚«ãƒ¡ãƒ©ã§æ£šã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‹ã–ã—ã¦ãã ã•ã„</div>`;
    dieSection.style.display = 'none';
  }

  // Step 2: å‹ (DIE)
  if (fixedLoc && fixedDies.size > 0) {
    step1.classList.remove('active');
    step2.classList.add('active');
  } else if (fixedLoc) {
    step1.classList.remove('active');
    step2.classList.add('active');
  } else {
    step2.classList.remove('active');
  }

  // Step 3: æ›´æ–°ãƒœã‚¿ãƒ³ (Update Button)
  btnUpdate.disabled = !fixedLoc || fixedDies.size === 0;
}

function renderDies() {
  const dieListEl = $("#dieList");
  if (fixedDies.size === 0) {
    dieListEl.innerHTML = `<div class="placeholder">æ¬¡ã«å‹ã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¾ã™</div>`;
  } else {
    dieListEl.innerHTML = [...fixedDies.values()].map(d => {
      const key = `${d.bn}-${d.wc}`;
      return `<div class="item" data-key="${key}">
        <div class="info">
          <div class="head">
            <span class="sub">${escapeHtml(d.bn)}</span>
            <span class="wc">[<b>${escapeHtml(d.wc)}</b>]</span>
          </div>
          ${d.wn ? `<div class="sub">WorkName: ${escapeHtml(d.wn)}</div>` : ''}
          <div class="sub">RAW: ${escapeHtml(d.raw.length > 70 ? d.raw.slice(0, 70) + "â€¦" : d.raw)}</div>
        </div>
        <button class="btn btn-danger btn-sm" data-del="${key}">
            <svg class="icon-trash" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        </button>
      </div>`;
    }).join("");
  }
  dieListEl.querySelectorAll('button[data-del]').forEach(b => {
    b.onclick = () => {
      fixedDies.delete(b.dataset.del);
      renderDies();
      updateUIState();
    };
  });
  updateUIState();
}

// ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ (Utilities) =========
const dieKey = (bn, wc) => `${bn}-${wc}`;
function setError(t) { errEl.textContent = t || ""; errEl.style.display = t ? 'block' : 'none'; }
function escapeHtml(s) { return String(s ?? '').replace(/[&<>"]/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;' }[c])); }
function toast(msg, sub = "") { const el = document.createElement("div"); el.className = "toast"; el.innerHTML = `${msg}${sub ? ` <small>${sub}</small>` : ""}`; toasts.appendChild(el); setTimeout(() => { el.style.opacity = "0"; el.style.transform = "translateY(-6px)"; }, 1200); setTimeout(() => { el.remove(); }, 1800); }
let AC = null;
function playBeep(freq = 880, dur = 120) { try { if (!AC) AC = new (window.AudioContext || window.webkitAudioContext)(); const o = AC.createOscillator(), g = AC.createGain(); o.type = "sine"; o.frequency.value = freq; g.gain.value = 0.0001; o.connect(g); g.connect(AC.destination); const t = AC.currentTime; g.gain.exponentialRampToValueAtTime(0.08, t + 0.01); g.gain.exponentialRampToValueAtTime(0.0001, t + dur / 1000); o.start(); o.stop(t + dur / 1000 + 0.02); } catch { } }
function buzz(ms = 60) { if (navigator.vibrate) navigator.vibrate(ms); }
function classify(s){ if(/^loc-/i.test(s)) return "loc"; if(/^die-/i.test(s)) return "die"; try{ const u=new URL(s); if(u.searchParams.get("book")||u.searchParams.get("wc")) return "die"; }catch{} return "other"; }

// â˜… ä¿®æ­£: wn (WorkName) ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°ã‚’å¾©æ´»
function tryExtractWN(raw){ try{ const u = new URL(raw); const m = /[#&]d=([^&]+)/.exec(u.hash||""); if(!m) return ""; const b64 = m[1].replace(/-/g,'+').replace(/_/g,'/'); const pad = b64.length%4 ? '='.repeat(4-(b64.length%4)) : ''; const json = atob(b64 + pad); const obj = JSON.parse(json); return (obj.wn||"").trim(); }catch{ return ""; } }

// â˜… ä¿®æ­£: parseé–¢æ•°ã§ wn ã‚‚è¿”ã™ã‚ˆã†ã«ã™ã‚‹
function parse(text){ 
    const m = /^die-([^-\n]+)-(.+)$/.exec(text); 
    if(m){ return { bn:m[1].trim(), wc:m[2].trim(), wn:"" }; } // die- å½¢å¼ã®å ´åˆã¯ wn ã¯ç©º
    try{ const u=new URL(text); 
        const book=(u.searchParams.get("book")||"").trim(); 
        const wc=(u.searchParams.get("wc")||"").trim(); 
        if(book||wc){ return { bn:book, wc:wc, wn: tryExtractWN(text) }; } // URLå½¢å¼ã®å ´åˆã¯ wn ã‚’æŠ½å‡º
    }catch{} 
    const l=/^loc-(.+)$/i.exec(text); if(l){ return { loc:l[1].trim() }; } 
    return {}; 
}

// ========= æç”» (Canvas Overlays) =========
function drawPolygon(ctx, points){ ctx.beginPath(); ctx.moveTo(points[0].x, points[0].y); for(let i=1;i<points.length;i++) ctx.lineTo(points[i].x, points[i].y); ctx.closePath(); }
function roundedRect(ctx, x,y,w,h,r=10){ ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); }
function centroid(corners){ const xs=corners.map(p=>p.x), ys=corners.map(p=>p.y); return { x:(Math.min(...xs)+Math.max(...xs))/2, y:Math.min(...ys) }; }
function addFlash(kind, corners){ flashes.push({ kind, corners, until: performance.now()+1200 }); }
function addBubble(kind, corners, text){ const c = centroid(corners); const msg = (kind==='die' && fixedLoc) ? `${text} â†’ ${fixedLoc.loc}` : text; const color = kind==='loc' ? 'rgba(42, 157, 143, 0.92)' : 'rgba(0, 95, 115, 0.92)'; const stroke= 'rgba(255,255,255,0.9)'; bubbles.push({ text: msg, x:c.x, y:c.y, color, stroke, until: performance.now()+1600 }); }

function drawOverlays(){
  octx.clearRect(0,0,ov.width,ov.height);
  const scale = ov.width / scanCanvas.width;
  
  // å€™è£œã®æ ç·šã‚’æç”»
  for(const c of candidates){ 
    const isLoc = c.kind==='loc'; 
    const scaledCorners = c.corners.map(p => ({ x: p.x * scale, y: p.y * scale }));
    octx.setLineDash(c.registered ? [8,6] : []); 
    octx.lineWidth = c.registered ? 4 : 2; 
    octx.strokeStyle = isLoc ? 'rgba(42, 157, 143,0.95)' : 'rgba(0, 95, 115,0.95)'; 
    octx.fillStyle = isLoc ? 'rgba(42, 157, 143,0.18)' : 'rgba(0, 95, 115,0.18)'; 
    drawPolygon(octx, scaledCorners); octx.stroke(); octx.fill(); 
  }
  
  // ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æç”»
  for(let i=flashes.length-1; i>=0; i--){ 
    const f = flashes[i]; const remain = f.until - performance.now(); if(remain <= 0){ flashes.splice(i,1); continue; } 
    const t = Math.max(0, Math.min(1, remain/1200)); 
    const scaledCorners = f.corners.map(p => ({ x: p.x * scale, y: p.y * scale }));
    const color = f.kind==='loc' ? `rgba(42, 157, 143,${0.2+0.6*t})` : `rgba(0, 95, 115,${0.2+0.6*t})`; 
    const stroke = f.kind==='loc' ? `rgba(42, 157, 143,${0.6+0.4*t})` : `rgba(0, 95, 115,${0.6+0.4*t})`; 
    octx.fillStyle = color; octx.strokeStyle = stroke; octx.lineWidth = 4 + 4*t; 
    drawPolygon(octx, scaledCorners); octx.stroke(); octx.fill(); 
  }
  
  // å¹ãå‡ºã—ã‚’æç”»
  for(let i=bubbles.length-1; i>=0; i--){ 
    const b = bubbles[i]; const remain = b.until - performance.now(); if(remain <= 0){ bubbles.splice(i,1); continue; } 
    const t = Math.max(0, Math.min(1, remain/1600)); 
    const scaledCentroid = { x: b.x * scale, y: b.y * scale };
    octx.globalAlpha = 0.9 * t; octx.font = '16px system-ui, sans-serif'; 
    const w = octx.measureText(b.text).width + 20; const h = 36; 
    let x = scaledCentroid.x - w/2, y = scaledCentroid.y - h - 8; 
    x = Math.max(6, Math.min(x, ov.width - w - 6)); y = Math.max(6, Math.min(y, ov.height - h - 6)); 
    octx.fillStyle = b.color; octx.strokeStyle = b.stroke; octx.lineWidth = 2; 
    roundedRect(octx, x, y, w, h, 10); octx.fill(); octx.stroke(); 
    octx.fillStyle = '#fff'; octx.textBaseline='middle'; octx.textAlign='center'; 
    octx.fillText(b.text, x + w/2, y + h/2); octx.globalAlpha = 1; 
  }
}

// ========= æ¤œå‡º (Detection) =========
let stream=null, rafId=null;
function stopCam(){ cancelAnimationFrame(rafId); rafId=null; if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; } $("#btnStart").disabled=false; $("#btnStop").disabled=true; }
function showError(e){ console.error(e); setError(`âŒ ${e.name||''} ${e.message||e}`); }
async function startCam(){ 
    stopCam(); setError(""); 
    try{ 
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:{ ideal:'environment' }, width:{ideal:1280}, height:{ideal:720} }, audio:false }); 
    }catch(e){ showError(e); return; } 
    v.srcObject=stream; 
    try{ await v.play(); }catch(e){ showError(e); return; } 
    
    // Canvasã®ã‚µã‚¤ã‚ºã‚’ãƒ“ãƒ‡ã‚ªã®ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã«åˆã‚ã›ã‚‹
    const w = v.videoWidth, h = v.videoHeight;
    ov.width = w; ov.height = h;
    scanCanvas.width = SCAN_RESOLUTION;
    scanCanvas.height = SCAN_RESOLUTION * (h/w);

    $("#btnStart").disabled=true; $("#btnStop").disabled=false; 
    tick(); 
}

function scan() {
    if (v.readyState !== v.HAVE_ENOUGH_DATA) return null;
    sctx.drawImage(v, 0, 0, scanCanvas.width, scanCanvas.height);
    const imgData = sctx.getImageData(0, 0, scanCanvas.width, scanCanvas.height);
    const code = jsQR(imgData.data, imgData.width, imgData.height, { inversionAttempts: "dontInvert" });
    if (!code) return null;
    return { raw: code.data.trim(), corners: [code.location.topLeftCorner, code.location.topRightCorner, code.location.bottomRightCorner, code.location.bottomLeftCorner] };
}

function processScanResult(hit) {
    if (!hit) { candidates = []; return; }
    
    // 1ãƒ•ãƒ¬ãƒ¼ãƒ ã«1ã¤ã®QRã‚³ãƒ¼ãƒ‰ã‚’å‡¦ç†ã™ã‚‹ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢ã«å¤‰æ›´
    const kind = classify(hit.raw);
    const parsed = parse(hit.raw); // â˜…ä¿®æ­£: parseã¯ {bn, wc, wn} ã¾ãŸã¯ {loc} ã‚’è¿”ã™
    let candidate = null;

    if (kind === 'loc' && parsed.loc) {
        const registered = !!(fixedLoc && fixedLoc.loc === parsed.loc);
        candidate = { kind, raw: hit.raw, parsed, corners: hit.corners, registered };
    } else if (kind === 'die' && parsed.bn && parsed.wc) {
        const key = dieKey(parsed.bn, parsed.wc);
        const registered = fixedDies.has(key);
        candidate = { kind, raw: hit.raw, parsed, corners: hit.corners, registered };
    }
    
    candidates = candidate ? [candidate] : [];

    // è‡ªå‹•ãƒ­ãƒƒã‚¯å‡¦ç†
    if (candidate && !candidate.registered) {
        if (candidate.kind === 'loc' && !fixedLoc) {
            fixedLoc = { loc: candidate.parsed.loc, raw: candidate.raw };
            updateUIState();
            addFlash('loc', candidate.corners);
            addBubble('loc', candidate.corners, 'æ£šã‚’å›ºå®š');
            playBeep(660, 130); buzz(40);
            toast("æ£šã‚’å›ºå®š", candidate.parsed.loc);
        } else if (candidate.kind === 'die' && fixedLoc) {
            const key = dieKey(candidate.parsed.bn, candidate.parsed.wc);
            if (!fixedDies.has(key)) {
                // â˜…ä¿®æ­£: parsed ã«ã¯ wn ã‚‚å«ã¾ã‚Œã¦ã„ã‚‹
                fixedDies.set(key, { ...candidate.parsed, raw: candidate.raw, addedAt: Date.now() });
                renderDies();
                addFlash('die', candidate.corners);
                addBubble('die', candidate.corners, 'å‹ã‚’è¿½åŠ ');
                playBeep(880, 120); buzz(30);
                toast("å‹ã‚’è¿½åŠ ", `${candidate.parsed.bn}-${candidate.parsed.wc}`);
            }
        }
    }
}

async function tick() { 
    if (!stream) return; 
    
    const hit = scan();
    processScanResult(hit);
    drawOverlays(); 
    
    rafId = requestAnimationFrame(tick); 
}

// ========= é€ä¿¡ (Submission) =========
// â˜… ä¿®æ­£: wn ã‚’å«ã‚ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ã‚’å¼·åŒ–
// ========= é€ä¿¡ (Submission) =========
// ========= é€ä¿¡ (Submission) =========
async function submitUpdate() {
    if (!fixedLoc || fixedDies.size === 0) return;

    const now = new Date();
    const captured_date = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

    const items = [...fixedDies.values()].map(d => ({
      book: d.bn,
      wc: d.wc,
      wn: d.wn || "",
      loc: fixedLoc.loc,
      captured_at: captured_date
    }));

    const msg = items.map(p => `â€¢ ${p.book}-${p.wc} ${p.wn ? '('+p.wn+')' : ''} â†’ ${p.loc}`).join("\n");
    const airtableStatus = AIRTABLE_ENABLED ? "æœ‰åŠ¹" : "åœæ­¢ä¸­";

    if (!confirm(`ä»¥ä¸‹ã®å†…å®¹ã‚’ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\n\n${msg}\n\nğŸ“Š Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ: ç™»éŒ²\nğŸ—„ï¸ Airtable: ${airtableStatus}\n\n(æˆåŠŸã™ã‚‹ã¨ç”»é¢ã¯ã‚¯ãƒªã‚¢ã•ã‚Œã€ã‚«ãƒ¡ãƒ©ã¯åœæ­¢ã—ã¾ã™)`)) return;

    const btnLabel = $("#btnUpdateLabel");
    btnUpdate.disabled = true;
    btnUpdate.classList.add('loading');
    btnLabel.textContent = "ç™»éŒ²ä¸­...";

    let gsSuccess = false;
    try {
      // 1) Google Sheets ç™»éŒ²
      const gsResp = await postWithRetry(SHEET_ENDPOINT, { items }, { maxRetries: 3, baseDelay: 800 });
      if (!gsResp.ok || !(gsResp.json && gsResp.json.ok === true)) {
        throw new Error(`Sheetsç™»éŒ²å¤±æ•—: ${gsResp.error ? gsResp.error.message : gsResp.text || 'no response'}`);
      }
      const j = gsResp.json;
      const appended = Number(j.appendedRows || 0);
      const updatedRows = Number(j.updatedRows || 0);
      const updatedCells = Number(j.updatedCells || 0);
      if (appended === 0 && updatedRows === 0 && updatedCells === 0) {
        throw new Error(`Sheets: å¤‰æ›´ãŒ0ä»¶ã§ã™ã€‚å¿œç­”=${gsResp.text || ''}`);
      }
      gsSuccess = true;
      toast(`Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ ç™»éŒ²å®Œäº†ï¼ˆè¿½åŠ ${appended} / æ›´æ–°${updatedRows||updatedCells||0}ï¼‰`);
    } catch (e) {
      alert(`ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆSheetsï¼‰:\n${e.message||e}`);
      btnUpdate.disabled = false;
      btnUpdate.classList.remove('loading');
      btnLabel.textContent = "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç™»éŒ²";
      return;
    }

    // 2) Airtable ç™»éŒ²ï¼ˆæœ‰åŠ¹æ™‚ã®ã¿ï¼‰
    if (gsSuccess && AIRTABLE_ENABLED) {
      const batches = chunkArray(items, AIRTABLE_BATCH_SIZE);
      let airtableSuccess = true;
      let airtableErrors = [];

      for (let i = 0; i < batches.length; i++) {
        btnLabel.textContent = `Airtableé€ä¿¡ä¸­... (${i+1}/${batches.length})`;
        const payload = { items: batches[i] };

        try {
          const atResp = await postWithRetry(AIRTABLE_ENDPOINT, payload, {
            maxRetries: AIRTABLE_MAX_RETRIES,
            baseDelay: 900,
            factor: 2.0
          });

          // ã‚ˆã‚ŠæŸ”è»Ÿãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯
          if (!atResp.ok) {
            throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${atResp.error?.message || atResp.text}`);
          }

          // Airtableã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          console.log(`Airtable Batch ${i+1} Response:`, atResp.json);
          
          // æˆåŠŸæ¡ä»¶ã‚’ç·©å’Œ
          const isSuccess = atResp.json && (
            atResp.json.ok === true || 
            atResp.json.success === true ||
            atResp.json.records !== undefined || // Airtableã¯recordsã‚’è¿”ã™ã“ã¨ãŒå¤šã„
            Array.isArray(atResp.json) // é…åˆ—ã§è¿”ã£ã¦ãã‚‹å ´åˆã‚‚ã‚ã‚‹
          );

          if (!isSuccess) {
            throw new Error(`Airtable APIã‚¨ãƒ©ãƒ¼: ${JSON.stringify(atResp.json)}`);
          }

          toast(`Airtable ç™»éŒ²å®Œäº† (ãƒãƒƒãƒ${i+1}/${batches.length})`);

        } catch (e) {
          console.error(`Airtable batch ${i+1} failed:`, e);
          airtableSuccess = false;
          airtableErrors.push(`ãƒãƒƒãƒ${i+1}: ${e.message}`);
          toast(`Airtable å¤±æ•— (ãƒãƒƒãƒ${i+1})`, "ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ");
        }

        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ç·©å’Œ
        if (i < batches.length - 1) await sleep(AIRTABLE_BATCH_PAUSE_MS);
      }

      if (!airtableSuccess) {
        // Airtableã®éƒ¨åˆ†å¤±æ•—ã¯è­¦å‘Šè¡¨ç¤ºã®ã¿ï¼ˆSheetsã¯æˆåŠŸæ¸ˆã¿ï¼‰
        console.warn("Airtable partial failures:", airtableErrors);
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ç°¡æ½”ã«é€šçŸ¥
        toast("Airtable: ä¸€éƒ¨ç™»éŒ²ã«å¤±æ•—", "è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèª");
      }

    } else if (gsSuccess && !AIRTABLE_ENABLED) {
      toast("Airtableã¯åœæ­¢ä¸­ï¼ˆé€ä¿¡ã›ãšï¼‰");
    }

    // æˆåŠŸæ™‚ã®å¾Œå‡¦ç†ï¼ˆSheetsç™»éŒ²ãŒæˆåŠŸã—ãŸå ´åˆï¼‰
    if (gsSuccess) {
      playBeep(520, 140);
      fixedLoc = null;
      fixedDies.clear();
      renderDies();
      updateUIState();
      stopCam();
    }

    btnUpdate.disabled = false;
    btnUpdate.classList.remove('loading');
    btnLabel.textContent = "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç™»éŒ²";
    updateUIState();
  }
</script>
</body>
</html>