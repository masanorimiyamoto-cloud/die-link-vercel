<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>scan-specï½œSmart View</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<style>
  :root {
    --primary: #228be6; /* é’ */
    --primary-bg: #e7f5ff;
    --text: #343a40;
    --text-sub: #868e96;
    --bg: #f1f3f5;
    --card-bg: #ffffff;
    --border: #dee2e6;
    --ok: #12b886; /* ç·‘ */
    --ng: #fa5252; /* èµ¤ */
    --info:#f59f00; /* ã‚ªãƒ¬ãƒ³ã‚¸ */
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding-bottom: 40px;
  }

  .wrap {
    max-width: 1000px;
    margin: 0 auto;
    padding: 16px;
  }

  /* --- Header / Controls --- */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--card-bg);
    padding: 12px 16px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    margin-bottom: 16px;
    position: sticky;
    top: 8px;
    z-index: 100;
  }
  .top-controls { display: flex; gap: 10px; }

  .status-indicator {
    font-size: 12px;
    font-weight: bold;
    padding: 4px 10px;
    border-radius: 20px;
    background: #eee;
    color: #777;
  }
  .status-indicator.active { background: var(--primary-bg); color: var(--primary); }

  /* --- Grid Layout --- */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    align-items: start;
  }
  @media (max-width: 768px) {
    .main-grid { grid-template-columns: 1fr; }
  }

  /* --- Cards --- */
  .card {
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    overflow: hidden;
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
  }
  .card-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: #f8f9fa;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .card-header h2 {
    margin: 0;
    font-size: 15px;
    font-weight: 700;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .card-body {
    padding: 16px;
  }

  /* --- Camera Area --- */
  .stack {
    position: relative;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    aspect-ratio: 16/9;
  }
  video { width: 100%; height: 100%; object-fit: cover; display: block; }
  canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }
  #freeze, #lockEmoji { display: none; }

  .lockmark { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
  .lockmark .em { font-size: 60px; text-shadow: 0 4px 12px rgba(0,0,0,0.5); }

  .target-scope{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    width:200px; height:200px;
    border:2px solid rgba(34,139,230,.85);
    border-radius:12px;
    pointer-events:none;
    z-index:10;
    box-shadow:0 0 0 9999px rgba(0,0,0,.28);
  }
  .target-scope .scan-line{
    position:absolute; left:0; top:0; width:100%; height:2px;
    background:linear-gradient(90deg,transparent,rgba(34,139,230,.8),transparent);
    animation:scan 2s linear infinite;
  }
  @keyframes scan{0%{top:0}100%{top:100%}}

  .target-info {
    margin-top: 10px;
    padding: 8px 12px;
    background: var(--primary-bg);
    color: var(--primary);
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
    font-size: 14px;
  }

  /* --- Manual Input --- */
  .manual-area {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px dashed var(--border);
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .inp-group { display: flex; flex-direction: column; gap: 4px; flex: 1; }
  .inp-group label { font-size: 11px; color: var(--text-sub); font-weight: bold; }
  .inp-control {
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    width: 100%;
    background: #fff;
  }
  .inp-control:focus { outline: 2px solid var(--primary-bg); border-color: var(--primary); }

  /* --- Specs (Google Sheets) --- */
  .spec-table {
    display: grid;
    grid-template-columns: 100px 1fr;
    font-size: 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .spec-row { display: contents; }
  .spec-label {
    background: #f8f9fa;
    padding: 8px 12px;
    color: var(--text-sub);
    font-weight: 600;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center;
  }
  .spec-val {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    font-weight: 500;
    word-break: break-all;
  }
  .spec-row:last-child .spec-label,
  .spec-row:last-child .spec-val { border-bottom: none; }

  /* --- Files (Google Drive) --- */
  .drive-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
  }
  .drive-btn {
    text-decoration: none;
    background: #fff;
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
    flex: 1;
    justify-content: center;
    white-space: nowrap;
  }
  .drive-btn:hover { background: #f8f9fa; border-color: #adb5bd; }
  .drive-btn.primary-btn { background: var(--primary); color: #fff; border-color: var(--primary); }
  .drive-btn.primary-btn:hover { opacity: 0.9; }

  .fig-container { display: flex; flex-direction: column; gap: 16px; }
  .msg-empty { text-align: center; padding: 20px; color: var(--text-sub); font-size: 13px; }

  /* â˜… æ–°è¦è¿½åŠ : ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨iframeã®ãƒ©ãƒƒãƒ‘ãƒ¼ */
  .preview-wrapper {
    width: 100%;
    aspect-ratio: 4 / 3; /* è¦‹ã‚„ã™ã„æ¯”ç‡ */
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--border);
    background: #f8f9fa;
  }
  .preview-wrapper iframe {
    width: 100%;
    height: 100%;
    border: none;
  }

  /* â˜… æ–°è¦è¿½åŠ : è©³ç´°æƒ…å ±ï¼ˆã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .spec-details {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
    transition: all 0.2s;
  }
  .spec-details[open] {
    background: #f8f9fa;
  }
  .spec-details summary {
    font-size: 14px;
    font-weight: 700;
    color: var(--primary);
    cursor: pointer;
    outline: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®çŸ¢å°ã‚’ã‚«ã‚¹ã‚¿ãƒ  */
  .spec-details summary::after {
    content: "â–¼";
    font-size: 10px;
    color: var(--primary);
    transition: transform 0.2s;
  }
  .spec-details[open] summary::after {
    transform: rotate(180deg);
  }
  .spec-details summary::-webkit-details-marker {
    display: none; /* Safariç”¨ */
  }

  /* --- Buttons --- */
  .btn {
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn-primary { background: var(--primary); color: #fff; }
  .btn-primary:hover { background: #1c7ed6; }
  .btn-sub { background: #fff; border: 1px solid var(--border); color: var(--text); }
  .btn-sub:disabled { background: #f1f3f5; color: #adb5bd; cursor: not-allowed; }
</style>
</head>
<body>

<div class="wrap">
  <div class="topbar">
    <div class="top-controls">
      <button id="btnStart" class="btn btn-primary">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
      <button id="btnStop" class="btn btn-sub" disabled>åœæ­¢</button>
    </div>
    <div id="scanStatus" class="status-indicator">å¾…æ©Ÿä¸­</div>
  </div>

  <div class="main-grid">
    <div class="card">
      <div class="card-header">
        <h2>ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³</h2>
        <span id="detectorInfo" style="font-size:11px; color:#aaa">jsQR</span>
      </div>
      <div class="card-body">
        <div class="stack" id="stack">
          <video id="video" playsinline webkit-playsinline muted></video>
          <canvas id="freeze"></canvas>
          <canvas id="overlay"></canvas>
          <div class="lockmark"><div class="em" id="lockEmoji">ğŸ”’</div></div>
          <canvas id="scanCanvas" style="display:none"></canvas>
          <div class="target-scope"><div class="scan-line"></div></div>
        </div>

        <div id="nowTarget" class="target-info">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: â€” / â€”</div>
        <div id="errCam" style="color:var(--ng); font-size:12px; margin-top:4px;"></div>

        <div class="manual-area">
          <div class="inp-group" style="flex:0 0 80px;">
            <label>Book</label>
            <select id="inpBook" class="inp-control">
              <option value="">-</option>
              <option value="Ko">Ko</option>
              <option value="Yo">Yo</option>
              <option value="Ta">Ta</option>
            </select>
          </div>
          <div class="inp-group">
            <label>WC (ä¾‹: 1234)</label>
            <input id="inpWc" type="text" inputmode="numeric" class="inp-control" placeholder="WorkCord" />
          </div>
          <button id="btnManual" class="btn btn-sub" style="align-self:flex-end; height:38px;">ç…§ä¼š</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>ğŸ“„ çµæœ</h2>
        <span id="loading" style="font-size:12px; color:var(--primary); display:none;">ç…§ä¼šä¸­...</span>
      </div>

      <div class="card-body" style="display: flex; flex-direction: column; gap: 16px;">
        
        <div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h3 style="font-size:14px; margin:0; color:var(--text-sub);">å›³é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
            <div id="driveStatus" style="font-size:11px; color:#aaa;">æœªç…§ä¼š</div>
          </div>
          
          <div id="driveView" class="fig-container">
            <div class="msg-empty">ã‚¹ã‚­ãƒ£ãƒ³ã™ã‚‹ã¨ã“ã“ã«å›³é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
          </div>
          <div id="driveActions" class="drive-actions" style="margin-top: 12px;"></div>
        </div>

        <details class="spec-details">
          <summary>è©³ç´°æƒ…å ±ã‚’ç¢ºèªã™ã‚‹ (ã‚¹ãƒšãƒƒã‚¯)</summary>
          <div style="margin-top:16px;">
            <div id="gsBox"><div class="msg-empty">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã›ã‚“</div></div>
            <div id="errApi" style="color:var(--ng); font-size:12px; margin-top:6px;"></div>
          </div>
        </details>

      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" crossorigin="anonymous"></script>
<script>
(() => {
  const D = {
    video: q('#video'), overlay: q('#overlay'), freeze: q('#freeze'), stack: q('#stack'),
    btnStart: q('#btnStart'), btnStop: q('#btnStop'),
    detectorInfo: q('#detectorInfo'), scanStatus: q('#scanStatus'),
    errCam: q('#errCam'), errApi: q('#errApi'), loading: q('#loading'),
    lockEmoji: q('#lockEmoji'), scanCanvas: q('#scanCanvas'),
    inpBook: q('#inpBook'), inpWc: q('#inpWc'), btnManual: q('#btnManual'),
    gsBox: q('#gsBox'),
    driveStatus: q('#driveStatus'), driveView: q('#driveView'), driveActions: q('#driveActions'),
    nowTarget: q('#nowTarget'),
  };
  function q(s){ return document.querySelector(s); }

  const ctx = D.overlay.getContext('2d', { willReadFrequently:true });
  const freezeCtx = D.freeze.getContext('2d', { willReadFrequently:true });
  const scanCtx = D.scanCanvas.getContext('2d',{ willReadFrequently:true });

  const CFG = {
    SCAN_EVERY_MS: 80,
    JSQR_MULTI_MAX: 6,
    ROI_SCALE: 1.75,
    ROI_FRACTION: 0.62
  };

  const S = {
    stream: null, rafId: null,
    useBarcodeDetector: ('BarcodeDetector' in window), detector: null,
    csrf: '', locked: false,
    current: { book:'', wc:'' }, lastQueryKey:'',
    lastScanAt: 0,
  };

  // --- CSRF & Cookie ---
  function readCookie(name){
    const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')+'=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : '';
  }
  async function ensureCsrf(){
    let t = readCookie('xcsrf');
    if(!t){
      const url = (location.protocol==='http:' && /localhost|127\.0\.0\.1/.test(location.host)) ? '/api/session?dev=1' : '/api/session';
      await fetch(url,{method:'GET',credentials:'same-origin',cache:'no-store'}).catch(()=>{});
      t = readCookie('xcsrf');
    }
    if(t) S.csrf = t;
  }
  document.addEventListener('DOMContentLoaded', ensureCsrf);

  // --- Helpers ---
  async function waitVideoSize(timeoutMs = 2500){
    const t0 = performance.now();
    while(performance.now() - t0 < timeoutMs){
      if(D.video.videoWidth > 0 && D.video.videoHeight > 0) return true;
      await new Promise(r => requestAnimationFrame(r));
    }
    return false;
  }
  function esc(s){ return String(s??'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function dieKey(bn,wc){ return (bn||'').toLowerCase()+'@@'+(wc||'').toLowerCase(); }
  function normHyphen(s){
    return (s||'')
      .replace(/[â€-â€’â€“â€”â€•ãƒ¼âˆ’]/g,'-')
      .replace(/[ï¼š]/g, ':')
      .replace(/\s*-\s*/g,'-')
      .replace(/\s*:\s*/g,':')
      .replace(/\s+/g,' ')
      .trim();
  }

  function setStatus(text, active=false){
    D.scanStatus.textContent = text;
    if(active) D.scanStatus.classList.add('active');
    else D.scanStatus.classList.remove('active');
  }

  function fitAll(){
    if(!D.video.videoWidth) return;
    const vw = D.video.videoWidth, vh = D.video.videoHeight;
    D.overlay.width = vw; D.overlay.height = vh;
    D.freeze.width  = vw; D.freeze.height  = vh;
    D.scanCanvas.width = vw; D.scanCanvas.height = vh;
  }

  function drawPoly(pts, stroke='#228be6', w=4, dash=null, alpha=1){
    if(!pts || pts.length<4) return;
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.strokeStyle = stroke;
    ctx.lineWidth = w;
    if(dash) ctx.setLineDash(dash);
    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
    ctx.closePath(); ctx.stroke();
    ctx.restore();
  }

  function inScope(cornerPoints){
    if(!cornerPoints || cornerPoints.length<4) return true;
    const stackW = D.stack.clientWidth, stackH = D.stack.clientHeight;
    if(!stackW || !stackH) return true;

    const scopeCssSize = 200;
    const scopeCssX = (stackW/2) - (scopeCssSize/2);
    const scopeCssY = (stackH/2) - (scopeCssSize/2);

    const scaleX = D.overlay.width / stackW;
    const scaleY = D.overlay.height / stackH;

    const scopeX = scopeCssX * scaleX;
    const scopeY = scopeCssY * scaleY;
    const scopeW = scopeCssSize * scaleX;
    const scopeH = scopeCssSize * scaleY;

    const marginX = 14 * scaleX;
    const marginY = 14 * scaleY;

    for(const pt of cornerPoints){
      if(pt.x < scopeX - marginX) return false;
      if(pt.x > scopeX + scopeW + marginX) return false;
      if(pt.y < scopeY - marginY) return false;
      if(pt.y > scopeY + scopeH + marginY) return false;
    }
    return true;
  }

  function stopCam({keepFrame=false}={}){
    if(S.rafId) cancelAnimationFrame(S.rafId);
    S.rafId=null;

    try{ D.video.pause(); }catch(e){}
    try{ D.video.srcObject = null; }catch(e){}

    if(!keepFrame){
      ctx.clearRect(0,0,D.overlay.width,D.overlay.height);
      D.freeze.style.display='none';
      D.lockEmoji.style.display='none';
      D.video.style.visibility='visible';
    }
    if(S.stream){
      try{ S.stream.getTracks().forEach(t=>t.stop()); }catch(e){}
      S.stream=null;
    }
    D.btnStart.disabled=false;
    D.btnStop.disabled=true;
    setStatus('åœæ­¢ä¸­');
  }

  async function setupDetector(){
    S.useBarcodeDetector = ('BarcodeDetector' in window);
    S.detector = null;
    if(!S.useBarcodeDetector) return;
    try{
      const fmts = (typeof BarcodeDetector.getSupportedFormats==='function')
        ? await BarcodeDetector.getSupportedFormats()
        : [];
      if(fmts && fmts.includes('qr_code')){
        S.detector = new BarcodeDetector({formats:['qr_code']});
      }else{
        S.detector = new BarcodeDetector({formats:['qr_code']});
      }
    }catch{
      S.useBarcodeDetector = false;
      S.detector = null;
    }
  }

  async function startCam(){
    S.locked=false;
    S.lastQueryKey = ''; 
    stopCam(); 
    
    D.errCam.textContent='';
    D.freeze.style.display='none';
    D.video.style.visibility='visible';
    D.lockEmoji.style.display='none';

    const constraints = {
      video: { facingMode: { ideal: 'environment' } },
      audio: false
    };

    try{
      S.stream = await navigator.mediaDevices.getUserMedia(constraints);
      D.video.srcObject = S.stream;

      await D.video.play();

      const ok = await waitVideoSize();
      if(!ok) throw new Error('ã‚«ãƒ¡ãƒ©è§£åƒåº¦ãŒç¢ºå®šã—ã¾ã›ã‚“ã§ã—ãŸ');

      fitAll();
      await setupDetector();
      D.detectorInfo.textContent = (S.useBarcodeDetector && S.detector) ? 'BD+jsQR' : 'jsQR';

      D.btnStart.disabled=true;
      D.btnStop.disabled=false;

      S.lastScanAt = 0;
      setStatus('ã‚¹ã‚­ãƒ£ãƒ³ä¸­', true);
      tick();
    }catch(e){
      console.error(e);
      // â˜… ã“ã“ã‚’è¿½åŠ : AbortErrorï¼ˆä¸­æ–­ã‚¨ãƒ©ãƒ¼ï¼‰ã®å ´åˆã¯ç”»é¢ã«ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã•ãªã„
      if (e.name === 'AbortError' || (e.message && e.message.includes('aborted'))) {
        console.warn('ã‚«ãƒ¡ãƒ©èµ·å‹•ãŒä¸€åº¦ä¸­æ–­ã•ã‚Œã¾ã—ãŸãŒã€å‹•ä½œã«å½±éŸ¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚');
        D.btnStart.disabled = false; // ãƒœã‚¿ãƒ³ã ã‘æŠ¼ã›ã‚‹çŠ¶æ…‹ã«æˆ»ã—ã¦ãŠã
        return; 
      }
      D.errCam.textContent = `ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: ${e.name||''} ${e.message||e}`;
      setStatus('ã‚¨ãƒ©ãƒ¼');
      stopCam();
    }
  }

  function freezeAndLock(){
    fitAll();
    freezeCtx.drawImage(D.video,0,0,D.freeze.width,D.freeze.height);
    D.freeze.style.display='block';
    D.video.style.visibility='hidden';
    D.lockEmoji.style.display='block';
    ctx.clearRect(0,0,D.overlay.width,D.overlay.height);
    stopCam({keepFrame:true});
    setStatus('ãƒ­ãƒƒã‚¯å®Œäº†');
  }

  function extractBookWc(raw){
    const t = normHyphen((raw||'').trim());
    let bn='', wc='';

    const m0 = /^([A-Za-z]{1,3})[:\-](\d+)$/i.exec(t);
    if(m0){ bn=m0[1]; wc=m0[2]; return {bn, wc}; }

    const m1 = /^(die|order)\s*[:\-]?\s*([A-Za-z]{1,3})[:\-](\d+)$/i.exec(t);
    if(m1){ bn=m1[2]; wc=m1[3]; return {bn, wc}; }

    const m2 = /^(die|order)-([^-\n\/?#]+)-([^-\n\/?#]+)/i.exec(t);
    if(m2){ bn=m2[2]; wc=m2[3]; return {bn, wc}; }

    try{
      const u = new URL(t);
      bn = (u.searchParams.get('book') || u.searchParams.get('Book') || '').trim();
      wc = (u.searchParams.get('wc')   || u.searchParams.get('WorkCord') || u.searchParams.get('workcord') || '').trim();
      if(bn && wc) return {bn, wc};

      const path = u.pathname || '';
      const mPath = /(?:^|\/)(die|order)-([^-\n\/?#]+)-([^-\n\/?#]+)/i.exec(path);
      if(mPath){
        bn = mPath[2]; wc = mPath[3];
        if(bn && wc) return {bn, wc};
      }
    }catch{}

  return null;
}

  async function detectCombined(){
    if(!D.video.videoWidth) return [];
    const vw = D.video.videoWidth, vh = D.video.videoHeight;
    const w = D.scanCanvas.width, h = D.scanCanvas.height;

    const dets = new Map();

    if(S.useBarcodeDetector && S.detector){
      try{
        const codes = await S.detector.detect(D.video);
        for(const c of codes){
          const raw = (c.rawValue||'').trim();
          if(raw && !dets.has(raw)) dets.set(raw, { raw, pts: c.cornerPoints });
        }
      }catch{
        try{
          scanCtx.drawImage(D.video, 0, 0, w, h);
          const codes = await S.detector.detect(D.scanCanvas);
          for(const c of codes){
            const raw = (c.rawValue||'').trim();
            if(raw && !dets.has(raw)) dets.set(raw, { raw, pts: c.cornerPoints });
          }
        }catch{
          S.useBarcodeDetector=false; S.detector=null;
        }
      }
    }

    const jsqrMulti = (imgData) => {
      const hits = [];
      const W = imgData.width, H = imgData.height;
      const masked = new Uint8ClampedArray(imgData.data);
      for(let k=0; k<CFG.JSQR_MULTI_MAX; k++){
        const hit = jsQR(masked, W, H, { inversionAttempts:'attemptBoth' });
        if(!hit) break;
        hits.push({
          raw: (hit.data||'').trim(),
          pts: [hit.location.topLeftCorner, hit.location.topRightCorner, hit.location.bottomRightCorner, hit.location.bottomLeftCorner]
        });
        const tl = hit.location.topLeftCorner, br = hit.location.bottomRightCorner;
        for(let y=Math.floor(tl.y); y<Math.ceil(br.y); y++){
          for(let x=Math.floor(tl.x); x<Math.ceil(br.x); x++){
            const i = (y*W + x) * 4;
            masked[i]=masked[i+1]=masked[i+2]=255;
          }
        }
      }
      return hits;
    };

    scanCtx.drawImage(D.video, 0, 0, w, h);
    let img = scanCtx.getImageData(0,0,w,h);
    for(const h1 of jsqrMulti(img)){
      if(h1.raw && !dets.has(h1.raw)) dets.set(h1.raw, h1);
    }

    if(dets.size === 0){
      const frac = CFG.ROI_FRACTION;
      const sw = Math.floor(vw * frac);
      const sh = Math.floor(vh * frac);
      const sx = Math.floor((vw - sw) / 2);
      const sy = Math.floor((vh - sh) / 2);

      scanCtx.drawImage(D.video, sx, sy, sw, sh, 0, 0, w, h);
      img = scanCtx.getImageData(0,0,w,h);
      for(const h2 of jsqrMulti(img)){
        if(h2.raw && !dets.has(h2.raw)) dets.set(h2.raw, h2);
      }
    }

    return Array.from(dets.values());
  }

  async function tick(){
    if(!S.stream) return;

    const now = performance.now();
    if(now - S.lastScanAt < CFG.SCAN_EVERY_MS){
      S.rafId = requestAnimationFrame(tick);
      return;
    }
    S.lastScanAt = now;

    if(D.video.readyState === D.video.HAVE_ENOUGH_DATA){
      fitAll();
      ctx.clearRect(0,0,D.overlay.width,D.overlay.height);

      const dets = await detectCombined();

      if(!dets.length){
        setStatus('ã‚¹ã‚­ãƒ£ãƒ³ä¸­', true);
        S.rafId = requestAnimationFrame(tick);
        return;
      }

      let anyInScope = false;
      for(const d of dets){
        const raw = (d.raw||'').trim(); if(!raw) continue;
        const pts = d.pts || [];
        if(!pts.length) continue;

        const okScope = inScope(pts);
        anyInScope = anyInScope || okScope;
        drawPoly(pts, okScope ? '#228be6' : '#fa5252', okScope ? 4 : 3, okScope ? null : [8,6], okScope ? 0.85 : 0.35);

        if(okScope){
          const p = extractBookWc(raw);
          if(p && p.bn && p.wc){
            setTarget(p.bn, p.wc);
            S.locked=true;
            freezeAndLock();
            querySpec();
            return;
          }
        }
      }

      if(anyInScope) setStatus(`QRæ¤œçŸ¥ï¼ˆå½¢å¼/å†…å®¹ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼‰`, true);
      else setStatus(`QRæ¤œçŸ¥ï¼ˆã‚¬ã‚¤ãƒ‰å¤–ï¼‰`, true);
    }

    S.rafId = requestAnimationFrame(tick);
  }

  function setTarget(bn, wc){
    S.current.book = (bn||'').trim();
    S.current.wc   = (wc||'').trim();
    D.nowTarget.textContent = `ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${S.current.book} / ${S.current.wc}`;
    D.inpBook.value = S.current.book;
    D.inpWc.value = S.current.wc;
  }

  async function querySpec(){
    const {book, wc} = S.current;
    if(!book || !wc) return;
    const key = dieKey(book, wc);
    if(key === S.lastQueryKey) return; 
    S.lastQueryKey = key;

    D.errApi.textContent='';
    D.loading.style.display='inline';
    
    // UIå³åº§ã‚¯ãƒªã‚¢
    D.gsBox.innerHTML = '<div class="msg-empty">èª­ã¿è¾¼ã¿ä¸­...</div>';
    D.driveActions.innerHTML = '';
    D.driveView.innerHTML = '<div class="msg-empty">å›³é¢ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢ä¸­...</div>'; 
    D.driveStatus.textContent = 'æ¤œç´¢ä¸­...';

    // æ¤œç´¢ã”ã¨ã«ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³ã‚’é–‰ã˜ã¦ã‚¹ãƒƒã‚­ãƒªã•ã›ã‚‹è¨­å®šï¼ˆãŠå¥½ã¿ã§å¤–ã—ã¦ãã ã•ã„ï¼‰
    document.querySelector('.spec-details').removeAttribute('open');

    try{
      await ensureCsrf();

      // ä¸¦åˆ—å®Ÿè¡Œ
      const pSheet = fetchSpecs(book, wc);   
      const pDrive = findDriveFiles(book, wc); 

      await pSheet; 
    }catch(e){
      D.errApi.textContent = e.message || e;
    }finally{
      D.loading.style.display='none';
    }
  }

  async function fetchSpecs(book, wc){
    try {
      const r = await fetch('/api/die-check', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', ...(S.csrf?{'X-CSRF':S.csrf}:{}) },
        credentials:'same-origin',
        body: JSON.stringify({ book, wc, json:true, limit:0, noAirtable:true, gsOnly:true })
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error||'API Error');
      renderSpecs(j.gs);
    } catch(e) {
      D.gsBox.innerHTML = `<div class="msg-empty" style="color:var(--ng)">${esc(e.message)}</div>`;
    }
  }

  function renderSpecs(gs){
    if(!gs){
      D.gsBox.innerHTML = '<div class="msg-empty">è©²å½“ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
      return;
    }
    const fields = [
      {k:'ItemName', l:'å“å'}, {k:'Kname', l:'å‹å'},
      {k:'Material', l:'æè³ª'}, {k:'Paper_Size', l:'åŸç´™'},
      {k:'Cut_Size', l:'æ–­è£'}, {k:'Location', l:'æ£šç•ª'},
      {k:'LastSeen', l:'ç¢ºèªæ—¥'},
      {k:'LastDelivery', l:'å‰å›ç´å“æ—¥'}
    ];
    let html = '<div class="spec-table">';
    fields.forEach(f => {
      const val = gs[f.k] || '-';
      html += `<div class="spec-row"><div class="spec-label">${esc(f.l)}</div><div class="spec-val">${esc(val)}</div></div>`;
    });
    html += '</div>';
    D.gsBox.innerHTML = html;
  }

  // â˜…å¤‰æ›´ç®‡æ‰€: ã‚µãƒ ãƒã‚¤ãƒ«æ©Ÿèƒ½ã‚’iframeãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«æ›¸ãæ›ãˆ
  async function findDriveFiles(book, wc) {
    try {
      const r = await fetch(
        `/api/drive-find?book=${encodeURIComponent(book)}&wc=${encodeURIComponent(wc)}&t=${Date.now()}`,
        {
          credentials: 'same-origin',
          cache: 'no-store',
          headers: {
            'Cache-Control': 'no-cache, no-store, must-revalidate',
            'Pragma': 'no-cache'
          }
        }
      );
      const j = await r.json();

      D.driveActions.innerHTML = '';
      D.driveView.innerHTML = '';

      if (!j.ok) {
        D.driveStatus.textContent = 'æ¤œç´¢ã‚¨ãƒ©ãƒ¼';
        D.driveView.innerHTML = '<div class="msg-empty">å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        return;
      }

      const cands = j.candidates || (j.fileId ? [{ id: j.fileId, name: j.fileName }] : []);
      if (!cands.length) {
        D.driveStatus.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ãªã—';
        D.driveView.innerHTML = '<div class="msg-empty">é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }

      D.driveStatus.textContent = `${cands.length}ä»¶ãƒ’ãƒƒãƒˆ`;

      // å„ªå…ˆé †ä½ã‚½ãƒ¼ãƒˆï¼ˆå›³é¢â†’ã‚·ãƒ¼ãƒ«â†’ãã®ä»–ï¼‰
      const score = (n) => {
        n = (n || '').toLowerCase();
        if (/-zu\./.test(n)) return 1;
        if (/-si\./.test(n)) return 2;
        if (/\.pdf$/.test(n)) return 3;
        return 9;
      };
      cands.sort((a, b) => score(a.name) - score(b.name));

      // 1) é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªãƒ³ã‚¯ãƒœã‚¿ãƒ³ç”Ÿæˆ
      for (const f of cands) {
        const id = f.id;
        const name = f.name || '';
        const isPdf = /\.pdf$/i.test(name);

        const url = isPdf
          ? `https://drive.google.com/file/d/${id}/view`
          : `https://drive.google.com/uc?export=view&id=${id}`;

        let label = 'ãƒ•ã‚¡ã‚¤ãƒ«';
        let icon = 'ğŸ“„';
        let cls = 'drive-btn';
        if (/-zu\./i.test(name)) { label = 'å›³é¢'; icon = 'ğŸ“'; cls += ' primary-btn'; }
        else if (/-si\./i.test(name)) { label = 'ã‚·ãƒ¼ãƒ«'; icon = 'ğŸ·ï¸'; }
        else if (isPdf) { label = 'PDF'; icon = 'ğŸ“‘'; }
        else if (/\.(jpg|jpeg|png|gif)$/i.test(name)) { label = 'ç”»åƒ'; icon = 'ğŸ–¼ï¸'; }

        const btn = document.createElement('a');
        btn.href = url;
        btn.target = '_blank';
        btn.rel = 'noopener';
        btn.className = cls;
        btn.textContent = `${icon} ${label}`;
        D.driveActions.appendChild(btn);
      }

      // 2) æœ€ã‚‚å„ªå…ˆåº¦ã®é«˜ã„ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæœ€ä¸Šä½ï¼‰ã‚’iframeã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      const topFile = cands[0];
      if (topFile) {
        const previewUrl = `https://drive.google.com/file/d/${topFile.id}/preview`;
        D.driveView.innerHTML = `
          <div class="preview-wrapper">
            <iframe src="${previewUrl}"></iframe>
          </div>
        `;
      } else {
        D.driveView.innerHTML = '<div class="msg-empty">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      }

    } catch (e) {
      console.error('Drive API Error:', e);
      D.driveStatus.textContent = 'æ¤œç´¢å¤±æ•—';
      D.driveView.innerHTML = '<div class="msg-empty">æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    }
  }

  D.btnStart.onclick = async () => {
    if (D.btnStart.disabled) return; 
    D.btnStart.disabled = true;
    await startCam();
  };
  D.btnStop.onclick = () => stopCam();
  window.onresize = fitAll;

  document.addEventListener('visibilitychange', () => {
    if (document.hidden && S.stream) {
      console.log('ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã«ç§»è¡Œã—ãŸãŸã‚ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢ã—ã¾ã™');
      stopCam();
    }
  });

  D.btnManual.onclick = () => {
    const b = D.inpBook.value.trim();
    const w = normHyphen(D.inpWc.value.trim());
    if(!b || !w){ alert('Bookã¨WCã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    setTarget(b, w);
    S.locked=false; S.lastQueryKey='';
    querySpec();
  };

})();
</script>
</body>
</html>