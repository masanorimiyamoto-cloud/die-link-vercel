<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>scan-specï½œSmart View</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<style>
  :root {
    --primary: #228be6; /* é’ */
    --primary-bg: #e7f5ff;
    --text: #343a40;
    --text-sub: #868e96;
    --bg: #f1f3f5;
    --card-bg: #ffffff;
    --border: #dee2e6;
    --ok: #12b886; /* ç·‘ */
    --ng: #fa5252; /* èµ¤ */
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding-bottom: 40px;
  }

  .wrap {
    max-width: 1000px;
    margin: 0 auto;
    padding: 16px;
  }

  /* --- Header / Controls --- */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--card-bg);
    padding: 12px 16px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    margin-bottom: 16px;
    position: sticky;
    top: 8px;
    z-index: 100;
  }
  .top-controls { display: flex; gap: 10px; }
  
  .status-indicator {
    font-size: 12px;
    font-weight: bold;
    padding: 4px 10px;
    border-radius: 20px;
    background: #eee;
    color: #777;
  }
  .status-indicator.active { background: var(--primary-bg); color: var(--primary); }

  /* --- Grid Layout --- */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    align-items: start;
  }
  @media (max-width: 768px) {
    .main-grid { grid-template-columns: 1fr; }
  }

  /* --- Cards --- */
  .card {
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    overflow: hidden;
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
  }
  .card-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: #f8f9fa;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .card-header h2 {
    margin: 0;
    font-size: 15px;
    font-weight: 700;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .card-body {
    padding: 16px;
  }

  /* --- Camera Area --- */
  .stack {
    position: relative;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    aspect-ratio: 16/9;
  }
  video { width: 100%; height: 100%; object-fit: cover; display: block; }
  canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }
  #freeze, #lockEmoji { display: none; }
  
  .lockmark { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
  .lockmark .em { font-size: 60px; text-shadow: 0 4px 12px rgba(0,0,0,0.5); }

  .target-info {
    margin-top: 10px;
    padding: 8px 12px;
    background: var(--primary-bg);
    color: var(--primary);
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
    font-size: 14px;
  }

  /* --- Manual Input --- */
  .manual-area {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px dashed var(--border);
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .inp-group { display: flex; flex-direction: column; gap: 4px; flex: 1; }
  .inp-group label { font-size: 11px; color: var(--text-sub); font-weight: bold; }
  .inp-control {
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    width: 100%;
    background: #fff;
  }
  .inp-control:focus { outline: 2px solid var(--primary-bg); border-color: var(--primary); }

  /* --- Specs (Google Sheets) --- */
  .spec-table {
    display: grid;
    grid-template-columns: 100px 1fr; /* ãƒ©ãƒ™ãƒ«å¹…å›ºå®š */
    font-size: 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .spec-row { display: contents; }
  .spec-label {
    background: #f8f9fa;
    padding: 8px 12px;
    color: var(--text-sub);
    font-weight: 600;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center;
  }
  .spec-val {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    font-weight: 500;
    word-break: break-all;
  }
  .spec-row:last-child .spec-label,
  .spec-row:last-child .spec-val { border-bottom: none; }

  /* --- Files (Google Drive) --- */
  .drive-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
  }
  .drive-btn {
    text-decoration: none;
    background: #fff;
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
    flex: 1;
    justify-content: center;
    white-space: nowrap;
  }
  .drive-btn:hover { background: #f8f9fa; border-color: #adb5bd; }
  .drive-btn.primary-btn { background: var(--primary); color: #fff; border-color: var(--primary); }
  .drive-btn.primary-btn:hover { opacity: 0.9; }

  .fig-container {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }
  .fig-block {
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .fig-header {
    font-size: 12px;
    padding: 6px 10px;
    background: #f1f3f5;
    color: var(--text-sub);
    border-bottom: 1px solid var(--border);
  }
  .fig-content iframe,
  .fig-content img {
    display: block;
    width: 100%;
    border: none;
  }

  /* --- Buttons --- */
  .btn {
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn-primary { background: var(--primary); color: #fff; }
  .btn-primary:hover { background: #1c7ed6; }
  .btn-sub { background: #fff; border: 1px solid var(--border); color: var(--text); }
  .btn-sub:disabled { background: #f1f3f5; color: #adb5bd; cursor: not-allowed; }

  .msg-empty { text-align: center; padding: 20px; color: var(--text-sub); font-size: 13px; }
</style>
</head>
<body>

<div class="wrap">
  <div class="topbar">
    <div class="top-controls">
      <button id="btnStart" class="btn btn-primary">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
      <button id="btnStop" class="btn btn-sub" disabled>åœæ­¢</button>
    </div>
    <div id="scanStatus" class="status-indicator">å¾…æ©Ÿä¸­</div>
  </div>

  <div class="main-grid">
    
    <div class="card">
      <div class="card-header">
        <h2>ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³</h2>
        <span id="detectorInfo" style="font-size:11px; color:#aaa">jsQR</span>
      </div>
      <div class="card-body">
        <div class="stack" id="stack">
          <video id="video" playsinline webkit-playsinline muted></video>
          <canvas id="freeze"></canvas>
          <canvas id="overlay"></canvas>
          <div class="lockmark"><div class="em" id="lockEmoji">ğŸ”’</div></div>
          <canvas id="scanCanvas" style="display:none"></canvas>
        </div>
        
        <div id="nowTarget" class="target-info">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: â€” / â€”</div>
        <div id="errCam" style="color:var(--ng); font-size:12px; margin-top:4px;"></div>

        <div class="manual-area">
          <div class="inp-group" style="flex:0 0 80px;">
            <label>Book</label>
            <select id="inpBook" class="inp-control">
              <option value="">-</option>
              <option value="Ko">Ko</option>
              <option value="Yo">Yo</option>
              <option value="Ta">Ta</option>
            </select>
          </div>
          <div class="inp-group">
            <label>WC (ä¾‹: 1234)</label>
            <input id="inpWc" type="text" inputmode="numeric" class="inp-control" placeholder="WorkCord" />
          </div>
          <button id="btnManual" class="btn btn-sub" style="align-self:flex-end; height:38px;">ç…§ä¼š</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>ğŸ“„ çµæœ</h2>
        <span id="loading" style="font-size:12px; color:var(--primary); display:none;">ç…§ä¼šä¸­...</span>
      </div>
      
      <div class="card-body">
        <h3 style="font-size:14px; margin:0 0 8px; color:var(--text-sub);">åŸºæœ¬ã‚¹ãƒšãƒƒã‚¯ (Google Sheets)</h3>
        <div id="gsBox">
          <div class="msg-empty">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã›ã‚“</div>
        </div>
        <div id="errApi" style="color:var(--ng); font-size:12px; margin-top:6px;"></div>

        <div style="margin-top:24px; border-top:1px solid var(--border); padding-top:16px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h3 style="font-size:14px; margin:0; color:var(--text-sub);">é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ« (Google Drive)</h3>
            <div id="driveStatus" style="font-size:11px; color:#aaa;"></div>
          </div>

          <div id="driveActions" class="drive-actions"></div>
          <div id="driveView" class="fig-container"></div>
        </div>
      </div>
    </div>

  </div></div><script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" crossorigin="anonymous"></script>
<script>
(() => {
  const D = {
    video: q('#video'), overlay: q('#overlay'), freeze: q('#freeze'), stack: q('#stack'),
    btnStart: q('#btnStart'), btnStop: q('#btnStop'),
    detectorInfo: q('#detectorInfo'), scanStatus: q('#scanStatus'),
    errCam: q('#errCam'), errApi: q('#errApi'), loading: q('#loading'),
    lockEmoji: q('#lockEmoji'), scanCanvas: q('#scanCanvas'),
    inpBook: q('#inpBook'), inpWc: q('#inpWc'), btnManual: q('#btnManual'),
    gsBox: q('#gsBox'),
    driveStatus: q('#driveStatus'), driveView: q('#driveView'), driveActions: q('#driveActions'),
    nowTarget: q('#nowTarget'),
  };
  function q(s){ return document.querySelector(s); }

  const ctx = D.overlay.getContext('2d', { willReadFrequently:true });
  const freezeCtx = D.freeze.getContext('2d', { willReadFrequently:true });
  const scanCtx = D.scanCanvas.getContext('2d',{ willReadFrequently:true });

  const CFG = { JSQR_MAX_LOOPS: 5 };
  const S = {
    stream: null, rafId: null,
    useBarcodeDetector: ('BarcodeDetector' in window), detector: null,
    csrf: '', locked: false,
    current: { book:'', wc:'' }, lastQueryKey:'',
  };

  // --- CSRF & Cookie ---
  function readCookie(name){
    const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')+'=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : '';
  }
  async function ensureCsrf(){
    let t = readCookie('xcsrf');
    if(!t){ 
      const url = (location.protocol==='http:' && /localhost|127\.0\.0\.1/.test(location.host)) ? '/api/session?dev=1' : '/api/session';
      await fetch(url,{method:'GET',credentials:'same-origin'}).catch(()=>{}); 
      t = readCookie('xcsrf'); 
    }
    if(t) S.csrf = t;
  }
  document.addEventListener('DOMContentLoaded', ensureCsrf);

  // --- Helpers ---
  async function waitVideoSize(timeoutMs = 2000){
    const t0 = performance.now();
    while(performance.now() - t0 < timeoutMs){
      if(D.video.videoWidth > 0 && D.video.videoHeight > 0) return true;
      await new Promise(r => requestAnimationFrame(r));
    }
    return false;
  }

  function esc(s){ return String(s??'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function dieKey(bn,wc){ return (bn||'').toLowerCase()+'@@'+(wc||'').toLowerCase(); }
  function normHyphen(s){ return (s||'').replace(/[â€-â€’â€“â€”â€•ãƒ¼âˆ’]/g,'-').trim(); }

  function setStatus(text, active=false){
    D.scanStatus.textContent = text;
    if(active) D.scanStatus.classList.add('active');
    else D.scanStatus.classList.remove('active');
  }
  function fitOverlay(){
    if(!D.video.videoWidth) return;
    D.overlay.width = D.video.videoWidth;
    D.overlay.height = D.video.videoHeight;
    D.overlay.style.width = '100%'; 
    D.overlay.style.height = '100%';
    D.freeze.width = D.video.videoWidth;
    D.freeze.height = D.video.videoHeight;
  }
  async function waitVideoSize(timeoutMs = 2000){
    const t0 = performance.now();
    while(performance.now() - t0 < timeoutMs){
      if(D.video.videoWidth > 0 && D.video.videoHeight > 0) return true;
      await new Promise(r => requestAnimationFrame(r));
    }
    return false;
  }

  // --- Camera Control ---
  function stopCam({keepFrame=false}={}){
    if(S.rafId) cancelAnimationFrame(S.rafId);
    S.rafId=null;
    if(!keepFrame){
      ctx.clearRect(0,0,D.overlay.width,D.overlay.height);
      D.freeze.style.display='none';
      D.lockEmoji.style.display='none';
      D.video.style.visibility='visible';
    }
    if(S.stream){ 
        try{ S.stream.getTracks().forEach(t=>t.stop()); }catch(e){} 
        S.stream=null; 
    }
    D.btnStart.disabled=false;
    D.btnStop.disabled=true;
    setStatus('åœæ­¢ä¸­');
  }

  async function startCam(){
    D.freeze.style.display='none';
    D.video.style.visibility='visible';
    D.lockEmoji.style.display='none';
    S.locked=false;
    stopCam();
    D.errCam.textContent='';

    try{
      // ã‚«ãƒ¡ãƒ©åˆ¶ç´„ã‚’ç·©å’Œ
      S.stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: 'environment' },
          // åˆ¶ç´„ã‚’ç·©å’Œï¼ˆidealã®ã¿ã«ã™ã‚‹ï¼‰
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: false
      });
      D.video.srcObject=S.stream;
      await D.video.play();
      // â˜…è¿½åŠ ï¼šæœ€åˆã®1å›ã ã‘ã€è§£åƒåº¦ãŒç¢ºå®šã™ã‚‹ã¾ã§å¾…ã¤
      await waitVideoSize();

      // ã“ã“ã‹ã‚‰å…ˆã§ canvas ã‚µã‚¤ã‚ºã‚’ç¢ºå®šã•ã›ã‚‹
      fitOverlay();
      D.scanCanvas.width  = D.video.videoWidth;
      D.scanCanvas.height = D.video.videoHeight;

      setStatus('ã‚¹ã‚­ãƒ£ãƒ³ä¸­', true);
      tick();
      D.btnStart.disabled=true;
      D.btnStop.disabled=false;
      
      
      // BarcodeDetector Setup
    if(S.useBarcodeDetector){
      try{
        const fmts = (typeof BarcodeDetector.getSupportedFormats==='function')
          ? await BarcodeDetector.getSupportedFormats()
          : [];
        if(!fmts || !fmts.includes('qr_code')) throw 0;
        S.detector = new BarcodeDetector({formats:['qr_code']});
      }catch{
        S.useBarcodeDetector = false;
        S.detector = null;
      }
    }
      D.detectorInfo.textContent = S.useBarcodeDetector ? 'BD+jsQR' : 'jsQR';
      
      fitOverlay();
      D.scanCanvas.width = D.video.videoWidth || 1280;
      D.scanCanvas.height = D.video.videoHeight || 720;
      
      setStatus('ã‚¹ã‚­ãƒ£ãƒ³ä¸­', true);
      tick();
    }catch(e){
      console.error(e);
      D.errCam.textContent = `ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: ${e.name} ${e.message}`;
      setStatus('ã‚¨ãƒ©ãƒ¼');
    }
  }
  
  function freezeAndLock(){
    fitOverlay();
    freezeCtx.drawImage(D.video,0,0,D.freeze.width,D.freeze.height);
    D.freeze.style.display='block';
    D.video.style.visibility='hidden';
    D.lockEmoji.style.display='block';
    ctx.clearRect(0,0,D.overlay.width,D.overlay.height);
    stopCam({keepFrame:true});
    setStatus('ãƒ­ãƒƒã‚¯å®Œäº†');
  }

  // --- Detection Logic ---
  async function detectCombined(){
    if(!D.video.videoWidth) return [];
    const w = D.scanCanvas.width, h = D.scanCanvas.height;
    scanCtx.drawImage(D.video, 0, 0, w, h);
    
    const detections = [];
    // 1. BarcodeDetector
    if(S.useBarcodeDetector && S.detector){
      try{
        const codes = await S.detector.detect(D.scanCanvas);
        codes.forEach(c => detections.push({ raw: c.rawValue, pts: c.cornerPoints }));
      }catch(e){ S.useBarcodeDetector=false; }
    }
    
    // 2. jsQR (Fallback)
    const imgData = scanCtx.getImageData(0,0,w,h);
    const hit = jsQR(imgData.data, w, h, { inversionAttempts:'dontInvert' });
    if(hit && !detections.some(d=>d.raw===hit.data)){
      detections.push({
        raw: hit.data,
        pts: [hit.location.topLeftCorner, hit.location.topRightCorner, hit.location.bottomRightCorner, hit.location.bottomLeftCorner]
      });
    }
    return detections;
  }

  async function tick(){
    if(!S.stream) return;
    if(D.video.readyState === D.video.HAVE_ENOUGH_DATA){
      fitOverlay();
      ctx.clearRect(0,0,D.overlay.width,D.overlay.height);
      
      const dets = await detectCombined();
      for(const d of dets){
        const raw = (d.raw||'').trim();
        if(!raw) continue;
        
        let bn='', wc='';
        const t = normHyphen(raw);
        
        // 1. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å½¢å¼ (order-plain, die-plain ãªã©)
        // ä¾‹: https://.../order-plain?book=Ko&wc=1234
        if(/order[_-]?(plain|check)|die[_-]?check/i.test(t)){
           try{
             // URLã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹
             const u = new URL(t);
             bn = u.searchParams.get('book') || u.searchParams.get('Book') || '';
             wc = u.searchParams.get('wc') || u.searchParams.get('WorkCord') || '';
           }catch(e){
             // URLã§ãªã„å ´åˆã€ã‚‚ã—ãƒ‘ã‚¹å½¢å¼ãªã‚‰?
           }
        } 
        
        // 2. ãƒ‘ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å½¢å¼ (die-Ko-1234)
        // ä¸Šè¨˜ã§å–ã‚Œã¦ã„ãªã‘ã‚Œã°è©¦è¡Œ
        if((!bn || !wc) && /^(die|order)-([^-]+)-([^-]+)/i.test(t)){
           const m = /^(die|order)-([^-\n]+)-([^-]+)/i.exec(t);
           if(m){ 
             bn = m[2]; 
             wc = m[3]; 
           }
        }

        // 3. ä¸‡ãŒä¸€ order-Ko-1234 ã®ã‚ˆã†ãªå˜ç´”æ–‡å­—åˆ—ã§ã¯ãªãURLã®ãƒ‘ã‚¹ã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¸ã®å¯¾å¿œå¼·åŒ–
        // ä¾‹: https://.../order-Ko-1234
        if((!bn || !wc)){
             // URLã‹ã‚‚ã—ã‚Œãªã„ã®ã§ãƒ‘ã‚¹éƒ¨åˆ†ã ã‘å–ã‚Šå‡ºã—ã¦ãƒã‚§ãƒƒã‚¯
             try {
                const u = new URL(t);
                const path = u.pathname; // /order-Ko-1234
                const m = /(?:^|\/)(die|order)-([^-\/]+)-([^-\/]+)/i.exec(path);
                if(m){
                    bn = m[2];
                    wc = m[3];
                }
             } catch {}
        }

        if(bn && wc){
           const sx = D.overlay.width / D.scanCanvas.width;
           const sy = D.overlay.height / D.scanCanvas.height;
           const pts = (d.pts||[]).map(p=>({x:p.x*sx, y:p.y*sy}));
           if(pts.length===4){
             ctx.strokeStyle='#228be6'; ctx.lineWidth=4; 
             ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y);
             for(let i=1;i<4;i++) ctx.lineTo(pts[i].x,pts[i].y);
             ctx.closePath(); ctx.stroke();
           }
           setTarget(bn, wc);
           S.locked=true;
           freezeAndLock();
           querySpec();
           return; 
        }
      }
    }
    S.rafId = requestAnimationFrame(tick);
  }

  function setTarget(bn, wc){
    S.current.book = bn.trim();
    S.current.wc = wc.trim();
    D.nowTarget.textContent = `ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${S.current.book} / ${S.current.wc}`;
    D.inpBook.value = S.current.book;
    D.inpWc.value = S.current.wc;
  }

  // --- API & Rendering ---
  async function querySpec(){
    const {book, wc} = S.current;
    if(!book || !wc) return;
    const key = dieKey(book, wc);
    if(key===S.lastQueryKey) return;
    S.lastQueryKey = key;

    D.errApi.textContent='';
    D.loading.style.display='inline';
    D.gsBox.innerHTML = '<div class="msg-empty">èª­ã¿è¾¼ã¿ä¸­...</div>';
    D.driveActions.innerHTML = '';
    D.driveView.innerHTML = '';
    D.driveStatus.textContent = '';

    try{
      await ensureCsrf();
      const r = await fetch('/api/die-check', {
        method:'POST', headers:{ 'Content-Type':'application/json', 'X-CSRF':S.csrf },
        body: JSON.stringify({ book, wc, json:true, limit:0, noAirtable:true, gsOnly:true })
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error||'API Error');
      
      renderSpecs(j.gs);
      await findDriveFiles(book, wc);
      
    }catch(e){
      D.errApi.textContent = e.message;
      D.gsBox.innerHTML = '<div class="msg-empty">å–å¾—å¤±æ•—</div>';
    }finally{
      D.loading.style.display='none';
    }
  }

  function renderSpecs(gs){
    if(!gs){
      D.gsBox.innerHTML = '<div class="msg-empty">è©²å½“ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
      return;
    }
    const fields = [
      {k:'ItemName', l:'å“å'}, {k:'Kname', l:'å‹å'}, 
      {k:'Material', l:'æè³ª'}, {k:'Paper_Size', l:'åŸç´™'}, 
      {k:'Cut_Size', l:'æ–­è£'}, {k:'Location', l:'æ£šç•ª'}, 
      {k:'LastSeen', l:'ç¢ºèªæ—¥'}
    ];
    let html = '<div class="spec-table">';
    fields.forEach(f => {
      const val = gs[f.k] || '-';
      html += `<div class="spec-row"><div class="spec-label">${esc(f.l)}</div><div class="spec-val">${esc(val)}</div></div>`;
    });
    html += '</div>';
    D.gsBox.innerHTML = html;
  }

  async function findDriveFiles(book, wc){
    D.driveStatus.textContent = 'æ¤œç´¢ä¸­...';
    try{
      const r = await fetch(`/api/drive-find?book=${encodeURIComponent(book)}&wc=${encodeURIComponent(wc)}`);
      const j = await r.json();
      if(!j.ok){ D.driveStatus.textContent='æ¤œç´¢ã‚¨ãƒ©ãƒ¼'; return; }

      const cands = j.candidates || (j.fileId ? [{id:j.fileId, name:j.fileName}] : []);
      if(!cands.length){
        D.driveStatus.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ãªã—';
        return;
      }

      D.driveStatus.textContent = `${cands.length}ä»¶ãƒ’ãƒƒãƒˆ`;
      
      const score = n => {
        n = n.toLowerCase();
        if(/-zu\./.test(n)) return 1;
        if(/-si\./.test(n)) return 2;
        if(n.endsWith('.pdf')) return 3;
        return 9;
      };
      cands.sort((a,b) => score(a.name||'') - score(b.name||''));

      // Actions (Buttons)
      let btnHtml = '';
      cands.forEach(f => {
        const name = f.name || '';
        const isPdf = /\.pdf$/i.test(name);
        
        // ã€ä¿®æ­£ã€‘PDFãªã‚‰ãƒ“ãƒ¥ãƒ¼ã‚¢ã€ç”»åƒãªã‚‰ç›´ãƒªãƒ³ã‚¯(UIãªã—)ã«ã™ã‚‹
        let url;
        if (isPdf) {
            // PDFã¯ãƒ“ãƒ¥ãƒ¼ã‚¢ã§ãªã„ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚‹ãŸã‚ view ã®ã¾ã¾
            url = `https://drive.google.com/file/d/${f.id}/view`;
        } else {
            // ç”»åƒï¼ˆ-zu, -siãªã©ï¼‰ã¯ Googleã®UIã‚’æŒŸã¾ãªã„ç›´ãƒªãƒ³ã‚¯ã«ã™ã‚‹
            url = `https://drive.google.com/uc?export=view&id=${f.id}`;
        }
        
        let label = 'ãƒ•ã‚¡ã‚¤ãƒ«';
        let icon = 'ğŸ“„';
        let styleClass = 'drive-btn';

        if(/-zu\./i.test(name)) { label = 'å›³é¢ (-zu)'; icon='ğŸ“'; styleClass+=' primary-btn'; }
        else if(/-si\./i.test(name)) { label = 'ã‚·ãƒ¼ãƒ« (-si)'; icon='ğŸ·ï¸'; }
        else if(/\.pdf$/i.test(name)) { label = 'PDF'; icon='ğŸ“‘'; }

        btnHtml += `<a href="${url}" target="_blank" class="${styleClass}">${icon} ${esc(label)}</a>`;
      });
      D.driveActions.innerHTML = btnHtml;

    }catch(e){
      D.driveStatus.textContent = 'æ¤œç´¢å¤±æ•—';
    }
  }

  D.btnStart.onclick = startCam;
  D.btnStop.onclick = () => stopCam();
  window.onresize = fitOverlay;

  D.btnManual.onclick = () => {
    const b = D.inpBook.value.trim();
    const w = normHyphen(D.inpWc.value.trim());
    if(!b || !w){ alert('Bookã¨WCã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    setTarget(b, w);
    S.locked=false; S.lastQueryKey='';
    querySpec();
  };

})();
</script>
</body>
</html>