<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>scan-specï½œSmart View</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<style>
  :root {
    --primary: #228be6; /* é’ */
    --primary-bg: #e7f5ff;
    --text: #343a40;
    --text-sub: #868e96;
    --bg: #f1f3f5;
    --card-bg: #ffffff;
    --border: #dee2e6;
    --ok: #12b886; /* ç·‘ */
    --ng: #fa5252; /* èµ¤ */
    --info:#f59f00; /* ã‚ªãƒ¬ãƒ³ã‚¸ */
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding-bottom: 40px;
  }

  .wrap {
    max-width: 1000px;
    margin: 0 auto;
    padding: 16px;
  }

  /* --- Header / Controls --- */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--card-bg);
    padding: 12px 16px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    margin-bottom: 16px;
    position: sticky;
    top: 8px;
    z-index: 100;
  }
  .top-controls { display: flex; gap: 10px; }

  .status-indicator {
    font-size: 12px;
    font-weight: bold;
    padding: 4px 10px;
    border-radius: 20px;
    background: #eee;
    color: #777;
  }
  .status-indicator.active { background: var(--primary-bg); color: var(--primary); }

  /* --- Grid Layout --- */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    align-items: start;
  }
  @media (max-width: 768px) {
    .main-grid { grid-template-columns: 1fr; }
  }

  /* --- Cards --- */
  .card {
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    overflow: hidden;
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
  }
  .card-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: #f8f9fa;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .card-header h2 {
    margin: 0;
    font-size: 15px;
    font-weight: 700;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .card-body {
    padding: 16px;
  }

  /* --- Camera Area --- */
  .stack {
    position: relative;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    aspect-ratio: 16/9;
  }
  video { width: 100%; height: 100%; object-fit: cover; display: block; }
  canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }
  #freeze, #lockEmoji { display: none; }

  .lockmark { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
  .lockmark .em { font-size: 60px; text-shadow: 0 4px 12px rgba(0,0,0,0.5); }

  /* â˜… ã‚¬ã‚¤ãƒ‰ï¼ˆlookupé¢¨ï¼‰ï¼šä¸­å¤®200px */
  .target-scope{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    width:200px; height:200px;
    border:2px solid rgba(34,139,230,.85);
    border-radius:12px;
    pointer-events:none;
    z-index:10;
    box-shadow:0 0 0 9999px rgba(0,0,0,.28);
  }
  .target-scope .scan-line{
    position:absolute; left:0; top:0; width:100%; height:2px;
    background:linear-gradient(90deg,transparent,rgba(34,139,230,.8),transparent);
    animation:scan 2s linear infinite;
  }
  @keyframes scan{0%{top:0}100%{top:100%}}

  .target-info {
    margin-top: 10px;
    padding: 8px 12px;
    background: var(--primary-bg);
    color: var(--primary);
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
    font-size: 14px;
  }

  /* --- Manual Input --- */
  .manual-area {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px dashed var(--border);
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .inp-group { display: flex; flex-direction: column; gap: 4px; flex: 1; }
  .inp-group label { font-size: 11px; color: var(--text-sub); font-weight: bold; }
  .inp-control {
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    width: 100%;
    background: #fff;
  }
  .inp-control:focus { outline: 2px solid var(--primary-bg); border-color: var(--primary); }

  /* --- Specs (Google Sheets) --- */
  .spec-table {
    display: grid;
    grid-template-columns: 100px 1fr;
    font-size: 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .spec-row { display: contents; }
  .spec-label {
    background: #f8f9fa;
    padding: 8px 12px;
    color: var(--text-sub);
    font-weight: 600;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center;
  }
  .spec-val {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    font-weight: 500;
    word-break: break-all;
  }
  .spec-row:last-child .spec-label,
  .spec-row:last-child .spec-val { border-bottom: none; }

  /* --- Files (Google Drive) --- */
  .drive-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
  }
  .drive-btn {
    text-decoration: none;
    background: #fff;
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
    flex: 1;
    justify-content: center;
    white-space: nowrap;
  }
  .drive-btn:hover { background: #f8f9fa; border-color: #adb5bd; }
  .drive-btn.primary-btn { background: var(--primary); color: #fff; border-color: var(--primary); }
  .drive-btn.primary-btn:hover { opacity: 0.9; }

  .fig-container { display: flex; flex-direction: column; gap: 16px; }
  .msg-empty { text-align: center; padding: 20px; color: var(--text-sub); font-size: 13px; }

  /* --- Buttons --- */
  .btn {
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn-primary { background: var(--primary); color: #fff; }
  .btn-primary:hover { background: #1c7ed6; }
  .btn-sub { background: #fff; border: 1px solid var(--border); color: var(--text); }
  .btn-sub:disabled { background: #f1f3f5; color: #adb5bd; cursor: not-allowed; }
</style>
</head>
<body>

<div class="wrap">
  <div class="topbar">
    <div class="top-controls">
      <button id="btnStart" class="btn btn-primary">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
      <button id="btnStop" class="btn btn-sub" disabled>åœæ­¢</button>
    </div>
    <div id="scanStatus" class="status-indicator">å¾…æ©Ÿä¸­</div>
  </div>

  <div class="main-grid">
    <div class="card">
      <div class="card-header">
        <h2>ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³</h2>
        <span id="detectorInfo" style="font-size:11px; color:#aaa">jsQR</span>
      </div>
      <div class="card-body">
        <div class="stack" id="stack">
          <video id="video" playsinline webkit-playsinline muted></video>
          <canvas id="freeze"></canvas>
          <canvas id="overlay"></canvas>
          <div class="lockmark"><div class="em" id="lockEmoji">ğŸ”’</div></div>
          <canvas id="scanCanvas" style="display:none"></canvas>
          <div class="target-scope"><div class="scan-line"></div></div>
        </div>

        <div id="nowTarget" class="target-info">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: â€” / â€”</div>
        <div id="errCam" style="color:var(--ng); font-size:12px; margin-top:4px;"></div>

        <div class="manual-area">
          <div class="inp-group" style="flex:0 0 80px;">
            <label>Book</label>
            <select id="inpBook" class="inp-control">
              <option value="">-</option>
              <option value="Ko">Ko</option>
              <option value="Yo">Yo</option>
              <option value="Ta">Ta</option>
            </select>
          </div>
          <div class="inp-group">
            <label>WC (ä¾‹: 1234)</label>
            <input id="inpWc" type="text" inputmode="numeric" class="inp-control" placeholder="WorkCord" />
          </div>
          <button id="btnManual" class="btn btn-sub" style="align-self:flex-end; height:38px;">ç…§ä¼š</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>ğŸ“„ çµæœ</h2>
        <span id="loading" style="font-size:12px; color:var(--primary); display:none;">ç…§ä¼šä¸­...</span>
      </div>

      <div class="card-body">
        <h3 style="font-size:14px; margin:0 0 8px; color:var(--text-sub);">åŸºæœ¬ã‚¹ãƒšãƒƒã‚¯ (Google Sheets)</h3>
        <div id="gsBox"><div class="msg-empty">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã¾ã›ã‚“</div></div>
        <div id="errApi" style="color:var(--ng); font-size:12px; margin-top:6px;"></div>

        <div style="margin-top:24px; border-top:1px solid var(--border); padding-top:16px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h3 style="font-size:14px; margin:0; color:var(--text-sub);">é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ« (Google Drive)</h3>
            <div id="driveStatus" style="font-size:11px; color:#aaa;"></div>
          </div>

          <div id="driveActions" class="drive-actions"></div>
          <div id="driveView" class="fig-container"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" crossorigin="anonymous"></script>
<script>
(() => {
  const D = {
    video: q('#video'), overlay: q('#overlay'), freeze: q('#freeze'), stack: q('#stack'),
    btnStart: q('#btnStart'), btnStop: q('#btnStop'),
    detectorInfo: q('#detectorInfo'), scanStatus: q('#scanStatus'),
    errCam: q('#errCam'), errApi: q('#errApi'), loading: q('#loading'),
    lockEmoji: q('#lockEmoji'), scanCanvas: q('#scanCanvas'),
    inpBook: q('#inpBook'), inpWc: q('#inpWc'), btnManual: q('#btnManual'),
    gsBox: q('#gsBox'),
    driveStatus: q('#driveStatus'), driveView: q('#driveView'), driveActions: q('#driveActions'),
    nowTarget: q('#nowTarget'),
  };
  function q(s){ return document.querySelector(s); }

  const ctx = D.overlay.getContext('2d', { willReadFrequently:true });
  const freezeCtx = D.freeze.getContext('2d', { willReadFrequently:true });
  const scanCtx = D.scanCanvas.getContext('2d',{ willReadFrequently:true });

  const CFG = {
    SCAN_EVERY_MS: 80,
    JSQR_MULTI_MAX: 6,
    ROI_SCALE: 1.75,
    ROI_FRACTION: 0.62
  };

  const S = {
    stream: null, rafId: null,
    useBarcodeDetector: ('BarcodeDetector' in window), detector: null,
    csrf: '', locked: false,
    current: { book:'', wc:'' }, lastQueryKey:'',
    lastScanAt: 0,
  };

  // --- CSRF & Cookie ---
  function readCookie(name){
    const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')+'=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : '';
  }
  async function ensureCsrf(){
    let t = readCookie('xcsrf');
    if(!t){
      const url = (location.protocol==='http:' && /localhost|127\.0\.0\.1/.test(location.host)) ? '/api/session?dev=1' : '/api/session';
      await fetch(url,{method:'GET',credentials:'same-origin',cache:'no-store'}).catch(()=>{});
      t = readCookie('xcsrf');
    }
    if(t) S.csrf = t;
  }
  document.addEventListener('DOMContentLoaded', ensureCsrf);

  // --- Helpers ---
  async function waitVideoSize(timeoutMs = 2500){
    const t0 = performance.now();
    while(performance.now() - t0 < timeoutMs){
      if(D.video.videoWidth > 0 && D.video.videoHeight > 0) return true;
      await new Promise(r => requestAnimationFrame(r));
    }
    return false;
  }
  function esc(s){ return String(s??'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function dieKey(bn,wc){ return (bn||'').toLowerCase()+'@@'+(wc||'').toLowerCase(); }
  function normHyphen(s){
    return (s||'')
      .replace(/[â€-â€’â€“â€”â€•ãƒ¼âˆ’]/g,'-')   // ãƒã‚¤ãƒ•ãƒ³çµ±ä¸€
      .replace(/[ï¼š]/g, ':')          // å…¨è§’ã‚³ãƒ­ãƒ³â†’åŠè§’
      .replace(/\s*-\s*/g,'-')        // "Ta - 230" â†’ "Ta-230"
      .replace(/\s*:\s*/g,':')        // "Ko : 1358" â†’ "Ko:1358"
      .replace(/\s+/g,' ')
      .trim();
  }


  function setStatus(text, active=false){
    D.scanStatus.textContent = text;
    if(active) D.scanStatus.classList.add('active');
    else D.scanStatus.classList.remove('active');
  }

  function fitAll(){
    if(!D.video.videoWidth) return;
    const vw = D.video.videoWidth, vh = D.video.videoHeight;
    D.overlay.width = vw; D.overlay.height = vh;
    D.freeze.width  = vw; D.freeze.height  = vh;
    D.scanCanvas.width = vw; D.scanCanvas.height = vh;
  }

  function drawPoly(pts, stroke='#228be6', w=4, dash=null, alpha=1){
    if(!pts || pts.length<4) return;
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.strokeStyle = stroke;
    ctx.lineWidth = w;
    if(dash) ctx.setLineDash(dash);
    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
    ctx.closePath(); ctx.stroke();
    ctx.restore();
  }

  function inScope(cornerPoints){
    if(!cornerPoints || cornerPoints.length<4) return true;
    const stackW = D.stack.clientWidth, stackH = D.stack.clientHeight;
    if(!stackW || !stackH) return true;

    const scopeCssSize = 200;
    const scopeCssX = (stackW/2) - (scopeCssSize/2);
    const scopeCssY = (stackH/2) - (scopeCssSize/2);

    const scaleX = D.overlay.width / stackW;
    const scaleY = D.overlay.height / stackH;

    const scopeX = scopeCssX * scaleX;
    const scopeY = scopeCssY * scaleY;
    const scopeW = scopeCssSize * scaleX;
    const scopeH = scopeCssSize * scaleY;

    const marginX = 14 * scaleX;
    const marginY = 14 * scaleY;

    for(const pt of cornerPoints){
      if(pt.x < scopeX - marginX) return false;
      if(pt.x > scopeX + scopeW + marginX) return false;
      if(pt.y < scopeY - marginY) return false;
      if(pt.y > scopeY + scopeH + marginY) return false;
    }
    return true;
  }

  // --- Camera Controlï¼ˆâ˜…èª­ã¿å–ã‚Šå„ªå…ˆï¼šã‚·ãƒ³ãƒ—ãƒ«ã«æˆ»ã™ï¼‰ ---
  function stopCam({keepFrame=false}={}){
    if(S.rafId) cancelAnimationFrame(S.rafId);
    S.rafId=null;

    // è§£æ”¾ã¯ç¶­æŒï¼ˆèµ·å‹•å¤±æ•—ã®å†ç™ºã‚’æ¸›ã‚‰ã™ï¼‰
    try{ D.video.pause(); }catch(e){}
    try{ D.video.srcObject = null; }catch(e){}

    if(!keepFrame){
      ctx.clearRect(0,0,D.overlay.width,D.overlay.height);
      D.freeze.style.display='none';
      D.lockEmoji.style.display='none';
      D.video.style.visibility='visible';
    }
    if(S.stream){
      try{ S.stream.getTracks().forEach(t=>t.stop()); }catch(e){}
      S.stream=null;
    }
    D.btnStart.disabled=false;
    D.btnStop.disabled=true;
    setStatus('åœæ­¢ä¸­');
  }

  async function setupDetector(){
    S.useBarcodeDetector = ('BarcodeDetector' in window);
    S.detector = null;
    if(!S.useBarcodeDetector) return;
    try{
      const fmts = (typeof BarcodeDetector.getSupportedFormats==='function')
        ? await BarcodeDetector.getSupportedFormats()
        : [];
      if(fmts && fmts.includes('qr_code')){
        S.detector = new BarcodeDetector({formats:['qr_code']});
      }else{
        S.detector = new BarcodeDetector({formats:['qr_code']});
      }
    }catch{
      S.useBarcodeDetector = false;
      S.detector = null;
    }
  }

  async function startCam(){
    S.locked=false;
    stopCam(); // æ—¢å­˜åœæ­¢ï¼ˆè§£æ”¾ï¼‰

    D.errCam.textContent='';
    D.freeze.style.display='none';
    D.video.style.visibility='visible';
    D.lockEmoji.style.display='none';

    // â˜… ä½™è¨ˆãªè§£åƒåº¦/fpså›ºå®šã‚’ã‚„ã‚ã‚‹ï¼ˆç«¯æœ«ãŒæœ€é©ã‚’é¸ã¶ï¼èª­ã¿å–ã‚ŠãŒæˆ»ã‚Šã‚„ã™ã„ï¼‰
    const constraints = {
      video: { facingMode: { ideal: 'environment' } },
      audio: false
    };

    try{
      S.stream = await navigator.mediaDevices.getUserMedia(constraints);
      D.video.srcObject = S.stream;

      // â˜… play ã¯æ¡ã‚Šã¤ã¶ã•ãšã€å¤±æ•—ã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã«ã™ã‚‹ï¼ˆåŸå› ãŒè¦‹ãˆã‚‹ï¼‰
      await D.video.play();

      const ok = await waitVideoSize();
      if(!ok) throw new Error('ã‚«ãƒ¡ãƒ©è§£åƒåº¦ãŒç¢ºå®šã—ã¾ã›ã‚“ã§ã—ãŸ');

      fitAll();
      await setupDetector();
      D.detectorInfo.textContent = (S.useBarcodeDetector && S.detector) ? 'BD+jsQR' : 'jsQR';

      D.btnStart.disabled=true;
      D.btnStop.disabled=false;

      S.lastScanAt = 0;
      setStatus('ã‚¹ã‚­ãƒ£ãƒ³ä¸­', true);
      tick();
    }catch(e){
      console.error(e);
      D.errCam.textContent = `ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: ${e.name||''} ${e.message||e}`;
      setStatus('ã‚¨ãƒ©ãƒ¼');
      stopCam();
    }
  }

  function freezeAndLock(){
    fitAll();
    freezeCtx.drawImage(D.video,0,0,D.freeze.width,D.freeze.height);
    D.freeze.style.display='block';
    D.video.style.visibility='hidden';
    D.lockEmoji.style.display='block';
    ctx.clearRect(0,0,D.overlay.width,D.overlay.height);
    stopCam({keepFrame:true});
    setStatus('ãƒ­ãƒƒã‚¯å®Œäº†');
  }

  function extractBookWc(raw){
    const t = normHyphen((raw||'').trim());
    let bn='', wc='';

    // 0) ä¾‹: "Ta:230" / "Ta-230"
    {
      const m = /^([A-Za-z]{1,3})[:\-](\d+)$/i.exec(t);
      if(m){ bn=m[1]; wc=m[2]; return {bn, wc}; }
    }

    // 1) ç›´æ–‡å­—åˆ—: die-Ta-230 / order-Ko-1358 / ORDER Ko:1358
    {
      const m = /^(die|order)\s*[:\-]?\s*([A-Za-z]{1,3})[:\-](\d+)$/i.exec(t);
      if(m){ bn=m[2]; wc=m[3]; return {bn, wc}; }
    }

    // 2) ç›´æ–‡å­—åˆ—ï¼ˆå¾“æ¥ã® die-Ko-1234 / order-Ko-1234 å½¢å¼ï¼‰
    {
      const m = /^(die|order)-([^-\n\/?#]+)-([^-\n\/?#]+)/i.exec(t);
      if(m){ bn=m[2]; wc=m[3]; return {bn, wc}; }
    }

    // 3) URL: ?book=Ko&wc=1234
    try{
      const u = new URL(t);
      bn = (u.searchParams.get('book') || u.searchParams.get('Book') || '').trim();
      wc = (u.searchParams.get('wc')   || u.searchParams.get('WorkCord') || u.searchParams.get('workcord') || '').trim();
      if(bn && wc) return {bn, wc};

      // 4) URL pathname: /die-Ko-1234 /order-Ko-1234
      const path = u.pathname || '';
      const m2 = /(?:^|\/)(die|order)-([^-\n\/?#]+)-([^-\n\/?#]+)/i.exec(path);
      if(m2){
        bn = m2[2]; wc = m2[3];
        if(bn && wc) return {bn, wc};
      }
    }catch{}

  return null;
}


  async function detectCombined(){
    if(!D.video.videoWidth) return [];
    const vw = D.video.videoWidth, vh = D.video.videoHeight;
    const w = D.scanCanvas.width, h = D.scanCanvas.height;

    const dets = new Map();

    if(S.useBarcodeDetector && S.detector){
      try{
        const codes = await S.detector.detect(D.video);
        for(const c of codes){
          const raw = (c.rawValue||'').trim();
          if(raw && !dets.has(raw)) dets.set(raw, { raw, pts: c.cornerPoints });
        }
      }catch{
        try{
          scanCtx.drawImage(D.video, 0, 0, w, h);
          const codes = await S.detector.detect(D.scanCanvas);
          for(const c of codes){
            const raw = (c.rawValue||'').trim();
            if(raw && !dets.has(raw)) dets.set(raw, { raw, pts: c.cornerPoints });
          }
        }catch{
          S.useBarcodeDetector=false; S.detector=null;
        }
      }
    }

    const jsqrMulti = (imgData) => {
      const hits = [];
      const W = imgData.width, H = imgData.height;
      const masked = new Uint8ClampedArray(imgData.data);
      for(let k=0; k<CFG.JSQR_MULTI_MAX; k++){
        const hit = jsQR(masked, W, H, { inversionAttempts:'attemptBoth' });
        if(!hit) break;
        hits.push({
          raw: (hit.data||'').trim(),
          pts: [hit.location.topLeftCorner, hit.location.topRightCorner, hit.location.bottomRightCorner, hit.location.bottomLeftCorner]
        });
        const tl = hit.location.topLeftCorner, br = hit.location.bottomRightCorner;
        for(let y=Math.floor(tl.y); y<Math.ceil(br.y); y++){
          for(let x=Math.floor(tl.x); x<Math.ceil(br.x); x++){
            const i = (y*W + x) * 4;
            masked[i]=masked[i+1]=masked[i+2]=255;
          }
        }
      }
      return hits;
    };

    scanCtx.drawImage(D.video, 0, 0, w, h);
    let img = scanCtx.getImageData(0,0,w,h);
    for(const h1 of jsqrMulti(img)){
      if(h1.raw && !dets.has(h1.raw)) dets.set(h1.raw, h1);
    }

    if(dets.size === 0){
      const frac = CFG.ROI_FRACTION;
      const sw = Math.floor(vw * frac);
      const sh = Math.floor(vh * frac);
      const sx = Math.floor((vw - sw) / 2);
      const sy = Math.floor((vh - sh) / 2);

      scanCtx.drawImage(D.video, sx, sy, sw, sh, 0, 0, w, h);
      img = scanCtx.getImageData(0,0,w,h);
      for(const h2 of jsqrMulti(img)){
        if(h2.raw && !dets.has(h2.raw)) dets.set(h2.raw, h2);
      }
    }

    return Array.from(dets.values());
  }

  async function tick(){
    if(!S.stream) return;

    const now = performance.now();
    if(now - S.lastScanAt < CFG.SCAN_EVERY_MS){
      S.rafId = requestAnimationFrame(tick);
      return;
    }
    S.lastScanAt = now;

    if(D.video.readyState === D.video.HAVE_ENOUGH_DATA){
      fitAll();
      ctx.clearRect(0,0,D.overlay.width,D.overlay.height);

      const dets = await detectCombined();

      if(!dets.length){
        setStatus('ã‚¹ã‚­ãƒ£ãƒ³ä¸­', true);
        S.rafId = requestAnimationFrame(tick);
        return;
      }

      let anyInScope = false;
      for(const d of dets){
        const raw = (d.raw||'').trim(); if(!raw) continue;
        const pts = d.pts || [];
        if(!pts.length) continue;

        const okScope = inScope(pts);
        anyInScope = anyInScope || okScope;
        drawPoly(pts, okScope ? '#228be6' : '#fa5252', okScope ? 4 : 3, okScope ? null : [8,6], okScope ? 0.85 : 0.35);

        if(okScope){
          const p = extractBookWc(raw);
          if(p && p.bn && p.wc){
            setTarget(p.bn, p.wc);
            S.locked=true;
            freezeAndLock();
            querySpec();
            return;
          }
        }
      }

      if(anyInScope) setStatus(`QRæ¤œçŸ¥ï¼ˆå½¢å¼/å†…å®¹ãŒä¸€è‡´ã—ã¾ã›ã‚“ï¼‰`, true);
      else setStatus(`QRæ¤œçŸ¥ï¼ˆã‚¬ã‚¤ãƒ‰å¤–ï¼‰`, true);
    }

    S.rafId = requestAnimationFrame(tick);
  }

  function setTarget(bn, wc){
    S.current.book = (bn||'').trim();
    S.current.wc   = (wc||'').trim();
    D.nowTarget.textContent = `ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${S.current.book} / ${S.current.wc}`;
    D.inpBook.value = S.current.book;
    D.inpWc.value = S.current.wc;
  }

  // â–¼â–¼â–¼ ã“ã“ã‹ã‚‰æ›¸ãæ›ãˆ â–¼â–¼â–¼

  async function querySpec(){
    const {book, wc} = S.current;
    if(!book || !wc) return;
    const key = dieKey(book, wc);
    if(key === S.lastQueryKey) return; 
    S.lastQueryKey = key;

    D.errApi.textContent='';
    D.loading.style.display='inline';
    
    // â˜… è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ã€Œå³åº§ã«ã€å®Œå…¨ã«ç©ºã«ã™ã‚‹ï¼ˆã“ã‚ŒãŒé‡è¦ï¼‰
    D.gsBox.innerHTML = '<div class="msg-empty">èª­ã¿è¾¼ã¿ä¸­...</div>';
    D.driveActions.innerHTML = '';
    D.driveView.innerHTML = ''; // ã“ã“ã‚’ç¢ºå®Ÿã«ã‚¯ãƒªã‚¢
    D.driveStatus.textContent = 'æ¤œç´¢ä¸­...';

    try{
      await ensureCsrf();

      // ä¸¦åˆ—ã§èµ°ã‚‰ã›ã‚‹
      const pSheet = fetchSpecs(book, wc);   
      const pDrive = findDriveFiles(book, wc); 

      // Sheetsã®å®Œäº†ã‚’å¾…ã¤ï¼ˆDriveã¯å†…éƒ¨ã§è¡¨ç¤ºã¾ã§å®Œçµã•ã›ã‚‹ï¼‰
      await pSheet; 

    }catch(e){
      D.errApi.textContent = e.message || e;
    }finally{
      D.loading.style.display='none';
    }
  }

  // Sheetsæ¤œç´¢éƒ¨åˆ†ã‚’åˆ†é›¢ï¼ˆä¸¦åˆ—åŒ–ã—ã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰
  async function fetchSpecs(book, wc){
    try {
      const r = await fetch('/api/die-check', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', ...(S.csrf?{'X-CSRF':S.csrf}:{}) },
        credentials:'same-origin',
        body: JSON.stringify({ book, wc, json:true, limit:0, noAirtable:true, gsOnly:true })
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error||'API Error');
      renderSpecs(j.gs);
    } catch(e) {
      // Sheetsã®ã‚¨ãƒ©ãƒ¼ã¯ã“ã“ã§å‡¦ç†
      D.gsBox.innerHTML = `<div class="msg-empty" style="color:var(--ng)">${esc(e.message)}</div>`;
    }
  }
  function renderSpecs(gs){
    if(!gs){
      D.gsBox.innerHTML = '<div class="msg-empty">è©²å½“ãƒ‡ãƒ¼ã‚¿ãªã—</div>';
      return;
    }
    const fields = [
      {k:'ItemName', l:'å“å'}, {k:'Kname', l:'å‹å'},
      {k:'Material', l:'æè³ª'}, {k:'Paper_Size', l:'åŸç´™'},
      {k:'Cut_Size', l:'æ–­è£'}, {k:'Location', l:'æ£šç•ª'},
      {k:'LastSeen', l:'ç¢ºèªæ—¥'}
    ];
    let html = '<div class="spec-table">';
    fields.forEach(f => {
      const val = gs[f.k] || '-';
      html += `<div class="spec-row"><div class="spec-label">${esc(f.l)}</div><div class="spec-val">${esc(val)}</div></div>`;
    });
    html += '</div>';
    D.gsBox.innerHTML = html;
  }
  async function findDriveFiles(book, wc){
  try{
    const r = await fetch(
      `/api/drive-find?book=${encodeURIComponent(book)}&wc=${encodeURIComponent(wc)}`,
      { credentials:'same-origin', cache:'no-store' }
    );
    const j = await r.json();

    if(!j.ok){
      D.driveStatus.textContent = 'æ¤œç´¢ã‚¨ãƒ©ãƒ¼';
      return;
    }

    const cands = j.candidates || (j.fileId ? [{ id:j.fileId, name:j.fileName }] : []);
    if(!cands.length){
      D.driveStatus.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ãªã—';
      return;
    }

    D.driveStatus.textContent = `${cands.length}ä»¶ãƒ’ãƒƒãƒˆ`;

    // å„ªå…ˆé †
    const score = (n) => {
      n = (n||'').toLowerCase();
      if(/-zu\./.test(n)) return 1;
      if(/-si\./.test(n)) return 2;
      if(n.endsWith('.pdf')) return 3;
      return 9;
    };
    cands.sort((a,b)=> score(a.name||'') - score(b.name||''));

    // ãƒœã‚¿ãƒ³
    let btnHtml = '';
    for(const f of cands){
      const id = f.id;
      const name = f.name || '';
      const isPdf = /\.pdf$/i.test(name);
      const url = isPdf
        ? `https://drive.google.com/file/d/${id}/view`
        : `https://drive.google.com/uc?export=view&id=${id}`;

      let label='ãƒ•ã‚¡ã‚¤ãƒ«', icon='ğŸ“„', cls='drive-btn';
      if(/-zu\./i.test(name)) { label='å›³é¢ (-zu)'; icon='ğŸ“'; cls+=' primary-btn'; }
      else if(/-si\./i.test(name)) { label='ã‚·ãƒ¼ãƒ« (-si)'; icon='ğŸ·ï¸'; }
      else if(isPdf) { label='PDF'; icon='ğŸ“‘'; }
      else if(/\.(jpg|jpeg|png|gif)$/i.test(name)) { label='ç”»åƒ'; icon='ğŸ–¼ï¸'; }

      btnHtml += `<a href="${url}" target="_blank" class="${cls}">${icon} ${esc(label)}</a>`;
    }
    D.driveActions.innerHTML = btnHtml;

    // ã“ã“é‡è¦ï¼šæ¯å›ä¸¸ã”ã¨ä½œã‚Šç›´ã™
    // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ DOM ã§ç”Ÿæˆï¼ˆinnerHTMLã§ã‚‚OKã ãŒã€ç¢ºå®Ÿã«ã™ã‚‹ï¼‰
D.driveView.innerHTML = '';
const frag = document.createDocumentFragment();

// ã“ã“ã¯1å›ã ã‘
const baseCb = Date.now().toString(36);

cands.forEach(f => {
  const id = f.id;
  const name = f.name || '';
  const isPdf = /\.pdf$/i.test(name);
  const isImg = /\.(jpg|jpeg|png|gif)$/i.test(name);
  const isPreview = isImg || /-zu\./i.test(name) || /-si\./i.test(name);
  if(!isPreview) return;

  const url = isPdf
    ? `https://drive.google.com/file/d/${id}/view`
    : `https://drive.google.com/uc?export=view&id=${id}`;

  // â˜…ã‚µãƒ ãƒã¯ã‚µãƒ¼ãƒçµŒç”±ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ã¯ baseCb+idï¼‰
  const thumbUrl = `/api/drive-thumb?id=${encodeURIComponent(id)}&cb=${baseCb}-${encodeURIComponent(id)}`;

  const a = document.createElement('a');
  a.href = url;
  a.target = '_blank';
  a.rel = 'noopener';
  a.style.cssText = 'display:block; border:1px solid #ddd; border-radius:8px; overflow:hidden;';

  const img = document.createElement('img');
  img.loading = 'lazy';
  img.alt = name;
  img.style.cssText = 'width:100%; display:block;';
  img.src = thumbUrl;

  const cap = document.createElement('div');
  cap.style.cssText = 'padding:4px 8px; font-size:11px; color:#666; background:#f9f9f9;';
  cap.textContent = name;

  img.onerror = () => {
    img.style.display = 'none';
    const err = document.createElement('div');
    err.style.cssText = 'padding:8px; font-size:12px; color:#fa5252; background:#fff5f5;';
    err.textContent = `ã‚µãƒ ãƒèª­ã¿è¾¼ã¿å¤±æ•—: ${name}`;
    a.insertBefore(err, cap);
  };

  a.appendChild(img);
  a.appendChild(cap);

  // â˜…é‡è¦ï¼šdbgï¼ˆid=.../thumb=...ï¼‰ã¯ append ã—ãªã„
  frag.appendChild(a);
});

D.driveView.appendChild(frag);



  }catch(e){
    console.error(e);
    D.driveStatus.textContent = 'æ¤œç´¢å¤±æ•—';
  }
}



  // --- Events ---
  D.btnStart.onclick = startCam;
  D.btnStop.onclick = () => stopCam();
  window.onresize = fitAll;

  D.btnManual.onclick = () => {
    const b = D.inpBook.value.trim();
    const w = normHyphen(D.inpWc.value.trim());
    if(!b || !w){ alert('Bookã¨WCã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    setTarget(b, w);
    S.locked=false; S.lastQueryKey='';
    querySpec();
  };

})();
</script>
</body>
</html>
