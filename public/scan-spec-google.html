<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>scan-specï½œæœ€å°UIï¼ˆã‚«ãƒ¡ãƒ©ï¼‹çµæœï¼‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<style>
  :root{
    --ok:#1c7ed6; --ng:#e03131; --tx:#212529; --sub:#6c757d;
    --bg:#f8f9fa; --bd:#dee2e6; --soft:#ffffff;
  }
  html,body{margin:0;background:var(--bg);color:var(--tx);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;height:100%}
  .wrap{max-width:1200px;margin:0 auto;padding:12px}
  .topbar{
    position:sticky; top:0; z-index:10; display:flex; gap:10px; align-items:center; padding:10px 12px;
    background:rgba(255,255,255,.95); border:1px solid var(--bd); border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.06);
    margin-bottom:10px;
  }
  .topbar .spacer{flex:1 1 auto}
  .chip{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--bd);background:#fff;font-size:12px;font-weight:700}
  .chip.ok{background:#e7f5ff;color:#1c7ed6;border-color:#a5d8ff}
  .chip.ng{background:#fff5f5;color:#e03131;border-color:#ffc9c9}
  .btn{padding:10px 16px;border-radius:10px;border:1px solid var(--bd);background:#fff;cursor:pointer;font-size:14px;font-weight:600;transition:.2s}
  .btn.primary{background:var(--ok);color:#fff;border-color:var(--ok)}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn.sm{padding:6px 10px;font-size:12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

  .card{background:#fff;border:1px solid var(--bd);border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,.06),0 1px 3px rgba(0,0,0,.04);padding:12px}
  .title{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:0 0 8px}
  .title h2{margin:0;font-size:16px}
  .muted{color:var(--sub);font-size:12px}

  /* å·¦ï¼šã‚«ãƒ¡ãƒ©ã‚¹ã‚¿ãƒƒã‚¯ */
  .stack{position:relative;border:1px solid var(--bd);border-radius:12px;overflow:hidden;background:#000}
  video{display:block;width:100%;background:#000}
  canvas{position:absolute;inset:0;pointer-events:none}
  #freeze{z-index:1; display:none;}
  #overlay{z-index:2;}

  /* å³ï¼šçµæœãƒ‘ãƒãƒ«ã¯ç¸¦ã«2æ®µï¼ˆä»•æ§˜â†’å›³é¢ï¼‰ */
  .section{margin-top:8px}
  .kvs{display:grid;grid-template-columns:max-content 1fr;gap:6px 10px;font-size:14px}
  .kvs b{color:#333}

  /* ã‚¹ã‚­ãƒ£ãƒ³ãƒ­ãƒƒã‚¯æ™‚ã®ã‚¢ã‚¤ã‚³ãƒ³ */
  .lockmark{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; pointer-events:none}
  .lockmark .em{font-size:70px; text-shadow:0 3px 10px rgba(0,0,0,.5); display:none}

  /* Book / wc æ‰‹å…¥åŠ›ã‚¨ãƒªã‚¢ */
  .manual-inputs{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:6px;
    margin-top:8px;
    font-size:13px;
  }
  .manual-inputs label{
    font-weight:600;
  }
  .manual-inputs select,
  .manual-inputs input{
    padding:6px 8px;
    border-radius:8px;
    border:1px solid var(--bd);
    font-size:13px;
    min-width:70px;
    background:#fff;
  }
</style>
</head>
<body>
<div class="wrap">

  <!-- æœ€ä¸Šæ®µï¼šæœ€å°ã®æ“ä½œã ã‘ -->
  <div class="topbar">
    <button id="btnStart" class="btn primary">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
    <button id="btnStop" class="btn" disabled>åœæ­¢</button>
    <span id="scanStatus" class="chip">å¾…æ©Ÿä¸­</span>
    <span id="detectorInfo" class="chip muted"></span>
    <div class="spacer"></div>
    <span class="chip" id="csrfStatus">CSRF: æ¤œæŸ»ä¸­â€¦</span>
  </div>

  <div class="grid">
    <!-- å·¦ï¼šã‚«ãƒ¡ãƒ© -->
    <div class="card">
      <div class="title"><h2>ã‚¹ã‚­ãƒ£ãƒ³</h2><span id="atState" class="muted"></span></div>
      <div class="stack" id="stack">
        <video id="video" playsinline webkit-playsinline muted></video>
        <canvas id="freeze"></canvas>
        <canvas id="overlay"></canvas>
        <div class="lockmark"><div class="em" id="lockEmoji">ğŸ”’</div></div>
        <canvas id="scanCanvas" style="display:none"></canvas>
      </div>
      <div id="errCam" class="muted" style="margin-top:6px;"></div>
      <div class="muted" id="nowTarget" style="margin-top:6px;">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: â€” / â€”</div>

      <!-- â˜… è¿½åŠ ï¼šBook / wc æ‰‹å…¥åŠ›ã‚¨ãƒªã‚¢ -->
      <div class="manual-inputs">
        <label for="inpBook">Book</label>
        <select id="inpBook">
          <option value="">â€”</option>
          <option value="Ko">Ko</option>
          <option value="Yo">Yo</option>
          <option value="Ta">Ta</option>
        </select>

        <label for="inpWc">wc</label>
        <input id="inpWc" type="text" inputmode="numeric" placeholder="ä¾‹: 1234" />

        <button id="btnManual" class="btn sm">ç…§ä¼š</button>
      </div>
    </div>

    <!-- å³ï¼šçµæœï¼ˆä¸Šï¼šä»•æ§˜ / ä¸‹ï¼šå›³é¢ï¼‰ -->
    <div class="card">
      <div class="title"><h2>çµæœ</h2><span id="loading" class="muted" style="display:none;">ç…§ä¼šä¸­â€¦</span></div>

      <!-- ä»•æ§˜ï¼ˆGoogle Sheetsï¼‰ -->
      <div class="section">
        <h3 style="margin:0 0 6px;font-size:15px;">Google Sheetsï¼ˆä»•æ§˜ï¼‰</h3>
        <div id="gsBox" class="kvs">
          <div class="muted">ï¼ˆæœªå–å¾—ï¼‰</div>
        </div>
        <div id="errApi" class="muted" style="margin-top:6px; display:none;"></div>
      </div>

      <!-- å›³é¢ï¼ˆGoogle Driveï¼‰ -->
      <div class="section" style="margin-top:14px;">
        <h3 style="margin:0 0 6px;font-size:15px;">Google Driveï¼ˆå›³é¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰</h3>
        <div id="driveStatus" class="muted">â€”</div>
        <div id="driveView" style="margin-top:6px;"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" crossorigin="anonymous"></script>
<script>
(() => {
  const D = {
    // DOM
    video: q('#video'), overlay: q('#overlay'), freeze: q('#freeze'), stack: q('#stack'),
    btnStart: q('#btnStart'), btnStop: q('#btnStop'),
    detectorInfo: q('#detectorInfo'), scanStatus: q('#scanStatus'),
    errCam: q('#errCam'), errApi: q('#errApi'), loading: q('#loading'),
    csrfStatus: q('#csrfStatus'), atState: q('#atState'),
    lockEmoji: q('#lockEmoji'),
    scanCanvas: q('#scanCanvas'),
    // æ‰‹å…¥åŠ›
    inpBook: q('#inpBook'), inpWc: q('#inpWc'), btnManual: q('#btnManual'),
    // çµæœè¡¨ç¤º
    gsBox: q('#gsBox'),
    driveStatus: q('#driveStatus'), driveView: q('#driveView'),
    nowTarget: q('#nowTarget'),
  };

  function q(s){ return document.querySelector(s); }

  const ctx = D.overlay.getContext('2d', { willReadFrequently:true });
  const freezeCtx = D.freeze.getContext('2d', { willReadFrequently:true });
  const scanCtx = D.scanCanvas.getContext('2d', { willReadFrequently:true });

  if(D.atState){ D.atState.textContent = 'AT:OFF'; }

  const CFG = { JSQR_MAX_LOOPS: 10 };
  const S = {
    stream: null, rafId: null,
    useBarcodeDetector: ('BarcodeDetector' in window), detector: null,
    csrf: '', locked: false,
    current: { book:'', wc:'' }, lastQueryKey:''
  };

  function readCookie(name){
    const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')+'=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : '';
  }
  function esc(s){ return String(s??'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function dieKey(bn,wc){ return (bn||'').toLowerCase()+'@@'+(wc||'').toLowerCase(); }
  function normHyphen(s){ return (s||'').replace(/[â€-â€’â€“â€”â€•ãƒ¼âˆ’]/g,'-').trim(); }

  // --- CSRFï¼ˆUIã¯æœ€å°ã ãŒã€/api ã‚’å©ãã®ã§ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§æœ‰åŠ¹åŒ–ï¼‰
  function isLocal(){ return location.protocol==='http:' && /localhost|127\.0\.0\.1/.test(location.host); }
  async function requestSession(){ const url=isLocal()?'/api/session?dev=1':'/api/session'; await fetch(url,{method:'GET',credentials:'same-origin',cache:'no-store'}).catch(()=>{}); }
  async function ensureCsrf(){
    let t = readCookie('xcsrf');
    if(!t){ await requestSession(); t = readCookie('xcsrf'); }
    if(!t) throw new Error('CSRF Cookie(xcsrf)ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
    S.csrf = t;
    D.csrfStatus.textContent = 'CSRF: æœ‰åŠ¹';
    D.csrfStatus.className = 'chip ok';
  }
  document.addEventListener('DOMContentLoaded', async () => {
    try{ await ensureCsrf(); }catch(e){ D.csrfStatus.textContent='CSRF: æœªå–å¾—'; D.csrfStatus.className='chip ng'; }
  });

  // --- UI helpers
  function setStatus(text, kind=''){
    D.scanStatus.textContent = text;
    D.scanStatus.className = 'chip' + (kind==='ok'?' ok':kind==='ng'?' ng':'');
  }
  function fitOverlay(){
    if(!D.video.videoWidth) return;
    D.overlay.width=D.video.videoWidth; D.overlay.height=D.video.videoHeight;
    D.overlay.style.width=D.video.clientWidth+'px'; D.overlay.style.height=D.video.clientHeight+'px';
    D.freeze.width=D.video.videoWidth; D.freeze.height=D.video.videoHeight;
    D.freeze.style.width=D.video.clientWidth+'px'; D.freeze.style.height=D.video.clientHeight+'px';
  }

  // --- ã‚«ãƒ¡ãƒ©
  function reallyStop(){ if(S.stream){ try{ S.stream.getTracks().forEach(t=>t.stop()); }catch{} } S.stream=null; }
  function stopCam({keepFrame=false}={}){
    if(S.rafId) cancelAnimationFrame(S.rafId); S.rafId=null;
    if(!keepFrame){
      ctx.clearRect(0,0,D.overlay.width,D.overlay.height);
      D.freeze.style.display='none';
      D.lockEmoji.style.display='none';
      D.video.style.visibility='visible';
    }
    reallyStop();
    D.btnStart.disabled=false; D.btnStop.disabled=true; setStatus('åœæ­¢ä¸­');
  }
  async function startCam(){
    // çµæœãƒ‘ãƒãƒ«ã¯ç¶­æŒï¼ˆå¿…è¦ãªæƒ…å ±ã ã‘ä¸Šã«å¸¸ã«è¦‹ã›ã‚‹ï¼‰
    D.freeze.style.display='none'; D.video.style.visibility='visible'; D.lockEmoji.style.display='none';
    S.locked=false; stopCam();
    D.errCam.textContent='';
    try{
      S.stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:{ideal:'environment'}, width:{ideal:1280,min:640,max:1920}, height:{ideal:720,min:480,max:1080}, advanced:[{focusMode:'continuous'}] },
        audio:false
      });
      D.video.srcObject=S.stream; await D.video.play();
      D.btnStart.disabled=true; D.btnStop.disabled=false;
      fitOverlay();
      // è»½é‡ã‚¹ã‚­ãƒ£ãƒ³ç”¨ã®åŸºæº–ã‚µã‚¤ã‚º
      const vw=D.video.videoWidth||1280, vh=D.video.videoHeight||720;
      const baseW=600, baseH=Math.round(baseW*(vh/vw));
      D.scanCanvas.width=baseW; D.scanCanvas.height=baseH;

      if(S.useBarcodeDetector){
        try{
          const fmts=(typeof BarcodeDetector.getSupportedFormats==='function')?await BarcodeDetector.getSupportedFormats():[];
          if(!fmts || !fmts.includes('qr_code')) throw 0;
          S.detector=new BarcodeDetector({formats:['qr_code']});
        }catch{ S.useBarcodeDetector=false; S.detector=null; }
      }
      D.detectorInfo.textContent = S.useBarcodeDetector ? 'BarcodeDetector' : 'jsQR';
      setStatus('æ¢ç´¢ä¸­â€¦'); tick();
    }catch(e){
      D.errCam.textContent=`âŒ ${e.name||''} ${e.message||e}`;
      setStatus('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼','ng');
    }
  }
  function freezeAndLock(){
    try{
      fitOverlay();
      freezeCtx.clearRect(0,0,D.freeze.width,D.freeze.height);
      freezeCtx.drawImage(D.video,0,0,D.freeze.width,D.freeze.height);
      D.freeze.style.display='block'; D.video.style.visibility='hidden';
      D.lockEmoji.style.display='block';
      ctx.clearRect(0,0,D.overlay.width,D.overlay.height);
    }catch{}
    setStatus('ãƒ­ãƒƒã‚¯å®Œäº†','ok');
    stopCam({keepFrame:true});
  }

  // --- ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆè»½é‡ï¼‰
  function scanSimple(){
    if (D.video.readyState !== D.video.HAVE_ENOUGH_DATA) return null;
    scanCtx.drawImage(D.video, 0, 0, D.scanCanvas.width, D.scanCanvas.height);
    const img = scanCtx.getImageData(0, 0, D.scanCanvas.width, D.scanCanvas.height);
    const hit = jsQR(img.data, img.width, img.height, { inversionAttempts: 'attemptBoth' });
    if (!hit) return null;
    // overlayåº§æ¨™ã¸å¤‰æ›
    const sx = D.overlay.width / D.scanCanvas.width;
    const sy = D.overlay.height/ D.scanCanvas.height;
    const pts = [
      hit.location.topLeftCorner, hit.location.topRightCorner,
      hit.location.bottomRightCorner, hit.location.bottomLeftCorner
    ].map(p=>({x:p.x*sx,y:p.y*sy}));
    return { rawValue: hit.data.trim(), cornerPoints: pts };
  }
  function drawBox(points){
    if(!points || points.length<4) return;
    ctx.save(); ctx.lineWidth=5; ctx.strokeStyle='#1c7ed6'; ctx.shadowColor='#1c7ed6'; ctx.shadowBlur=6;
    ctx.beginPath(); ctx.moveTo(points[0].x,points[0].y); for(let i=1;i<points.length;i++) ctx.lineTo(points[i].x,points[i].y); ctx.closePath(); ctx.stroke(); ctx.restore();
  }
  function classify(raw){
    const t=normHyphen(raw);
    if(/^order[_-]?plain/i.test(t) || /^order-/i.test(t)) return 'order';
    if(/^die-/i.test(t)) return 'die';
    try{
      const u=new URL(t);
      if(/order[_-]?plain/i.test(u.pathname+u.search)) return 'order';
      if(u.searchParams.has('book') || u.searchParams.has('wc')) return 'die';
    }catch{}
    return 'other';
  }
  function parseOrder(raw){
    const t=normHyphen(raw);
    try{
      const u=new URL(t);
      if(/order[_-]?plain/i.test(u.pathname+u.search)){
        const book=(u.searchParams.get('book')||u.searchParams.get('Book')||'').trim();
        const wc  =(u.searchParams.get('wc')||u.searchParams.get('WorkCord')||'').trim();
        if(book||wc) return { bn:book, wc:wc };
      }
    }catch{}
    const m=/order[_-]?plain[:\s-]+([^\s/:-]+)[\s/:-]+([^\s/:-]+)/i.exec(t) || /^order-([^-\n]+)-([^-]+)/i.exec(t);
    return m ? { bn:m[1].trim(), wc:m[2].trim() } : null;
  }
  function parseDie(raw){
    const t=normHyphen(raw);
    const m=/^die-([^-\n]+)-([^-]+)/i.exec(t);
    if(m) return { bn:m[1].trim(), wc:m[2].trim() };
    try{
      const u=new URL(t);
      const book=(u.searchParams.get('book')||'').trim();
      const wc  =(u.searchParams.get('wc')||'').trim();
      if(book||wc) return { bn:book, wc:wc };
    }catch{}
    return null;
  }

  async function tick(){
    if(!S.stream) return;
    if(D.video.readyState === D.video.HAVE_ENOUGH_DATA){
      fitOverlay();
      ctx.clearRect(0,0,D.overlay.width,D.overlay.height);
      const hit=scanSimple();
      if(hit){
        drawBox(hit.cornerPoints);
        const kind=classify(hit.rawValue);
        let bn='', wc='';
        if(kind==='order'){ const od=parseOrder(hit.rawValue); if(od){ bn=od.bn||''; wc=od.wc||''; } }
        else if(kind==='die'){ const d=parseDie(hit.rawValue); if(d){ bn=d.bn||''; wc=d.wc||''; } }
        if(bn || wc){
          setTarget(bn,wc);
          S.locked=true; freezeAndLock(); S.lastQueryKey=''; querySpec();
          return;
        }
      }
    }
    S.rafId = requestAnimationFrame(tick);
  }

  function setTarget(book,wc){
    S.current.book=(book||'').trim();
    S.current.wc=(wc||'').trim();
    D.nowTarget.textContent = `ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${S.current.book||'â€”'} / ${S.current.wc||'â€”'}`;

    // ãƒ•ã‚©ãƒ¼ãƒ å´ã«ã‚‚åæ˜ 
    if(D.inpBook){
      D.inpBook.value = S.current.book || '';
    }
    if(D.inpWc){
      D.inpWc.value = S.current.wc || '';
    }
  }

  // --- API: GSheets ä»•æ§˜ã‚’å–å¾— â†’ è¡¨ç¤º â†’ Drive å›³é¢ã‚‚ç¶šã‘ã¦æç”»
  async function querySpec(){
    const book=S.current.book, wc=S.current.wc; if(!book || !wc) return;
    const key=dieKey(book,wc); if(key===S.lastQueryKey) return; S.lastQueryKey=key;

    D.errApi.style.display='none'; D.errApi.textContent=''; D.loading.style.display='inline';
    // å…ˆã«æ—¢å­˜ã®è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
    D.gsBox.innerHTML = `<div class="muted">å–å¾—ä¸­â€¦</div>`;
    D.driveStatus.textContent = 'â€”';
    D.driveView.innerHTML = '';

    try{
      if(!S.csrf){ await ensureCsrf(); }
      const r = await fetch('/api/die-check', {
        method:'POST', credentials:'same-origin',
        headers:{ 'Content-Type':'application/json', 'X-CSRF': S.csrf },
        body: JSON.stringify({ book, wc, json:true, limit: 0, noAirtable: true, gsOnly: true })
      });
      const txt=await r.text(); let j={};
      try{ j=JSON.parse(txt); }catch{ throw new Error(`JSON Parse error: ${txt.slice(0,200)}`); }
      if(!r.ok || j.ok!==true){ throw new Error(j?.error || `HTTP ${r.status}: ${txt.slice(0,200)}`); }
      renderSpecAndDrive(j);
    }catch(e){
      D.errApi.style.display='block'; D.errApi.textContent=`âŒ APIã‚¨ãƒ©ãƒ¼: ${e?.message||e}`;
      D.gsBox.innerHTML = `<div class="muted">ï¼ˆGoogle Sheets ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰</div>`;
    }finally{
      D.loading.style.display='none';
    }
  }

  function renderSpecAndDrive(payload){
    const { gs, book, workcord } = payload || {};
    // ä»•æ§˜
    if(gs){
      D.gsBox.innerHTML = `
        <div class="kvs">
          <b>ItemName</b><div>${esc(gs.ItemName||'')}</div>
          <b>Kname</b><div>${esc(gs.Kname||'')}</div>
          <b>Material</b><div>${esc(gs.Material||'')}</div>
          <b>Paper_Size</b><div>${esc(gs.Paper_Size||'')}</div>
          <b>Cut_Size</b><div>${esc(gs.Cut_Size||'')}</div>
          <b>Location</b><div>${esc(gs.Location||'')}</div>
          <b>LastSeen</b><div>${esc(gs.LastSeen||'')}</div>
          <b>Ndate</b><div>${esc(gs.Ndate||'')}</div>
        </div>`;
    }else{
      D.gsBox.innerHTML = `<div class="muted">ï¼ˆGoogle Sheets ã«ä¸€è‡´è¡Œãªã—ï¼‰</div>`;
    }

    // å›³é¢ï¼ˆDrive ã‚’è‡ªå‹•ã§ä¸Šæ®µå³å†…ã«åŸ‹ã‚è¾¼ã¿è¡¨ç¤ºï¼‰
    const b = (book||'').trim();
    const w = (workcord||'').trim();
    openDriveFigure(b, w);
  }

  async function openDriveFigure(book, wc){
    if(!book || !wc){
      D.driveStatus.textContent = 'Book/WC æœªæŒ‡å®š';
      D.driveView.innerHTML = '';
      return;
    }
    D.driveStatus.textContent = 'æ¤œç´¢ä¸­â€¦';
    D.driveView.innerHTML = '';

    try{
      const r = await fetch(`/api/drive-find?book=${encodeURIComponent(book)}&wc=${encodeURIComponent(wc)}`, { credentials:'same-origin', cache:'no-store' });
      if(!r.ok){ const t=await r.text().catch(()=> ''); throw new Error(`drive-find HTTP ${r.status}: ${t.slice(0,200)}`); }
      const j = await r.json().catch(()=> ({}));
      if(j?.ok !== true){
        D.driveStatus.textContent = 'NG: å¿œç­”ä¸æ­£';
        return;
      }
      const cands = Array.isArray(j.candidates) && j.candidates.length
        ? j.candidates
        : (j.fileId ? [{ id: j.fileId, name: j.fileName || `${book}-${wc}` }] : []);

      if(cands.length===0){
        D.driveStatus.textContent = 'ä¸€è‡´ãƒ•ã‚¡ã‚¤ãƒ«ãªã—';
        D.driveView.innerHTML = '';
        return;
      }

      // å„ªå…ˆï¼š-zuç”»åƒ > -siç”»åƒ > ç”»åƒ > PDF
      const score = fn => {
        const n = (fn?.name||'').toLowerCase();
        const isPdf = n.endsWith('.pdf');
        const isImg = /\.(jpeg|jpg|png)$/.test(n);
        const hasZu = /-zu\.(jpeg|jpg|png)$/.test(n);
        const hasSi = /-si\.(jpeg|jpg|png)$/.test(n);
        if(isImg && hasZu) return 1;
        if(isImg && hasSi) return 2;
        if(isImg)          return 3;
        if(isPdf)          return 9;
        return 99;
      };
      cands.sort((a,b)=> score(a)-score(b));
      const primary=cands[0];
      const isPdf=(primary.name||'').toLowerCase().endsWith('.pdf');
      const src=`/api/drive-proxy?id=${encodeURIComponent(primary.id)}&name=${encodeURIComponent(primary.name||`${book}-${wc}`)}`;

      if(isPdf){
        D.driveView.innerHTML = `<iframe src="${src}" style="width:100%;height:62vh;border:1px solid #e9ecef;border-radius:10px"></iframe>`;
      }else{
        D.driveView.innerHTML = `<img src="${src}" alt="${esc(primary.name||'figure')}" style="max-width:100%;height:auto;border:1px solid #e9ecef;border-radius:10px;background:#fff" />`;
      }
      D.driveStatus.textContent = `ãƒ’ãƒƒãƒˆ: ${cands.length}ï¼ˆè¡¨ç¤º: ${primary.name||'-'}ï¼‰`;
    }catch(e){
      console.error(e);
      D.driveStatus.textContent = `NG: ${e?.message||e}`;
      D.driveView.innerHTML = '';
    }
  }

  // --- ã‚¤ãƒ™ãƒ³ãƒˆ
  D.btnStart.addEventListener('click', startCam);
  D.btnStop.addEventListener('click', () => stopCam());
  window.addEventListener('resize', fitOverlay);

  // â˜… æ‰‹å…¥åŠ›ã‹ã‚‰ã®ç…§ä¼šã‚¤ãƒ™ãƒ³ãƒˆ
  if(D.btnManual){
    D.btnManual.addEventListener('click', () => {
      const b = (D.inpBook?.value||'').trim();
      const w = normHyphen((D.inpWc?.value||'').trim());
      if(!b || !w){
        D.errApi.style.display='block';
        D.errApi.textContent = 'â— Book ã¨ wc ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚';
        return;
      }
      D.errApi.style.display='none';
      D.errApi.textContent='';
      setTarget(b,w);
      S.locked=false;       // æ‰‹å…¥åŠ›ãªã®ã§ãƒ­ãƒƒã‚¯ã¯ç‰¹ã«ä½¿ã‚ãªã„
      S.lastQueryKey='';    // åŒã˜çµ„ã¿åˆã‚ã›ã§ã‚‚å†ç…§ä¼šã§ãã‚‹ã‚ˆã†ã«ãƒªã‚»ãƒƒãƒˆ
      querySpec();
    });

    if(D.inpWc){
      D.inpWc.addEventListener('keydown', (e) => {
        if(e.key === 'Enter'){
          e.preventDefault();
          D.btnManual.click();
        }
      });
    }
  }

})();
</script>
</body>
</html>
