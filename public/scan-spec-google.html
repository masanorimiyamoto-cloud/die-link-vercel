<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>scan-specÔΩúSmart View</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<style>
  :root {
    --primary: #228be6; /* Èùí */
    --primary-bg: #e7f5ff;
    --text: #343a40;
    --text-sub: #868e96;
    --bg: #f1f3f5;
    --card-bg: #ffffff;
    --border: #dee2e6;
    --ok: #12b886; /* Á∑ë */
    --ng: #fa5252; /* Ëµ§ */
    --info:#f59f00; /* „Ç™„É¨„É≥„Ç∏ */
  }

  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding-bottom: 40px;
  }

  .wrap {
    max-width: 1000px;
    margin: 0 auto;
    padding: 16px;
  }

  /* --- Header / Controls --- */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--card-bg);
    padding: 12px 16px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    margin-bottom: 16px;
    position: sticky;
    top: 8px;
    z-index: 100;
  }
  .top-controls { display: flex; gap: 10px; }

  .status-indicator {
    font-size: 12px;
    font-weight: bold;
    padding: 4px 10px;
    border-radius: 20px;
    background: #eee;
    color: #777;
  }
  .status-indicator.active { background: var(--primary-bg); color: var(--primary); }

  /* --- Grid Layout --- */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    align-items: start;
  }
  @media (max-width: 768px) {
    .main-grid { grid-template-columns: 1fr; }
  }

  /* --- Cards --- */
  .card {
    background: var(--card-bg);
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    overflow: hidden;
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
  }
  .card-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: #f8f9fa;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .card-header h2 {
    margin: 0;
    font-size: 15px;
    font-weight: 700;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .card-body {
    padding: 16px;
  }

  /* --- Camera Area --- */
  .stack {
    position: relative;
    background: #000;
    border-radius: 8px;
    overflow: hidden;
    aspect-ratio: 16/9;
  }
  video { width: 100%; height: 100%; object-fit: cover; display: block; }
  canvas { position: absolute; inset: 0; width: 100%; height: 100%; pointer-events: none; }
  #freeze, #lockEmoji { display: none; }

  .lockmark { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; pointer-events: none; }
  .lockmark .em { font-size: 60px; text-shadow: 0 4px 12px rgba(0,0,0,0.5); }

  /* ‚òÖ „Ç¨„Ç§„ÉâÔºàlookupÈ¢®ÔºâÔºö‰∏≠Â§Æ200px */
  .target-scope{
    position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    width:200px; height:200px;
    border:2px solid rgba(34,139,230,.85);
    border-radius:12px;
    pointer-events:none;
    z-index:10;
    box-shadow:0 0 0 9999px rgba(0,0,0,.28);
  }
  .target-scope .scan-line{
    position:absolute; left:0; top:0; width:100%; height:2px;
    background:linear-gradient(90deg,transparent,rgba(34,139,230,.8),transparent);
    animation:scan 2s linear infinite;
  }
  @keyframes scan{0%{top:0}100%{top:100%}}

  .target-info {
    margin-top: 10px;
    padding: 8px 12px;
    background: var(--primary-bg);
    color: var(--primary);
    border-radius: 8px;
    font-weight: bold;
    text-align: center;
    font-size: 14px;
  }

  /* --- Manual Input --- */
  .manual-area {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px dashed var(--border);
    display: flex;
    gap: 8px;
    align-items: center;
  }
  .inp-group { display: flex; flex-direction: column; gap: 4px; flex: 1; }
  .inp-group label { font-size: 11px; color: var(--text-sub); font-weight: bold; }
  .inp-control {
    padding: 8px 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    width: 100%;
    background: #fff;
  }
  .inp-control:focus { outline: 2px solid var(--primary-bg); border-color: var(--primary); }

  /* --- Specs (Google Sheets) --- */
  .spec-table {
    display: grid;
    grid-template-columns: 100px 1fr;
    font-size: 14px;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }
  .spec-row { display: contents; }
  .spec-label {
    background: #f8f9fa;
    padding: 8px 12px;
    color: var(--text-sub);
    font-weight: 600;
    border-bottom: 1px solid var(--border);
    display: flex; align-items: center;
  }
  .spec-val {
    padding: 8px 12px;
    border-bottom: 1px solid var(--border);
    font-weight: 500;
    word-break: break-all;
  }
  .spec-row:last-child .spec-label,
  .spec-row:last-child .spec-val { border-bottom: none; }

  /* --- Files (Google Drive) --- */
  .drive-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 12px;
  }
  .drive-btn {
    text-decoration: none;
    background: #fff;
    border: 1px solid var(--border);
    color: var(--text);
    padding: 8px 12px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    transition: all 0.2s;
    flex: 1;
    justify-content: center;
    white-space: nowrap;
  }
  .drive-btn:hover { background: #f8f9fa; border-color: #adb5bd; }
  .drive-btn.primary-btn { background: var(--primary); color: #fff; border-color: var(--primary); }
  .drive-btn.primary-btn:hover { opacity: 0.9; }

  .fig-container { display: flex; flex-direction: column; gap: 16px; }
  .msg-empty { text-align: center; padding: 20px; color: var(--text-sub); font-size: 13px; }

  /* --- Buttons --- */
  .btn {
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn-primary { background: var(--primary); color: #fff; }
  .btn-primary:hover { background: #1c7ed6; }
  .btn-sub { background: #fff; border: 1px solid var(--border); color: var(--text); }
  .btn-sub:disabled { background: #f1f3f5; color: #adb5bd; cursor: not-allowed; }
</style>
</head>
<body>

<div class="wrap">
  <div class="topbar">
    <div class="top-controls">
      <button id="btnStart" class="btn btn-primary">„Ç´„É°„É©ÈñãÂßã</button>
      <button id="btnStop" class="btn btn-sub" disabled>ÂÅúÊ≠¢</button>
    </div>
    <div id="scanStatus" class="status-indicator">ÂæÖÊ©ü‰∏≠</div>
  </div>

  <div class="main-grid">
    <div class="card">
      <div class="card-header">
        <h2>üì∑ „Çπ„Ç≠„É£„É≥</h2>
        <span id="detectorInfo" style="font-size:11px; color:#aaa">jsQR</span>
      </div>
      <div class="card-body">
        <div class="stack" id="stack">
          <video id="video" playsinline webkit-playsinline muted></video>
          <canvas id="freeze"></canvas>
          <canvas id="overlay"></canvas>
          <div class="lockmark"><div class="em" id="lockEmoji">üîí</div></div>
          <canvas id="scanCanvas" style="display:none"></canvas>
          <div class="target-scope"><div class="scan-line"></div></div>
        </div>

        <div id="nowTarget" class="target-info">„Çø„Éº„Ç≤„ÉÉ„Éà: ‚Äî / ‚Äî</div>
        <div id="errCam" style="color:var(--ng); font-size:12px; margin-top:4px;"></div>

        <div class="manual-area">
          <div class="inp-group" style="flex:0 0 80px;">
            <label>Book</label>
            <select id="inpBook" class="inp-control">
              <option value="">-</option>
              <option value="Ko">Ko</option>
              <option value="Yo">Yo</option>
              <option value="Ta">Ta</option>
            </select>
          </div>
          <div class="inp-group">
            <label>WC (‰æã: 1234)</label>
            <input id="inpWc" type="text" inputmode="numeric" class="inp-control" placeholder="WorkCord" />
          </div>
          <button id="btnManual" class="btn btn-sub" style="align-self:flex-end; height:38px;">ÁÖß‰ºö</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>üìÑ ÁµêÊûú</h2>
        <span id="loading" style="font-size:12px; color:var(--primary); display:none;">ÁÖß‰ºö‰∏≠...</span>
      </div>

      <div class="card-body">
        <h3 style="font-size:14px; margin:0 0 8px; color:var(--text-sub);">Âü∫Êú¨„Çπ„Éö„ÉÉ„ÇØ (Google Sheets)</h3>
        <div id="gsBox"><div class="msg-empty">„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì</div></div>
        <div id="errApi" style="color:var(--ng); font-size:12px; margin-top:6px;"></div>

        <div style="margin-top:24px; border-top:1px solid var(--border); padding-top:16px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h3 style="font-size:14px; margin:0; color:var(--text-sub);">Èñ¢ÈÄ£„Éï„Ç°„Ç§„É´ (Google Drive)</h3>
            <div id="driveStatus" style="font-size:11px; color:#aaa;"></div>
          </div>

          <div id="driveActions" class="drive-actions"></div>
          <div id="driveView" class="fig-container"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" crossorigin="anonymous"></script>
<script>
(() => {
  const D = {
    video: q('#video'), overlay: q('#overlay'), freeze: q('#freeze'), stack: q('#stack'),
    btnStart: q('#btnStart'), btnStop: q('#btnStop'),
    detectorInfo: q('#detectorInfo'), scanStatus: q('#scanStatus'),
    errCam: q('#errCam'), errApi: q('#errApi'), loading: q('#loading'),
    lockEmoji: q('#lockEmoji'), scanCanvas: q('#scanCanvas'),
    inpBook: q('#inpBook'), inpWc: q('#inpWc'), btnManual: q('#btnManual'),
    gsBox: q('#gsBox'),
    driveStatus: q('#driveStatus'), driveView: q('#driveView'), driveActions: q('#driveActions'),
    nowTarget: q('#nowTarget'),
  };
  function q(s){ return document.querySelector(s); }

  const ctx = D.overlay.getContext('2d', { willReadFrequently:true });
  const freezeCtx = D.freeze.getContext('2d', { willReadFrequently:true });
  const scanCtx = D.scanCanvas.getContext('2d',{ willReadFrequently:true });

  const CFG = {
    SCAN_EVERY_MS: 80,          // ‚òÖ ÊØé„Éï„É¨„Éº„É†„ÇÑ„Çâ„ÅöÂÆâÂÆöÂåñ(12.5fpsÁ®ãÂ∫¶)
    JSQR_MULTI_MAX: 6,          // ‚òÖ lookupÂºè „Éû„Çπ„ÇØÊ§úÂá∫
    ROI_SCALE: 1.75,            // ‚òÖ ‰∏≠Â§Æ„ÇíÊã°Â§ß„Åó„Å¶ÂÜç„Éà„É©„Ç§ÔºàÂ∞è„Åï„ÅÑQR„Å´Âº∑„ÅèÔºâ
    ROI_FRACTION: 0.62          // ‚òÖ ‰∏≠Â§ÆÂàá„ÇäÂá∫„Åó„Çµ„Ç§„Ç∫
  };

  const S = {
    stream: null, rafId: null,
    useBarcodeDetector: ('BarcodeDetector' in window), detector: null,
    csrf: '', locked: false,
    current: { book:'', wc:'' }, lastQueryKey:'',
    lastScanAt: 0,
  };

  // --- CSRF & Cookie ---
  function readCookie(name){
    const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')+'=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : '';
  }
  async function ensureCsrf(){
    let t = readCookie('xcsrf');
    if(!t){
      const url = (location.protocol==='http:' && /localhost|127\.0\.0\.1/.test(location.host)) ? '/api/session?dev=1' : '/api/session';
      await fetch(url,{method:'GET',credentials:'same-origin',cache:'no-store'}).catch(()=>{});
      t = readCookie('xcsrf');
    }
    if(t) S.csrf = t;
  }
  document.addEventListener('DOMContentLoaded', ensureCsrf);

  // --- Helpers ---
  async function waitVideoSize(timeoutMs = 2500){
    const t0 = performance.now();
    while(performance.now() - t0 < timeoutMs){
      if(D.video.videoWidth > 0 && D.video.videoHeight > 0) return true;
      await new Promise(r => requestAnimationFrame(r));
    }
    return false;
  }
  function esc(s){ return String(s??'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
  function dieKey(bn,wc){ return (bn||'').toLowerCase()+'@@'+(wc||'').toLowerCase(); }
  function normHyphen(s){ return (s||'').replace(/[‚Äê-‚Äí‚Äì‚Äî‚Äï„Éº‚àí]/g,'-').trim(); }

  function setStatus(text, active=false){
    D.scanStatus.textContent = text;
    if(active) D.scanStatus.classList.add('active');
    else D.scanStatus.classList.remove('active');
  }

  function fitAll(){
    if(!D.video.videoWidth) return;
    const vw = D.video.videoWidth, vh = D.video.videoHeight;
    D.overlay.width = vw; D.overlay.height = vh;
    D.freeze.width  = vw; D.freeze.height  = vh;
    D.scanCanvas.width = vw; D.scanCanvas.height = vh;
  }

  function drawPoly(pts, stroke='#228be6', w=4, dash=null, alpha=1){
    if(!pts || pts.length<4) return;
    ctx.save();
    ctx.globalAlpha = alpha;
    ctx.strokeStyle = stroke;
    ctx.lineWidth = w;
    if(dash) ctx.setLineDash(dash);
    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
    ctx.closePath(); ctx.stroke();
    ctx.restore();
  }

  // ‚òÖ „Ç¨„Ç§„ÉâÂÜÖÂà§ÂÆöÔºàlookup„ÅÆ isDetectionInScope Áõ∏ÂΩìÔºâ
  function inScope(cornerPoints){
    if(!cornerPoints || cornerPoints.length<4) return true;
    const stackW = D.stack.clientWidth, stackH = D.stack.clientHeight;
    if(!stackW || !stackH) return true;

    const scopeCssSize = 200;
    const scopeCssX = (stackW/2) - (scopeCssSize/2);
    const scopeCssY = (stackH/2) - (scopeCssSize/2);

    const scaleX = D.overlay.width / stackW;
    const scaleY = D.overlay.height / stackH;

    const scopeX = scopeCssX * scaleX;
    const scopeY = scopeCssY * scaleY;
    const scopeW = scopeCssSize * scaleX;
    const scopeH = scopeCssSize * scaleY;

    const marginX = 14 * scaleX;
    const marginY = 14 * scaleY;

    for(const pt of cornerPoints){
      if(pt.x < scopeX - marginX) return false;
      if(pt.x > scopeX + scopeW + marginX) return false;
      if(pt.y < scopeY - marginY) return false;
      if(pt.y > scopeY + scopeH + marginY) return false;
    }
    return true;
  }

  // --- Camera Control ---
 function stopCam({keepFrame=false}={}){
  if(S.rafId) cancelAnimationFrame(S.rafId);
  S.rafId=null;

  // ‚òÖ video„ÇíÂÆåÂÖ®Ëß£ÊîæÔºà„Åì„Çå„Åå„Å™„ÅÑ„Å®Êé¥„Åø„Å£„Å±„Å™„Åó„Å´„Å™„ÇãÁ´ØÊú´„Åå„ÅÇ„ÇãÔºâ
  try { D.video.pause(); } catch(e){}
  try { D.video.srcObject = null; } catch(e){}

  if(!keepFrame){
    ctx.clearRect(0,0,D.overlay.width,D.overlay.height);
    D.freeze.style.display='none';
    D.lockEmoji.style.display='none';
    D.video.style.visibility='visible';
  }

  if(S.stream){
    try{ S.stream.getTracks().forEach(t=>t.stop()); }catch(e){}
    S.stream=null;
  }

  D.btnStart.disabled=false;
  D.btnStop.disabled=true;
  setStatus('ÂÅúÊ≠¢‰∏≠');
}


  async function setupDetector(){
    S.useBarcodeDetector = ('BarcodeDetector' in window);
    S.detector = null;
    if(!S.useBarcodeDetector) return;
    try{
      const fmts = (typeof BarcodeDetector.getSupportedFormats==='function')
        ? await BarcodeDetector.getSupportedFormats()
        : [];
      if(fmts && fmts.includes('qr_code')){
        S.detector = new BarcodeDetector({formats:['qr_code']});
      }else{
        // SafariÁ≠â„Åß getSupportedFormats „ÅåÁÑ°„ÅÑ/Á©∫„Åß„ÇÇ„ÄÅtry „Å†„Åë„ÅØ„Åô„Çã
        S.detector = new BarcodeDetector({formats:['qr_code']});
      }
    }catch{
      S.useBarcodeDetector = false;
      S.detector = null;
    }
  }

  async function startCam(){
  // ‚òÖ ÈùûHTTPS„Å†„Å®„Ç´„É°„É©‰∏çÂèØÔºàÂøµ„ÅÆ„Åü„ÇÅÔºâ
  if(!window.isSecureContext){
    D.errCam.textContent = '„Åì„ÅÆ„Éö„Éº„Ç∏„ÅåHTTPS„Åß„ÅØ„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Ç´„É°„É©„ÇíËµ∑Âãï„Åß„Åç„Åæ„Åõ„Çì„ÄÇ';
    setStatus('„Ç®„É©„Éº');
    return;
  }

  // ‚òÖ prerender/ÈùûË°®Á§∫‰∏≠„ÅØ NotAllowedError „Å´„Å™„Çä„ÇÑ„Åô„ÅÑ„ÅÆ„Åß„Éñ„É≠„ÉÉ„ÇØ
  if(document.prerendering || document.visibilityState !== 'visible'){
    D.errCam.textContent = '„Éö„Éº„Ç∏„ÅåÈùûË°®Á§∫/ÂÖàË™≠„ÅøÁä∂ÊÖã„ÅÆ„Åü„ÇÅËµ∑Âãï„Åß„Åç„Åæ„Åõ„Çì„ÄÇÁîªÈù¢„ÇíË°®Á§∫„Åó„Å¶„Åã„Çâ„ÇÇ„ÅÜ‰∏ÄÂ∫¶Êäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ';
    setStatus('ÂæÖÊ©ü‰∏≠');
    return;
  }

  // ÂàùÊúüÂåñ
  S.locked=false;
  stopCam(); // Êó¢Â≠òÂÅúÊ≠¢ÔºàÂÆåÂÖ®Ëß£ÊîæÔºâ
  D.errCam.textContent='';
  D.freeze.style.display='none';
  D.video.style.visibility='visible';
  D.lockEmoji.style.display='none';

  // ‚òÖ „Åæ„Åö„ÅØÂº∑„ÇÅÂà∂Á¥Ñ ‚Üí „ÉÄ„É°„Å™„ÇâÂº±„ÇÅÂà∂Á¥Ñ„ÅßÂÜç„Éà„É©„Ç§
  const constraintsStrong = {
    video: {
      facingMode: { ideal: 'environment' },
      width:  { ideal: 1280 },
      height: { ideal: 720 },
      frameRate: { ideal: 30 }
    },
    audio: false
  };
  const constraintsWeak = {
    video: { facingMode: { ideal: 'environment' } },
    audio: false
  };

  try{
    // 1st try
    try{
      S.stream = await navigator.mediaDevices.getUserMedia(constraintsStrong);
    }catch(e1){
      // 2nd tryÔºàÂà∂Á¥Ñ„ÇíÁ∑©„ÇÅ„ÇãÔºâ
      S.stream = await navigator.mediaDevices.getUserMedia(constraintsWeak);
    }

    D.video.srcObject = S.stream;

    // ‚òÖ play() „ÇÇÂ§±Êïó„Åô„ÇãÁ´ØÊú´„Åå„ÅÇ„Çã„ÅÆ„Åß catch
    try{ await D.video.play(); }catch(e){ /* ÁÑ°Ë¶ñ */ }

    const ok = await waitVideoSize();
    if(!ok) throw new Error('„Ç´„É°„É©Ëß£ÂÉèÂ∫¶„ÅåÁ¢∫ÂÆö„Åó„Åæ„Åõ„Çì„Åß„Åó„Åü');

    fitAll();

    await setupDetector();
    D.detectorInfo.textContent = (S.useBarcodeDetector && S.detector) ? 'BD+jsQR' : 'jsQR';

    D.btnStart.disabled=true;
    D.btnStop.disabled=false;

    S.lastScanAt = 0;
    setStatus('„Çπ„Ç≠„É£„É≥‰∏≠', true);
    tick();

  }catch(e){
    console.error(e);

    // ‚òÖ „Ç®„É©„ÉºÂá∫„ÅóÂàÜ„ÅëÔºà„É¶„Éº„Ç∂„Éº„ÅåÊ¨°„Å´‰Ωï„Çí„Åô„Åπ„Åç„ÅãÂàÜ„Åã„ÇãÔºâ
    const name = e?.name || '';
    let hint = '';
    if(name === 'NotAllowedError'){
      hint = 'ÔºàÊ®©Èôê„Éñ„É≠„ÉÉ„ÇØ/ÈùûË°®Á§∫Áä∂ÊÖã/ÂÖàË™≠„Åø/Âüã„ÇÅËæº„ÅøÁ≠â„ÅßÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü„ÄÇÂà•„Çø„Éñ„ÇÇÂê´„ÇÅÂêå„Çµ„Ç§„Éà„ÇíÈñâ„Åò„Å¶Chrome„ÇíÂÜçËµ∑Âãï‚ÜíÂÜçË©¶Ë°åÔºâ';
    }else if(name === 'NotReadableError'){
      hint = 'Ôºà‰ªñ„Ç¢„Éó„É™/‰ªñ„Çø„Éñ„Åå„Ç´„É°„É©„Çí‰ΩøÁî®‰∏≠„ÅÆÂèØËÉΩÊÄß„ÄÇ„Ç´„É°„É©Á≥ª„Ç¢„Éó„É™„ÇíÁµÇ‰∫Ü„Åó„Å¶ÂÜçË©¶Ë°åÔºâ';
    }else if(name === 'OverconstrainedError'){
      hint = 'Ôºà„Ç´„É°„É©Âà∂Á¥Ñ„ÅåÂêà„ÅÑ„Åæ„Åõ„Çì„ÄÇÁ´ØÊú´‰æùÂ≠ò„Åß„Åô„ÄÇÂº±„ÇÅÂà∂Á¥Ñ„ÅßÂÜçË©¶Ë°å„Åó„Åæ„ÅôÔºâ';
    }

    D.errCam.textContent = `„Ç´„É°„É©Ëµ∑Âãï„Ç®„É©„Éº: ${name} ${e.message||e} ${hint}`;
    setStatus('„Ç®„É©„Éº');
    stopCam(); // ‚òÖ Â§±ÊïóÊôÇ„ÇÇËß£Êîæ
  }
}


  function freezeAndLock(){
    fitAll();
    freezeCtx.drawImage(D.video,0,0,D.freeze.width,D.freeze.height);
    D.freeze.style.display='block';
    D.video.style.visibility='hidden';
    D.lockEmoji.style.display='block';
    ctx.clearRect(0,0,D.overlay.width,D.overlay.height);
    stopCam({keepFrame:true});
    setStatus('„É≠„ÉÉ„ÇØÂÆå‰∫Ü');
  }

  // --- ParseÔºà‚òÖ„Åì„Åì„ÅåÈáçË¶ÅÔºödie-plain / URL book,wc „ÇíÁ¢∫ÂÆü„Å´Êãæ„ÅÜÔºâ ---
  function extractBookWc(raw){
    const t = normHyphen((raw||'').trim());
    let bn='', wc='';

    // 1) Áõ¥ÊñáÂ≠óÂàó: die-Ko-1234 / order-Ko-1234
    {
      const m = /^(die|order)-([^-\n\/?#]+)-([^-\n\/?#]+)/i.exec(t);
      if(m){ bn=m[2]; wc=m[3]; return {bn, wc}; }
    }

    // 2) URL: ?book=Ko&wc=1234 „Åå„ÅÇ„Çå„Å∞ ‚Äú„Éë„Çπ‰∏çÂïè‚Äù „ÅßÊãæ„ÅÜÔºàdie-plain / order-plain Á≠â„ÇÇOKÔºâ
    try{
      const u = new URL(t);
      bn = (u.searchParams.get('book') || u.searchParams.get('Book') || '').trim();
      wc = (u.searchParams.get('wc')   || u.searchParams.get('WorkCord') || u.searchParams.get('workcord') || '').trim();
      if(bn && wc) return {bn, wc};

      // 3) URL„ÅÆ pathname „Å´ die-Ko-1234 / order-Ko-1234 „ÅåÂÖ•„Å£„Å¶„Çã„Ç±„Éº„Çπ
      const path = u.pathname || '';
      const m2 = /(?:^|\/)(die|order)-([^-\n\/?#]+)-([^-\n\/?#]+)/i.exec(path);
      if(m2){
        bn = m2[2]; wc = m2[3];
        if(bn && wc) return {bn, wc};
      }
    }catch{}

    return null;
  }

  // --- Detection LogicÔºàlookupÂºè„ÅÆ ‚Äú„Éû„Çπ„ÇØË§áÊï∞Ê§úÂá∫‚Äù + ‰∏≠Â§ÆROIÊã°Â§ß„É™„Éà„É©„Ç§Ôºâ ---
  async function detectCombined(){
    if(!D.video.videoWidth) return [];
    const vw = D.video.videoWidth, vh = D.video.videoHeight;
    const w = D.scanCanvas.width, h = D.scanCanvas.height;

    const dets = new Map();

    // 1) BarcodeDetectorÔºàÂèØËÉΩ„Å™„Çâ video Áõ¥„ÇÇË©¶„ÅôÔºâ
    if(S.useBarcodeDetector && S.detector){
      try{
        const codes = await S.detector.detect(D.video);
        for(const c of codes){
          const raw = (c.rawValue||'').trim();
          if(raw && !dets.has(raw)) dets.set(raw, { raw, pts: c.cornerPoints });
        }
      }catch{
        // video Áõ¥„Åå„ÉÄ„É°„Å™„Çâ scanCanvas „Å∏
        try{
          scanCtx.drawImage(D.video, 0, 0, w, h);
          const codes = await S.detector.detect(D.scanCanvas);
          for(const c of codes){
            const raw = (c.rawValue||'').trim();
            if(raw && !dets.has(raw)) dets.set(raw, { raw, pts: c.cornerPoints });
          }
        }catch{
          S.useBarcodeDetector=false; S.detector=null;
        }
      }
    }

    // helper: jsQR multi with mask
    const jsqrMulti = (imgData) => {
      const hits = [];
      const W = imgData.width, H = imgData.height;
      const masked = new Uint8ClampedArray(imgData.data);
      for(let k=0; k<CFG.JSQR_MULTI_MAX; k++){
        const hit = jsQR(masked, W, H, { inversionAttempts:'attemptBoth' }); // ‚òÖ dontInvert„ÇÑ„ÇÅ„Çã
        if(!hit) break;
        hits.push({
          raw: (hit.data||'').trim(),
          pts: [hit.location.topLeftCorner, hit.location.topRightCorner, hit.location.bottomRightCorner, hit.location.bottomLeftCorner]
        });
        const tl = hit.location.topLeftCorner, br = hit.location.bottomRightCorner;
        for(let y=Math.floor(tl.y); y<Math.ceil(br.y); y++){
          for(let x=Math.floor(tl.x); x<Math.ceil(br.x); x++){
            const i = (y*W + x) * 4;
            masked[i]=masked[i+1]=masked[i+2]=255;
          }
        }
      }
      return hits;
    };

    // 2) jsQR: full frame
    scanCtx.drawImage(D.video, 0, 0, w, h);
    let img = scanCtx.getImageData(0,0,w,h);
    for(const h1 of jsqrMulti(img)){
      if(h1.raw && !dets.has(h1.raw)) dets.set(h1.raw, h1);
    }

    // 3) jsQR: ‰∏≠Â§ÆROIÊã°Â§ßÔºàÂ∞è„Åï„ÅÑQR„Å´Âº∑„ÅÑÔºâ
    if(dets.size === 0){
      const frac = CFG.ROI_FRACTION;
      const sw = Math.floor(vw * frac);
      const sh = Math.floor(vh * frac);
      const sx = Math.floor((vw - sw) / 2);
      const sy = Math.floor((vh - sh) / 2);

      // ROI„Çí scanCanvas ÂÖ®Èù¢„Å´Âºï„Åç‰º∏„Å∞„Åó„Å¶Ëß£ÊûêÔºàË¶ã„Åã„Åë„ÅÆQR„Çµ„Ç§„Ç∫„ÅåÂ§ß„Åç„Åè„Å™„ÇãÔºâ
      scanCtx.drawImage(D.video, sx, sy, sw, sh, 0, 0, w, h);
      img = scanCtx.getImageData(0,0,w,h);
      for(const h2 of jsqrMulti(img)){
        if(h2.raw && !dets.has(h2.raw)) dets.set(h2.raw, h2);
      }
    }

    return Array.from(dets.values());
  }

  async function tick(){
    if(!S.stream) return;

    const now = performance.now();
    if(now - S.lastScanAt < CFG.SCAN_EVERY_MS){
      S.rafId = requestAnimationFrame(tick);
      return;
    }
    S.lastScanAt = now;

    if(D.video.readyState === D.video.HAVE_ENOUGH_DATA){
      fitAll();
      ctx.clearRect(0,0,D.overlay.width,D.overlay.height);

      const dets = await detectCombined();

      // ‚òÖ ‰Ωï„ÇÇ„Å™„Åë„Çå„Å∞„Çπ„ÉÜ„Éº„Çø„Çπ„Å†„ÅëÊõ¥Êñ∞
      if(!dets.length){
        setStatus('„Çπ„Ç≠„É£„É≥‰∏≠', true);
        S.rafId = requestAnimationFrame(tick);
        return;
      }

      // „Åæ„Åö ‚ÄúÊ§úÁü•„Åß„Åç„Å¶„ÅÑ„Çã‚Äù „ÅÆÂèØË¶ñÂåñÔºàÂΩ¢Âºè‰∏çÊòé„Åß„ÇÇÊû†„ÇíÂá∫„ÅôÔºâ
      let anyInScope = false;
      for(const d of dets){
        const raw = (d.raw||'').trim(); if(!raw) continue;
        const pts = d.pts || [];
        if(!pts.length) continue;

        // „Ç¨„Ç§„ÉâÂ§ñ„ÅØËñÑ„ÅèËµ§Ôºà„ÄåË™≠„ÇÅ„Å¶„Çã„Åë„Å©Â§ñ„Äç„ÇÇË¶ã„Åà„ÇãÔºâ
        const okScope = inScope(pts);
        anyInScope = anyInScope || okScope;
        drawPoly(pts, okScope ? '#228be6' : '#fa5252', okScope ? 4 : 3, okScope ? null : [8,6], okScope ? 0.85 : 0.35);

        // „Ç¨„Ç§„ÉâÂÜÖ„Åß„ÄÅbook/wc Êäú„Åë„Åü„Çâ„É≠„ÉÉ„ÇØÔºÜÁÖß‰ºö
        if(okScope){
          const p = extractBookWc(raw);
          if(p && p.bn && p.wc){
            setTarget(p.bn, p.wc);
            S.locked=true;
            freezeAndLock();
            querySpec();
            return;
          }
        }
      }

      // ‚ÄúÊ§úÁü•„Åó„Åü„Åë„Å©ÂΩ¢Âºè„ÅåÈÅï„ÅÜ/„Ç¨„Ç§„ÉâÂ§ñ‚Äù „ÇíË°®Á§∫
      if(anyInScope) setStatus(`QRÊ§úÁü•ÔºàÂΩ¢Âºè/ÂÜÖÂÆπ„Åå‰∏ÄËá¥„Åó„Åæ„Åõ„ÇìÔºâ`, true);
      else setStatus(`QRÊ§úÁü•Ôºà„Ç¨„Ç§„ÉâÂ§ñÔºâ`, true);
    }

    S.rafId = requestAnimationFrame(tick);
  }

  function setTarget(bn, wc){
    S.current.book = (bn||'').trim();
    S.current.wc   = (wc||'').trim();
    D.nowTarget.textContent = `„Çø„Éº„Ç≤„ÉÉ„Éà: ${S.current.book} / ${S.current.wc}`;
    D.inpBook.value = S.current.book;
    D.inpWc.value = S.current.wc;
    // ÊâãÂÖ•ÂäõÂæå„Å´„ÇÇÂÜçÁÖß‰ºö„Åß„Åç„Çã„Çà„ÅÜ lastQueryKey „Çí„ÇØ„É™„Ç¢„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ„Åì„Åì„Åß„ÇØ„É™„Ç¢OK
  }

  // --- API & Rendering ---
  async function querySpec(){
    const {book, wc} = S.current;
    if(!book || !wc) return;
    const key = dieKey(book, wc);
    if(key===S.lastQueryKey) return;
    S.lastQueryKey = key;

    D.errApi.textContent='';
    D.loading.style.display='inline';
    D.gsBox.innerHTML = '<div class="msg-empty">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
    D.driveActions.innerHTML = '';
    D.driveView.innerHTML = '';
    D.driveStatus.textContent = '';

    try{
      await ensureCsrf();
      const r = await fetch('/api/die-check', {
        method:'POST',
        headers:{ 'Content-Type':'application/json', ...(S.csrf?{'X-CSRF':S.csrf}:{}) },
        credentials:'same-origin',
        body: JSON.stringify({ book, wc, json:true, limit:0, noAirtable:true, gsOnly:true })
      });
      const j = await r.json();
      if(!j.ok) throw new Error(j.error||'API Error');

      renderSpecs(j.gs);
      await findDriveFiles(book, wc);

    }catch(e){
      D.errApi.textContent = e.message || e;
      D.gsBox.innerHTML = '<div class="msg-empty">ÂèñÂæóÂ§±Êïó</div>';
    }finally{
      D.loading.style.display='none';
    }
  }

  function renderSpecs(gs){
    if(!gs){
      D.gsBox.innerHTML = '<div class="msg-empty">Ë©≤ÂΩì„Éá„Éº„Çø„Å™„Åó</div>';
      return;
    }
    const fields = [
      {k:'ItemName', l:'ÂìÅÂêç'}, {k:'Kname', l:'ÂûãÂêç'},
      {k:'Material', l:'ÊùêË≥™'}, {k:'Paper_Size', l:'ÂéüÁ¥ô'},
      {k:'Cut_Size', l:'Êñ≠Ë£Å'}, {k:'Location', l:'Ê£öÁï™'},
      {k:'LastSeen', l:'Á¢∫Ë™çÊó•'}
    ];
    let html = '<div class="spec-table">';
    fields.forEach(f => {
      const val = gs[f.k] || '-';
      html += `<div class="spec-row"><div class="spec-label">${esc(f.l)}</div><div class="spec-val">${esc(val)}</div></div>`;
    });
    html += '</div>';
    D.gsBox.innerHTML = html;
  }

  async function findDriveFiles(book, wc){
    D.driveStatus.textContent = 'Ê§úÁ¥¢‰∏≠...';
    try{
      const r = await fetch(`/api/drive-find?book=${encodeURIComponent(book)}&wc=${encodeURIComponent(wc)}`,{credentials:'same-origin',cache:'no-store'});
      const j = await r.json();
      if(!j.ok){ D.driveStatus.textContent='Ê§úÁ¥¢„Ç®„É©„Éº'; return; }

      const cands = j.candidates || (j.fileId ? [{id:j.fileId, name:j.fileName}] : []);
      if(!cands.length){
        D.driveStatus.textContent = '„Éï„Ç°„Ç§„É´„Å™„Åó';
        return;
      }

      D.driveStatus.textContent = `${cands.length}‰ª∂„Éí„ÉÉ„Éà`;

      const score = n => {
        n = (n||'').toLowerCase();
        if(/-zu\./.test(n)) return 1;
        if(/-si\./.test(n)) return 2;
        if(n.endsWith('.pdf')) return 3;
        return 9;
      };
      cands.sort((a,b) => score(a.name||'') - score(b.name||''));

      let btnHtml = '';
      cands.forEach(f => {
        const name = f.name || '';
        const isPdf = /\.pdf$/i.test(name);

        let url;
        if (isPdf) url = `https://drive.google.com/file/d/${f.id}/view`;
        else url = `https://drive.google.com/uc?export=view&id=${f.id}`;

        let label = '„Éï„Ç°„Ç§„É´';
        let icon = 'üìÑ';
        let styleClass = 'drive-btn';

        if(/-zu\./i.test(name)) { label = 'Âõ≥Èù¢ (-zu)'; icon='üìê'; styleClass+=' primary-btn'; }
        else if(/-si\./i.test(name)) { label = '„Ç∑„Éº„É´ (-si)'; icon='üè∑Ô∏è'; }
        else if(/\.pdf$/i.test(name)) { label = 'PDF'; icon='üìë'; }

        btnHtml += `<a href="${url}" target="_blank" class="${styleClass}">${icon} ${esc(label)}</a>`;
      });
      D.driveActions.innerHTML = btnHtml;

    }catch(e){
      D.driveStatus.textContent = 'Ê§úÁ¥¢Â§±Êïó';
    }
  }

  // --- Events ---
  D.btnStart.onclick = startCam;
  D.btnStop.onclick = () => stopCam();
  window.onresize = fitAll;
  window.addEventListener('pagehide', () => stopCam());
  document.addEventListener('visibilitychange', () => { if(document.hidden) stopCam(); });

  D.btnManual.onclick = () => {
    const b = D.inpBook.value.trim();
    const w = normHyphen(D.inpWc.value.trim());
    if(!b || !w){ alert('Book„Å®WC„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ'); return; }
    setTarget(b, w);
    S.locked=false; S.lastQueryKey='';
    querySpec();
  };

})();
</script>
</body>
</html>
