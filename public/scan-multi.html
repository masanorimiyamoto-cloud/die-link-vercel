<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>棚を先に固定→型を追加→個別削除→Google Sheets更新</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root { --bd:#ddd; --tx:#222; --sub:#666; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 12px; color: var(--tx); }
  h2 { margin: 6px 0 12px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
  video { width: 360px; max-width: 100%; border:1px solid var(--bd); border-radius:10px; background:#000; }
  canvas { display:none; }
  .panel { flex:1 1 340px; min-width:320px; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px; align-items:center; }
  button, .btn { padding: 9px 12px; border-radius: 10px; border:1px solid var(--bd); background:#fff; cursor:pointer; }
  .muted { color: var(--sub); font-size: 12px; }
  .list { margin-top:8px; }
  .item { border:1px solid var(--bd); border-radius:12px; padding:10px; margin-bottom:10px; }
  .head { font-weight:700; margin-bottom:6px; }
  .kv { font-size: 13px; }
  .sub { color: var(--sub); font-size:12px; }
  .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center; }
  .chip { display:inline-block; padding:3px 8px; border:1px solid var(--bd); border-radius:999px; font-size:12px; }
  .badge { display:inline-block; background:#eef; color:#224; padding:2px 6px; border-radius:4px; font-size:12px; }
  #err { color:#b00020; white-space:pre-wrap; }
  #info { position: fixed; left: 10px; bottom: 10px; background:#fff; border:1px solid var(--bd); padding:6px 8px; border-radius:8px; font-size:12px; }
  .pill { border-radius:999px; }
  .locBox { padding:10px; border:2px solid #0a0; border-radius:12px; background:#f7fff7; }
  .dieBox { padding:10px; border:1px solid #aaa; border-radius:10px; }
  .del { color:#b00; border-color:#f0c; }
</style>
</head>
<body>
  <h2>棚を固定 → 型を追加 → 個別削除 → Google Sheets 更新</h2>

  <div class="row">
    <div class="panel">
      <video id="v" playsinline muted></video>
      <canvas id="c"></canvas>

      <div class="controls">
        <button id="btnStart">カメラ開始</button>
        <button id="btnStop" disabled>停止</button>
        <label class="btn">画像からテスト<input id="fileTest" type="file" accept="image/*" style="display:none"></label>
        <span id="cap" class="badge"></span>
      </div>

      <div class="muted" id="status">準備中…</div>
      <div id="err" class="muted"></div>

      <div class="muted" style="margin-top:8px">
        ・棚QR：<b>loc-LOC-…</b>（プレーン）<br>
        ・型QR：<b>die-BookName-WorkCord</b> または <b>?book=&wc=</b><br>
        ・まず棚を1つ固定 → その後に対象棚の型を次々読み取り → 不要な型は個別削除 → 一括更新
      </div>
    </div>

    <div class="panel">
      <div class="locBox">
        <div><b>固定中の棚（LOC）</b></div>
        <div id="locLabel" class="kv" style="margin:6px 0 8px">（未選択）</div>
        <div class="controls">
          <button id="btnClearLoc" class="pill">棚を解除</button>
        </div>
      </div>

      <div style="margin:12px 0 6px"><b>固定した型（DIE）</b></div>
      <div id="dieList" class="list"></div>

      <div class="controls">
        <button id="btnUpdate" class="pill">確定リンクを Google Sheets に更新</button>
        <button id="btnClearDies" class="pill">型リストを全消去</button>
      </div>
    </div>
  </div>

  <div id="info">w×h: - × - / found: 0</div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" crossorigin="anonymous"></script>
  <script>
  // ========= 設定 =========
  const SHEET_ENDPOINT = "/api/gsheet-seen-bulk";
  const params = new URLSearchParams(location.search);
  const FORCE_LEGACY = params.get("legacy")==="1";
  const SCAN_SCALE = 2;

  // ========= 状態 =========
  let fixedLoc = null; // {loc, raw}
  const fixedDies = new Map(); // key=book-wc -> {bn,wc,raw,addedAt}

  // ========= ユーティリティ =========
  const $ = (q)=>document.querySelector(q);
  const v = $("#v"), c = $("#c"), ctx = c.getContext("2d", { willReadFrequently: true });
  const cap = $("#cap"), statusEl = $("#status"), errEl = $("#err"), info = $("#info");
  function setStatus(t){ statusEl.textContent = t; }
  function setError(t){ errEl.textContent = t || ""; }

  function classify(s){
    if(/^loc-/i.test(s)) return "loc";
    if(/^die-/i.test(s)) return "die";
    try{ const u=new URL(s); if(u.searchParams.get("book")||u.searchParams.get("wc")) return "die"; }catch{}
    return "other";
  }
  function parse(text){
    const m = /^die-([^-\n]+)-(.+)$/.exec(text);
    if(m){ return { bn:m[1].trim(), wc:m[2].trim() }; }
    try{
      const u=new URL(text);
      const book=(u.searchParams.get("book")||"").trim();
      const wc=(u.searchParams.get("wc")||"").trim();
      if(book||wc){ return { bn:book, wc:wc }; }
    }catch{}
    const l=/^loc-(.+)$/i.exec(text);
    if(l){ return { loc:l[1].trim() }; }
    return {};
  }
  const dieKey = (bn,wc)=>`${bn}-${wc}`;

  function renderLoc(){
    $("#locLabel").textContent = fixedLoc ? fixedLoc.loc : "（未選択）";
  }
  function renderDies(){
    const box = $("#dieList");
    const rows = [...fixedDies.values()].map(d=>{
      const key = dieKey(d.bn,d.wc);
      return `<div class="item dieBox" data-key="${key}">
        <div class="head">抜型 <span class="sub">${d.bn}</span> [<b>${d.wc}</b>]</div>
        <div class="actions">
          <button class="btn del" data-del="${key}">この型を削除</button>
          <span class="chip">${d.raw.length>70?d.raw.slice(0,70)+"…":d.raw}</span>
        </div>
      </div>`;
    }).join("") || `<div class="muted">（まだ型はありません）</div>`;
    box.innerHTML = rows;
    box.querySelectorAll("button[data-del]").forEach(b=>{
      b.onclick = ()=>{ fixedDies.delete(b.dataset.del); renderDies(); };
    });
  }

  // ========= 検出系 =========
  let stream=null, rafId=null, detector=null, useBD=('BarcodeDetector' in window) && !FORCE_LEGACY;
  cap.textContent = useBD ? "BarcodeDetector + jsQR" : "jsQR only (legacy)";

  function stopCam(){
    cancelAnimationFrame(rafId); rafId=null;
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    $("#btnStart").disabled=false; $("#btnStop").disabled=true;
    setStatus("停止中");
  }
  function showError(e){ console.error(e); setError(`❌ ${e.name||''} ${e.message||e}`); }

  async function startCam(){
    stopCam(); setError("");
    const idealW = FORCE_LEGACY ? 640 : 1280;
    const idealH = FORCE_LEGACY ? 480 : 720;
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode:{ ideal:'environment' }, width:{ideal:idealW}, height:{ideal:idealH} }, audio:false
      });
    }catch(e){
      showError(e); return;
    }
    v.srcObject=stream;
    try{ await v.play(); }catch(e){ showError(e); return; }
    $("#btnStart").disabled=true; $("#btnStop").disabled=false;
    detector=null; if(useBD){ try{ detector=new BarcodeDetector({ formats:['qr_code'] }); }catch{ useBD=false; detector=null; } }
    tick();
  }

  function jsqrMulti(imgData, w, h, max=10){
    const out=[], data = new Uint8ClampedArray(imgData.data);
    const maskRect = loc=>{
      const xs=[loc.topLeftCorner.x,loc.topRightCorner.x,loc.bottomRightCorner.x,loc.bottomLeftCorner.x];
      const ys=[loc.topLeftCorner.y,loc.topRightCorner.y,loc.bottomRightCorner.y,loc.bottomLeftCorner.y];
      const x0=Math.max(0,Math.min(...xs)|0), x1=Math.min(w,Math.max(...xs)|0);
      const y0=Math.max(0,Math.min(...ys)|0), y1=Math.min(h,Math.max(...ys)|0);
      for(let y=y0;y<y1;y++){ for(let x=x0;x<x1;x++){ const i=(y*w+x)*4; data[i]=data[i+1]=data[i+2]=255; data[i+3]=255; } }
    };
    for(let k=0;k<max;k++){
      const hit = jsQR(data, w, h, { inversionAttempts:'attemptBoth' });
      if(!hit) break;
      out.push(hit); maskRect(hit.location);
    }
    return out;
  }

  async function detectOnce(baseCanvas){
    const ow = baseCanvas.width * SCAN_SCALE;
    const oh = baseCanvas.height * SCAN_SCALE;
    const off = new OffscreenCanvas(ow, oh);
    const octx = off.getContext("2d", { willReadFrequently:true });
    octx.imageSmoothingEnabled=false;
    octx.filter = "contrast(120%) brightness(105%)";
    octx.drawImage(baseCanvas,0,0,ow,oh);

    const found=[];
    if(useBD && detector){
      try{
        const codes=await detector.detect(off);
        for(const b of codes){ found.push(b.rawValue.trim()); }
      }catch{ useBD=false; detector=null; }
    }
    const imgData=octx.getImageData(0,0,ow,oh);
    const hits = jsqrMulti(imgData, ow, oh, 14);
    for(const h of hits){ found.push(h.data.trim()); }
    return [...new Set(found)];
  }

  async function tick(){
    if(!stream) return;
    if(v.videoWidth){
      c.width=v.videoWidth; c.height=v.videoHeight;
      ctx.drawImage(v,0,0,c.width,c.height);

      const raws = await detectOnce(c);
      if(raws.length){
        for(const raw of raws){
          const kind = classify(raw);
          const p = parse(raw);
          if(kind==="loc" && p.loc){
            // ① 棚を固定（上書き）
            if(!fixedLoc || fixedLoc.loc !== p.loc){
              fixedLoc = { loc:p.loc, raw };
              renderLoc();
              setStatus(`棚を固定: ${p.loc}`);
            }
          }else if(kind==="die" && p.bn && p.wc){
            // ② 型を固定（重複しない）
            const key = dieKey(p.bn,p.wc);
            if(!fixedDies.has(key)){
              if(!fixedLoc){ setStatus("先に棚QR（loc-...）を読み取ってください"); continue; }
              fixedDies.set(key, { bn:p.bn, wc:p.wc, raw, addedAt:Date.now() });
              renderDies();
              setStatus(`型を追加: ${p.bn}-${p.wc}`);
            }
          }
        }
      }
      info.textContent = `w×h: ${c.width}×${c.height} / found: ${raws.length}`;
    }
    rafId=requestAnimationFrame(tick);
  }

  // ========= 画像からテスト =========
  $("#fileTest").addEventListener("change", async (ev)=>{
    const f = ev.target.files?.[0]; if(!f) return;
    const img = new Image();
    img.onload = async ()=>{
      c.width = img.width; c.height = img.height;
      ctx.drawImage(img, 0, 0, c.width, c.height);
      const raws = await detectOnce(c);
      for(const raw of raws){
        const kind=classify(raw); const p=parse(raw);
        if(kind==="loc" && p.loc){ fixedLoc={loc:p.loc,raw}; }
        else if(kind==="die" && p.bn && p.wc){ fixedDies.set(dieKey(p.bn,p.wc), {bn:p.bn,wc:p.wc,raw,addedAt:Date.now()}); }
      }
      renderLoc(); renderDies();
      info.textContent = `w×h: ${c.width}×${c.height} / file found: ${raws.length}`;
      ev.target.value="";
    };
    img.src = URL.createObjectURL(f);
  });

  // ========= ボタン =========
  $("#btnStart").addEventListener("click", startCam);
  $("#btnStop").addEventListener("click", stopCam);
  $("#btnClearLoc").addEventListener("click", ()=>{ fixedLoc=null; renderLoc(); });
  $("#btnClearDies").addEventListener("click", ()=>{ fixedDies.clear(); renderDies(); });
  $("#btnUpdate").addEventListener("click", async ()=>{
    if(!fixedLoc){ alert("棚（LOC）が未選択です。先に loc-... を読み取ってください。"); return; }
    if(!fixedDies.size){ alert("型が1件もありません。die-... または ?book=&wc= を読み取ってください。"); return; }

    // LastSeen を YYYY-MM-DD に固定
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth()+1).padStart(2,'0');
    const d = String(now.getDate()).padStart(2,'0');
    const captured_date = `${y}-${m}-${d}`;

    const items = [...fixedDies.values()].map(d=>({
      book: d.bn,
      wc: d.wc,
      wn: "",
      loc: fixedLoc.loc,
      captured_at: captured_date   // ← 日付のみ
    }));
    const msg = items.map(p=>`• ${p.book}-${p.wc} → ${p.loc}`).join("\n");
    if(!confirm(`以下を Google Sheets に反映します。\n\n${msg}\n\n実行しますか？`)) return;
    try{
      const r = await fetch(SHEET_ENDPOINT, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ items })
      });
      if(!r.ok) throw new Error(await r.text());
      const j = await r.json();
      if(!j.ok) throw new Error(JSON.stringify(j));
      alert("Google Sheets を更新しました。");
    }catch(e){ alert("更新に失敗しました: " + (e.message||e)); }
  });

  // ========= 初期 =========
  (async ()=>{ setStatus("棚を先にスキャンしてください（loc-...）"); })();
  </script>
</body>
</html>
