<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>複数QRスキャン → Google Sheets 位置更新（wsTableCD）</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root { --bd:#ddd; --tx:#222; --sub:#666; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 12px; color: var(--tx); }
  h2 { margin: 6px 0 12px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
  video { width: 360px; max-width: 100%; border:1px solid var(--bd); border-radius:10px; background:#000; }
  canvas { display:none; }
  .panel { flex:1 1 340px; min-width:320px; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px; align-items:center; }
  button, .btn { padding: 9px 12px; border-radius: 10px; border:1px solid var(--bd); background:#fff; cursor:pointer; }
  .muted { color: var(--sub); font-size: 12px; }
  .list { margin-top:8px; }
  .item { border:1px solid var(--bd); border-radius:12px; padding:10px; margin-bottom:10px; }
  .head { font-weight:700; margin-bottom:6px; }
  .kv { font-size: 13px; }
  .sub { color: var(--sub); font-size:12px; }
  .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center; }
  .chip { display:inline-block; padding:3px 8px; border:1px solid var(--bd); border-radius:999px; font-size:12px; }
  .badge { display:inline-block; background:#eef; color:#224; padding:2px 6px; border-radius:4px; font-size:12px; }
  #err { color:#b00020; white-space:pre-wrap; }
  #info { position: fixed; left: 10px; bottom: 10px; background:#fff; border:1px solid var(--bd); padding:6px 8px; border-radius:8px; font-size:12px; }
</style>
</head>
<body>
  <h2>複数QRスキャン → Google Sheets 位置更新（wsTableCD）</h2>

  <div class="row">
    <div class="panel">
      <video id="v" playsinline muted></video>
      <canvas id="c"></canvas>

      <div class="controls">
        <button id="btnStart">カメラ開始</button>
        <button id="btnStop" disabled>停止</button>
        <button id="btnClear" style="border-radius:999px">一覧クリア</button>
        <label class="btn">画像からテスト<input id="fileTest" type="file" accept="image/*" style="display:none"></label>
      </div>

      <div class="controls">
        <select id="selDevice"></select>
        <span id="cap" class="badge"></span>
        <span class="muted">※真っ黒時はカメラ切替か <code>?legacy=1</code> をURL末尾に付与</span>
      </div>

      <div class="muted" id="status">準備中…</div>
      <div id="err" class="muted"></div>

      <div class="muted" style="margin-top:8px">
        ・棚QR：プレーン文字 <b>loc-LOC-…</b> / 抜型QR：<b>die-BookName-WorkCord</b> または <b>?book=&wc=</b><br>
        ・1枚の画像に映った QR の中心距離で最近傍の棚を推定→<b>Google Sheets(wsTableCD)</b>へ一括更新
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <button id="btnAssign">検出結果から「最寄り棚」を一括推定 → Google Sheets 更新</button>
      </div>
      <div id="list" class="list"></div>
    </div>
  </div>

  <div id="info">w×h: - × - / found: 0</div>

  <!-- jsQR（フォールバック用） -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" integrity="sha256-0KpQz5M6v9f2PitmT8mH1g2S7T0wj6Q5U8Xy5NIVl9c=" crossorigin="anonymous"></script>

  <script>
  // ============ 設定 ============
  const SHEET_ENDPOINT = "/api/gsheet-seen-bulk"; // ★サーバ側で Google Sheets 更新するAPI

  // ============ ユーティリティ ============
  const $ = (q)=>document.querySelector(q);
  const v = $("#v"), c = $("#c"), ctx = c.getContext("2d", { willReadFrequently: true });
  const selDevice = $("#selDevice"), cap = $("#cap"), statusEl = $("#status"), errEl = $("#err");
  const listEl = $("#list"), info = $("#info");

  const params = new URLSearchParams(location.search);
  const FORCE_LEGACY = params.get("legacy")==="1";

  function setStatus(t){ statusEl.textContent = t; }
  function setError(t){ errEl.textContent = t || ""; }

  function centroid(corners){
    const xs=corners.map(p=>p.x), ys=corners.map(p=>p.y);
    return { x:(Math.min(...xs)+Math.max(...xs))/2, y:(Math.min(...ys)+Math.max(...ys))/2 };
  }
  function classify(raw){
    const s=(raw||"").trim();
    if(/^loc-/i.test(s)) return "loc";
    if(/^die-/i.test(s)) return "die";
    try{ const u=new URL(s); if(u.searchParams.get("book")||u.searchParams.get("wc")) return "die"; }catch{}
    return "other";
  }

  function parseFromQr(text){
    // 1) die-Book-WorkCord
    const m = /^die-([^-\n]+)-(.+)$/.exec(text);
    if(m){ return { src:text, bn:m[1].trim(), wc:m[2].trim(), wn:"" }; }
    // 2) URL ?book=&wc=
    try{
      const u = new URL(text);
      const book=(u.searchParams.get("book")||"").trim();
      const wc=(u.searchParams.get("wc")||"").trim();
      if(book||wc){ return { src:text, bn:book, wc:wc, wn:"" }; }
    }catch{}
    // 3) loc-LOC-...
    const l = /^loc-(.+)$/i.exec(text);
    if(l){ return { src:text, loc:l[1].trim() }; }
    return { src:text };
  }
  function keyOf(row){
    if(row.bn && row.wc) return `die:${row.bn}-${row.wc}`;
    if(row.loc) return `loc:${row.loc}`;
    return row.src;
  }

  // ============ 状態 ============
  const scanned = new Map(); // key → row{bn,wc,wn,loc,_kind,_cx,_cy,src}

  // ============ 表示 ============
  function render(){
    listEl.innerHTML = "";
    for(const [,row] of scanned){
      const el=document.createElement("div");
      el.className="item";
      let lines=[];
      if(row._kind==="die"){
        lines.push(`<div class="head">抜型 <span class="sub">${row.bn || "-"}</span> [<b>${row.wc || "-"}</b>]</div>`);
        lines.push(`<div class="kv">WorkName: ${row.wn || "-"}</div>`);
      }else if(row._kind==="loc"){
        lines.push(`<div class="head">棚 <span class="sub">${row.loc || "-"}</span></div>`);
      }else{
        lines.push(`<div class="head">その他</div>`);
      }
      lines.push(`<div class="actions"><span class="chip">${row.src.length>70?row.src.slice(0,70)+"…":row.src}</span></div>`);
      el.innerHTML = lines.join("");
      listEl.appendChild(el);
    }
  }

  // ============ 近接割当 ============
  function assignNearest(){
    const dies=[], locs=[];
    for(const [,row] of scanned){
      if(row._kind==="die" && row.bn && row.wc && row._cx!=null) dies.push(row);
      if(row._kind==="loc" && row.loc && row._cx!=null) locs.push(row);
    }
    const MAX_NEAR_PX = 500; // 必要に応じて調整
    const pairs=[];
    for(const d of dies){
      let best=null, bestDist=Infinity;
      for(const l of locs){
        const dx=d._cx-l._cx, dy=d._cy-l._cy;
        const dist=Math.hypot(dx,dy);
        if(dist<bestDist){ bestDist=dist; best=l; }
      }
      if(best && bestDist<=MAX_NEAR_PX){
        pairs.push({
          book: d.bn, wc: d.wc, wn: d.wn || "",
          loc: best.loc, dist: Math.round(bestDist),
          captured_at: new Date().toISOString()
        });
      }
    }
    return pairs;
  }

  // ============ カメラ・スキャン ============
  let stream=null, rafId=null, detector=null, useBarcodeDetector=('BarcodeDetector' in window) && !FORCE_LEGACY;
  let currentDeviceId=null;
  cap.textContent = useBarcodeDetector ? "BarcodeDetector + jsQR" : "jsQR only (legacy)";

  async function listCameras(){
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d=>d.kind==='videoinput');
    selDevice.innerHTML="";
    cams.forEach((c,i)=>{
      const opt=document.createElement("option");
      opt.value=c.deviceId; opt.textContent=c.label || `カメラ ${i+1}`;
      selDevice.appendChild(opt);
    });
    if(!currentDeviceId && cams.length){
      currentDeviceId = cams[0].deviceId;
      selDevice.value = currentDeviceId;
    }else if(currentDeviceId){
      const m=[...selDevice.options].find(o=>o.value===currentDeviceId);
      if(m) selDevice.value=currentDeviceId;
    }
  }

  function stopCam(){
    cancelAnimationFrame(rafId); rafId=null;
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    $("#btnStart").disabled=false; $("#btnStop").disabled=true;
    setStatus("停止中");
  }

  function showError(e){
    console.error(e);
    setError(`❌ ${e.name||''} ${e.message||e}`);
    if(e.name==='NotAllowedError') setError(errEl.textContent+'\nWindows/ブラウザのカメラ権限を許可してください。');
    if(e.name==='NotReadableError') setError(errEl.textContent+'\n他アプリ(Teams/Zoom/カメラ)が使用中の可能性。');
  }

  async function startCam(){
    stopCam(); setError("");
    const idealW = FORCE_LEGACY ? 640 : 1280;
    const idealH = FORCE_LEGACY ? 480 : 720;
    const constraints = {
      video: currentDeviceId
        ? { deviceId:{ exact: currentDeviceId }, width:{ideal: idealW}, height:{ideal: idealH} }
        : { facingMode:{ ideal:'environment' }, width:{ideal: idealW}, height:{ideal: idealH} },
      audio:false
    };
    try{
      stream = await navigator.mediaDevices.getUserMedia(constraints);
    }catch(e){
      showError(e);
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video:{ width:640, height:480 }, audio:false });
      }catch(e2){
        showError(e2); setStatus("カメラ起動失敗"); return;
      }
    }
    v.srcObject=stream;
    try{ await v.play(); }catch(e){ showError(e); setStatus("再生失敗"); return; }
    $("#btnStart").disabled=true; $("#btnStop").disabled=false;
    await listCameras(); setStatus("スキャン中…");

    detector=null;
    if(useBarcodeDetector){
      try{ detector=new BarcodeDetector({ formats:['qr_code'] }); }catch{ useBarcodeDetector=false; detector=null; }
    }
    tick();
  }

  function drawBoxes(boxes, color='rgba(0,255,0,0.8)'){
    ctx.strokeStyle=color; ctx.lineWidth=3;
    for(const b of boxes){ ctx.beginPath(); ctx.moveTo(b[0].x,b[0].y); for(let i=1;i<b.length;i++) ctx.lineTo(b[i].x,b[i].y); ctx.closePath(); ctx.stroke(); }
  }

  function handleFound(found){
    for(const f of found){
      const raw=(f.raw||"").trim();
      const kind=classify(raw);
      const parsed=parseFromQr(raw);
      const row={ ...parsed, _kind:kind };
      if(Array.isArray(f.corners) && f.corners.length>=4){
        const c0=centroid(f.corners); row._cx=c0.x; row._cy=c0.y;
      }
      const key=keyOf(row);
      if(!scanned.has(key)) scanned.set(key,row);
    }
    render();
  }

  function jsqrDetect() {
    const img=ctx.getImageData(0,0,c.width,c.height);
    const hit=jsQR(img.data,img.width,img.height,{ inversionAttempts:'attemptBoth' });
    if(hit){
      return [{
        raw: hit.data,
        corners: [hit.location.topLeftCorner, hit.location.topRightCorner, hit.location.bottomRightCorner, hit.location.bottomLeftCorner]
      }];
    }
    return [];
  }

  async function tick(){
    if(!stream) return;
    if(v.videoWidth){
      c.width=v.videoWidth; c.height=v.videoHeight;
      ctx.drawImage(v,0,0,c.width,c.height);

      let found=[];
      // 1) BarcodeDetector（あれば）
      if(useBarcodeDetector && detector){
        try{
          const barcodes=await detector.detect(c);
          for(const b of barcodes){ found.push({ raw:b.rawValue, corners:b.cornerPoints }); }
        }catch{
          useBarcodeDetector=false; detector=null;
        }
      }
      // 2) jsQR も常に併用（BDが0件でも拾えるように）
      const viaJsqr = jsqrDetect();
      if (viaJsqr.length) {
        // 同じ raw を重複登録しない
        const raws = new Set(found.map(f=>f.raw));
        for (const f of viaJsqr) if (!raws.has(f.raw)) found.push(f);
      }

      if(found.length){
        drawBoxes(found.map(f=>f.corners));
        handleFound(found);
      }
      info.textContent = `w×h: ${c.width}×${c.height} / found: ${found.length}`;
    }
    rafId=requestAnimationFrame(tick);
  }

  // ============ 一括更新 ============
  function assignNearest(){
    const dies=[], locs=[];
    for(const [,row] of scanned){
      if(row._kind==="die" && row.bn && row.wc && row._cx!=null) dies.push(row);
      if(row._kind==="loc" && row.loc && row._cx!=null) locs.push(row);
    }
    const MAX_NEAR_PX = 500;
    const pairs=[];
    for(const d of dies){
      let best=null, bestDist=Infinity;
      for(const l of locs){
        const dx=d._cx-l._cx, dy=d._cy-l._cy;
        const dist=Math.hypot(dx,dy);
        if(dist<bestDist){ bestDist=dist; best=l; }
      }
      if(best && bestDist<=MAX_NEAR_PX){
        pairs.push({ book:d.bn, wc:d.wc, wn:d.wn||"", loc:best.loc, dist:Math.round(bestDist), captured_at:new Date().toISOString() });
      }
    }
    return pairs;
  }

  // ============ イベント ============
  $("#btnStart").addEventListener("click", startCam);
  $("#btnStop").addEventListener("click", stopCam);
  $("#btnClear").addEventListener("click", ()=>{ scanned.clear(); render(); setStatus("一覧をクリアしました"); });
  selDevice.addEventListener("change", async (e)=>{ currentDeviceId=e.target.value||null; await startCam(); });
  window.addEventListener("pagehide", stopCam);
  window.addEventListener("visibilitychange", ()=>{ if(document.visibilityState==='hidden') stopCam(); });

  $("#btnAssign").addEventListener("click", async ()=>{
    const pairs = assignNearest();
    if(!pairs.length){ alert("die/loc の組み合わせが見つかりません。棚QRと抜型QRが同じ写真に入るよう撮影してください。"); return; }
    const msg = pairs.map(p=>`• ${p.book}-${p.wc} → ${p.loc} (${p.dist}px)`).join("\n");
    if(!confirm(`以下を Google Sheets に反映します。\n\n${msg}\n\n実行しますか？`)) return;
    try{
      const r = await fetch("/api/gsheet-seen-bulk", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ items: pairs }) });
      if(!r.ok) throw new Error(await r.text());
      const j = await r.json();
      if(!j.ok) throw new Error(JSON.stringify(j));
      alert("Google Sheets を更新しました。");
    }catch(e){ alert("更新に失敗しました: " + (e.message||e)); }
  });

  // 画像からのテスト
  $("#fileTest").addEventListener("change", async (ev)=>{
    const file = ev.target.files?.[0]; if(!file) return;
    const img = new Image();
    img.onload = ()=>{
      c.width = img.width; c.height = img.height;
      ctx.drawImage(img, 0, 0, c.width, c.height);
      let found = [];
      if (useBarcodeDetector) { /* 画像ではBD未使用 */ }
      found = jsqrDetect();
      if(found.length){
        drawBoxes(found.map(f=>f.corners));
        handleFound(found);
        info.textContent = `w×h: ${c.width}×${c.height} / found: ${found.length} (file)`;
      } else {
        alert("画像からは検出できませんでした。解像度・コントラストを上げて再試行してください。");
      }
      ev.target.value = "";
    };
    img.src = URL.createObjectURL(file);
  });

  // 初期
  (async ()=>{ if(navigator.mediaDevices?.enumerateDevices) await listCameras(); })();
  </script>
</body>
</html>
