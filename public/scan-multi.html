<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>複数QRスキャン + 写真アップロード / 位置更新</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  :root { --bd:#ddd; --tx:#222; --sub:#666; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 12px; color: var(--tx); }
  h2 { margin: 6px 0 12px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
  video { width: 340px; max-width: 100%; border:1px solid var(--bd); border-radius:10px; background:#000; }
  canvas { display:none; }
  .panel { flex:1 1 320px; min-width:320px; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px; align-items:center; }
  button, .btn { padding: 9px 12px; border-radius: 10px; border:1px solid var(--bd); background:#fff; cursor:pointer; }
  .muted { color: var(--sub); font-size: 12px; }
  .list { margin-top:8px; }
  .item { border:1px solid var(--bd); border-radius:12px; padding:10px; margin-bottom:10px; }
  .head { font-weight:700; margin-bottom:6px; }
  .kv { font-size: 13px; }
  .sub { color: var(--sub); font-size:12px; }
  .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center; }
  .chip { display:inline-block; padding:3px 8px; border:1px solid var(--bd); border-radius:999px; font-size:12px; }
  input[type="file"]{ display:none; }
  .inline-input { padding:6px 8px; border:1px solid var(--bd); border-radius:8px; }
  .pill { border-radius:999px; }
  .badge { display:inline-block; background:#eef; color:#224; padding:2px 6px; border-radius:4px; font-size:12px; }
  #err { color:#b00020; white-space:pre-wrap; }
</style>
</head>
<body>
  <h2>複数QRスキャン + 写真アップロード / 位置更新</h2>

  <div class="row">
    <div class="panel">
      <video id="v" playsinline muted></video>
      <canvas id="c"></canvas>
      <div class="controls">
        <button id="btnStart">カメラ開始</button>
        <button id="btnStop" disabled>停止</button>
        <button id="btnClear" class="pill">一覧クリア</button>
      </div>

      <div class="controls">
        <select id="selDevice"></select>
        <span id="cap" class="badge"></span>
        <span class="muted">※背面カメラ推奨。真っ黒時はカメラ切替や解像度低下を試します。</span>
      </div>

      <div class="muted" id="status">準備中…</div>
      <div id="err" class="muted"></div>

      <div class="muted" style="margin-top:8px">
        ・QRをかざすと一覧に自動追加（同じ抜型は重複しません）<br>
        ・オンラインならスキャン直後に「位置（LastSeen/ShelfLabel）」を即時更新します<br>
        ・オフラインなら更新を端末にキューし、再接続で自動送信します
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <input id="labelInput" class="inline-input" placeholder="棚ラベル（任意）" />
        <button id="applyAll">一覧の全件を“棚ラベル”で位置更新</button>
      </div>
      <div id="list" class="list"></div>
    </div>
  </div>

  <!-- jsQR (フォールバック用) -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" integrity="sha256-0KpQz5M6v9f2PitmT8mH1g2S7T0wj6Q5U8Xy5NIVl9c=" crossorigin="anonymous"></script>

  <script>
  // --- Service Worker 登録 ---
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/sw.js").catch(console.warn);
  }

  // --- 簡易ユーティリティ ---
  const $  = (q)=>document.querySelector(q);
  const v  = $("#v");
  const c  = $("#c");
  const ctx = c.getContext("2d", { willReadFrequently: true });
  const listEl = $("#list");
  const labelInput = $("#labelInput");
  const statusEl = $("#status");
  const errEl = $("#err");
  const selDevice = $("#selDevice");
  const cap = $("#cap");

  labelInput.value = "scan-multi";
  const scanned = new Map(); // key= `${bn}-${wc}`, val=row
  const QUEUE_KEY = "die-seen-queue-v1";

  const setStatus = (t)=> statusEl.textContent = t;
  const setError  = (t)=> errEl.textContent    = t || "";

  // --- #d=BASE64URL(JSON) を復号 ---
  function parseHashData(url) {
    try {
      const u = new URL(url);
      const h = u.hash || "";
      const m = h.match(/[#&]d=([A-Za-z0-9_\-]+)/);
      if (!m) return null;
      const b64 = m[1].replace(/-/g,'+').replace(/_/g,'/');
      const pad = "=".repeat((4 - b64.length % 4) % 4);
      const json = atob(b64 + pad);
      return JSON.parse(json);
    } catch { return null; }
  }

  // --- QR文字列（URL or プレーン）から抽出 ---
  function parseFromQr(text) {
    const d = parseHashData(text);
    if (d) {
      return { src:text, wc:(d.wc||"").trim(), wn:(d.wn||"").trim(), bn:(d.bn||"").trim(), kn:(d.kn||"").trim(), ps:(d.ps||"").trim(), cs:(d.cs||"").trim() };
    }
    try {
      const u = new URL(text);
      const p = u.searchParams;
      return { src:text, wc:(p.get("wc")||"").trim(), wn:"", bn:(p.get("book")||"").trim(), kn:"", ps:"", cs:"" };
    } catch {
      return { src:text, wc:"", wn:text, bn:"", kn:"", ps:"", cs:"" };
    }
  }
  function keyOf(row) {
    if (row.bn && row.wc) return `${row.bn}-${row.wc}`;
    return row.src;
  }

  // --- オフラインキュー ---
  function enqueue(job) {
    const q = JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");
    q.push(job);
    localStorage.setItem(QUEUE_KEY, JSON.stringify(q));
  }
  async function flushQueue() {
    if (!navigator.onLine) return;
    const q = JSON.parse(localStorage.getItem(QUEUE_KEY) || "[]");
    const rest = [];
    for (const job of q) {
      try {
        const r = await fetch("/api/seen", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(job),
        });
        if (!r.ok) throw new Error("fail");
      } catch {
        rest.push(job);
      }
    }
    localStorage.setItem(QUEUE_KEY, JSON.stringify(rest));
    if (rest.length === 0) setStatus("キュー送信完了");
  }
  window.addEventListener("online", flushQueue);

  async function updateSeen(book, wc, label) {
    const payload = { book, wc, label };
    if (navigator.onLine) {
      try {
        const r = await fetch("/api/seen", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
        if (!r.ok) throw new Error("bad");
        setStatus(`位置更新: ${book}-${wc} (${label||"-"})`);
      } catch {
        enqueue(payload);
        setStatus("オフライン扱いでキューに保存");
      }
    } else {
      enqueue(payload);
      setStatus("オフライン：キューに保存");
    }
  }

  // --- 一覧レンダリング ---
  function render() {
    listEl.innerHTML = "";
    for (const [,row] of scanned) {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <div class="head">${row.wn || "(WorkName なし)"} <span class="sub">[${row.wc || "-"}]</span></div>
        <div class="kv">BookName: ${row.bn || "-"}</div>
        <div class="kv">Kname: ${row.kn || "-"}</div>
        <div class="kv">Paper_Size: ${row.ps || "-"}</div>
        <div class="kv">Cut_Size: ${row.cs || "-"}</div>
        <div class="actions">
          <label class="btn">写真を撮る<input type="file" accept="image/*" capture="environment"></label>
          <button class="btn btnSeen">位置だけ更新</button>
          <span class="chip">${row.src.length>60 ? row.src.slice(0,60)+"…" : row.src}</span>
        </div>
      `;
      // 写真アップロード
      el.querySelector('input[type="file"]').addEventListener("change", async (ev)=>{
        const file = ev.target.files?.[0];
        if (!file) return;
        if (!row.bn || !row.wc) { alert("BookName / WorkCord が足りません"); return; }
        const dieId = `${row.bn}-${row.wc}`;

        try {
          const tRes = await fetch("/api/photo-token", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ dieId, purpose:"scan-multi" }) }).then(r=>r.json());
          if (!tRes.token) throw new Error("token error");

          const fd = new FormData();
          fd.append("token", tRes.token);
          fd.append("dieId", dieId);
          fd.append("label", labelInput.value || "scan-multi");
          fd.append("file", file, file.name || "photo.jpg");

          const up = await fetch("/api/upload", { method:"POST", body: fd }).then(r=>r.json());
          if (up && up.ok) alert("写真アップロード完了（位置も更新済み）");
          else throw new Error(up && up.error || "upload error");
        } catch (e) {
          alert("アップロード失敗: " + e.message);
        } finally {
          ev.target.value = ""; // 同じファイル再選択OK
        }
      });

      // 位置だけ更新
      el.querySelector(".btnSeen").addEventListener("click", ()=>{
        if (!row.bn || !row.wc) { alert("BookName / WorkCord が足りません"); return; }
        updateSeen(row.bn, row.wc, labelInput.value || "scan-multi");
      });

      listEl.appendChild(el);
    }
  }

  // === カメラ & スキャン（BarcodeDetector → jsQR フォールバック） ===
  let stream = null, rafId = null, detector = null, useBarcodeDetector = ('BarcodeDetector' in window);
  let currentDeviceId = null;
  cap.textContent = useBarcodeDetector ? "BarcodeDetector" : "jsQR";

  async function listCameras() {
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d => d.kind === 'videoinput');
    selDevice.innerHTML = '';
    cams.forEach((c, i) => {
      const opt = document.createElement('option');
      opt.value = c.deviceId;
      opt.textContent = c.label || `カメラ ${i+1}`;
      selDevice.appendChild(opt);
    });
    if (!currentDeviceId && cams.length) {
      currentDeviceId = cams[0].deviceId; // 既定を決める（真っ黒回避）
      selDevice.value = currentDeviceId;
    } else if (currentDeviceId) {
      const m = Array.from(selDevice.options).find(o => o.value === currentDeviceId);
      if (m) selDevice.value = currentDeviceId;
    }
  }

  function stopCam() {
    cancelAnimationFrame(rafId); rafId = null;
    if (stream) { stream.getTracks().forEach(t=>t.stop()); stream = null; }
    $("#btnStart").disabled = false;
    $("#btnStop").disabled  = true;
    setStatus("停止中");
  }

  function showError(e) {
    console.error(e);
    setError(`❌ ${e.name || ''} ${e.message || e}`);
    if (e.name === 'NotAllowedError') setError(errEl.textContent + '\nブラウザやWindowsのカメラ権限を許可してください。');
    if (e.name === 'NotFoundError')  setError(errEl.textContent + '\nカメラが見つかりません。外付けカメラ/別デバイスを選択してください。');
    if (e.name === 'NotReadableError') setError(errEl.textContent + '\n他のアプリ（Teams/Zoom/カメラ）が使用中の可能性があります。');
  }

  async function startCam() {
    stopCam();
    setError("");
    // できるだけ軽めの解像度で開始（Edge対策）
    const constraints = {
      video: currentDeviceId ? { deviceId: { exact: currentDeviceId }, width:{ideal:640}, height:{ideal:480} }
                             : { facingMode: { ideal: 'environment' }, width:{ideal:640}, height:{ideal:480} },
      audio: false
    };
    try {
      stream = await navigator.mediaDevices.getUserMedia(constraints);
    } catch (e) {
      showError(e);
      // 最後の手段：解像度をさらに落として再試行
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { width:320, height:240 }, audio:false });
      } catch (e2) {
        showError(e2);
        setStatus("カメラ起動失敗");
        return;
      }
    }
    v.srcObject = stream;
    try {
      await v.play();
    } catch (e) {
      showError(e);
      setStatus("再生失敗");
      return;
    }
    $("#btnStart").disabled = true;
    $("#btnStop").disabled  = false;
    await listCameras();
    setStatus("スキャン中…");

    // Detector 準備
    detector = null;
    if (useBarcodeDetector) {
      try {
        detector = new BarcodeDetector({ formats: ['qr_code'] });
      } catch (e) {
        useBarcodeDetector = false;
        detector = null;
      }
    }
    tick();
  }

  function drawBoxes(boxes, color = 'rgba(0,255,0,0.8)') {
    ctx.strokeStyle = color;
    ctx.lineWidth = 3;
    for (const b of boxes) {
      ctx.beginPath();
      ctx.moveTo(b[0].x, b[0].y);
      for (let i=1;i<b.length;i++) ctx.lineTo(b[i].x, b[i].y);
      ctx.closePath();
      ctx.stroke();
    }
  }

  async function tick() {
    if (!stream) return;
    if (v.videoWidth) {
      c.width = v.videoWidth;
      c.height = v.videoHeight;
      ctx.drawImage(v, 0, 0, c.width, c.height);

      let found = [];
      if (useBarcodeDetector && detector) {
        try {
          const barcodes = await detector.detect(c);
          for (const b of barcodes) {
            found.push({ raw: b.rawValue, corners: b.cornerPoints });
          }
        } catch (e) {
          // Safari等で失敗したらフォールバックに切替
          useBarcodeDetector = false;
        }
      }

      if (!useBarcodeDetector) {
        // jsQR（単一検出）フォールバック
        const img = ctx.getImageData(0, 0, c.width, c.height);
        const hit = jsQR(img.data, img.width, img.height, { inversionAttempts:'attemptBoth' });
        if (hit) {
          found.push({
            raw: hit.data,
            corners: [hit.location.topLeftCorner, hit.location.topRightCorner, hit.location.bottomRightCorner, hit.location.bottomLeftCorner]
          });
        }
      }

      if (found.length) {
        drawBoxes(found.map(f => f.corners));
        for (const f of found) {
          const text = (f.raw || "").trim();
          const row = parseFromQr(text);
          const key = keyOf(row);
          if (!scanned.has(key)) {
            scanned.set(key, row);
            render();
            if (row.bn && row.wc) {
              updateSeen(row.bn, row.wc, labelInput.value || "scan-multi");
            }
          }
        }
      }
    }
    rafId = requestAnimationFrame(tick);
  }

  // --- UIイベント ---
  $("#btnStart").addEventListener("click", startCam);   // iOS/Edge対策：ユーザ操作で開始
  $("#btnStop").addEventListener("click", stopCam);
  $("#btnClear").addEventListener("click", ()=>{ scanned.clear(); render(); setStatus("一覧をクリアしました"); });

  $("#applyAll").addEventListener("click", async ()=>{
    const label = labelInput.value || "scan-multi";
    for (const [,row] of scanned) {
      if (row.bn && row.wc) await updateSeen(row.bn, row.wc, label);
    }
  });

  selDevice.addEventListener("change", async (e)=>{
    currentDeviceId = e.target.value || null;
    await startCam();
  });

  // ページ遷移/非表示で停止
  window.addEventListener("pagehide", stopCam);
  window.addEventListener("visibilitychange", ()=>{ if (document.visibilityState === 'hidden') stopCam(); });

  // 起動時：キュー送信のみ。カメラはユーザー操作で開始（自動再生ポリシー対策）
  (async ()=>{ await flushQueue(); if (navigator.mediaDevices?.enumerateDevices) await listCameras(); })();
  </script>
</body>
</html>
