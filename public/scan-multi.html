<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>複数QRスキャン → Google Sheets 位置更新（wsTableCD）</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root { --bd:#ddd; --tx:#222; --sub:#666; }
  body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif; margin: 12px; color: var(--tx); }
  h2 { margin: 6px 0 12px; }
  .row { display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; }
  video { width: 360px; max-width: 100%; border:1px solid var(--bd); border-radius:10px; background:#000; }
  canvas { display:none; }
  .panel { flex:1 1 340px; min-width:320px; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 12px; align-items:center; }
  button, .btn { padding: 9px 12px; border-radius: 10px; border:1px solid var(--bd); background:#fff; cursor:pointer; }
  .muted { color: var(--sub); font-size: 12px; }
  .list { margin-top:8px; }
  .item { border:1px solid var(--bd); border-radius:12px; padding:10px; margin-bottom:10px; }
  .head { font-weight:700; margin-bottom:6px; }
  .kv { font-size: 13px; }
  .sub { color: var(--sub); font-size:12px; }
  .actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; align-items:center; }
  .chip { display:inline-block; padding:3px 8px; border:1px solid var(--bd); border-radius:999px; font-size:12px; }
  .badge { display:inline-block; background:#eef; color:#224; padding:2px 6px; border-radius:4px; font-size:12px; }
  #err { color:#b00020; white-space:pre-wrap; }
  #info { position: fixed; left: 10px; bottom: 10px; background:#fff; border:1px solid var(--bd); padding:6px 8px; border-radius:8px; font-size:12px; }
</style>
</head>
<body>
  <h2>複数QRスキャン → Google Sheets 位置更新（wsTableCD）</h2>

  <div class="row">
    <div class="panel">
      <video id="v" playsinline muted></video>
      <canvas id="c"></canvas>

      <div class="controls">
        <button id="btnStart">カメラ開始</button>
        <button id="btnStop" disabled>停止</button>
        <button id="btnClear" style="border-radius:999px">一覧クリア</button>
        <label class="btn">画像からテスト<input id="fileTest" type="file" accept="image/*" style="display:none"></label>
      </div>

      <div class="controls">
        <select id="selDevice"></select>
        <span id="cap" class="badge"></span>
        <span class="muted">※真っ黒時はカメラ切替か <code>?legacy=1</code> をURL末尾に付与</span>
      </div>

      <div class="muted" id="status">準備中…</div>
      <div id="err" class="muted"></div>

      <div class="muted" style="margin-top:8px">
        ・棚QR：プレーン文字 <b>loc-LOC-…</b> / 抜型QR：<b>die-BookName-WorkCord</b> または <b>?book=&wc=</b><br>
        ・1枚の画像に映った QR の中心距離で最近傍の棚を推定→<b>Google Sheets(wsTableCD)</b>へ一括更新
      </div>
    </div>

    <div class="panel">
      <div class="controls">
        <button id="btnAssign">検出結果から「最寄り棚」を一括推定 → Google Sheets 更新</button>
      </div>
      <div id="list" class="list"></div>
    </div>
  </div>

  <div id="info">w×h: - × - / found: 0</div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" crossorigin="anonymous"></script>

  <script>
  // ========= 設定 =========
  const SHEET_ENDPOINT = "/api/gsheet-seen-bulk";
  const params = new URLSearchParams(location.search);
  const FORCE_LEGACY = params.get("legacy")==="1";
  const SCAN_SCALE = 2; // 解析用キャンバスを拡大

  // ========= ユーティリティ =========
  const $ = (q)=>document.querySelector(q);
  const v = $("#v"), c = $("#c"), ctx = c.getContext("2d", { willReadFrequently: true });
  const selDevice = $("#selDevice"), cap = $("#cap"), statusEl = $("#status"), errEl = $("#err");
  const listEl = $("#list"), info = $("#info");

  function setStatus(t){ statusEl.textContent = t; }
  function setError(t){ errEl.textContent = t || ""; }

  function centroid(corners){
    const xs=corners.map(p=>p.x), ys=corners.map(p=>p.y);
    return { x:(Math.min(...xs)+Math.max(...xs))/2, y:(Math.min(...ys)+Math.max(...ys))/2 };
  }
  function classify(raw){
    const s=(raw||"").trim();
    if(/^loc-/i.test(s)) return "loc";
    if(/^die-/i.test(s)) return "die";
    try{ const u=new URL(s); if(u.searchParams.get("book")||u.searchParams.get("wc")) return "die"; }catch{}
    return "other";
  }
  function parseFromQr(text){
    const m = /^die-([^-\n]+)-(.+)$/.exec(text);
    if(m){ return { src:text, bn:m[1].trim(), wc:m[2].trim(), wn:"" }; }
    try{
      const u = new URL(text);
      const book=(u.searchParams.get("book")||"").trim();
      const wc=(u.searchParams.get("wc")||"").trim();
      if(book||wc){ return { src:text, bn:book, wc:wc, wn:"" }; }
    }catch{}
    const l = /^loc-(.+)$/i.exec(text);
    if(l){ return { src:text, loc:l[1].trim() }; }
    return { src:text };
  }
  function keyOf(row){
    if(row.bn && row.wc) return `die:${row.bn}-${row.wc}`;
    if(row.loc) return `loc:${row.loc}`;
    return row.src;
  }

  // ========= 状態 & 表示 =========
  const scanned = new Map();
  function render(){
    listEl.innerHTML = "";
    for(const [,row] of scanned){
      const el=document.createElement("div");
      el.className="item";
      let lines=[];
      if(row._kind==="die"){
        lines.push(`<div class="head">抜型 <span class="sub">${row.bn || "-"}</span> [<b>${row.wc || "-"}</b>]</div>`);
        lines.push(`<div class="kv">WorkName: ${row.wn || "-"}</div>`);
      }else if(row._kind==="loc"){
        lines.push(`<div class="head">棚 <span class="sub">${row.loc || "-"}</span></div>`);
      }else{
        lines.push(`<div class="head">その他</div>`);
      }
      lines.push(`<div class="actions"><span class="chip">${row.src.length>70?row.src.slice(0,70)+"…":row.src}</span></div>`);
      el.innerHTML = lines.join("");
      listEl.appendChild(el);
    }
  }

  // ========= 近接割当（短辺20%しきい値） =========
  function assignNearest(){
    const dies=[], locs=[];
    for(const [,row] of scanned){
      if(row._kind==="die" && row.bn && row.wc && row._cx!=null) dies.push(row);
      if(row._kind==="loc" && row.loc && row._cx!=null) locs.push(row);
    }
    const MAX_NEAR_PX = Math.round(0.2 * Math.min(c.width||1280, c.height||720));
    const pairs=[];
    for(const d of dies){
      let best=null, bestDist=Infinity;
      for(const l of locs){
        const dx=d._cx-l._cx, dy=d._cy-l._cy;
        const dist=Math.hypot(dx,dy);
        if(dist<bestDist){ bestDist=dist; best=l; }
      }
      if(best && bestDist<=MAX_NEAR_PX){
        pairs.push({ book:d.bn, wc:d.wc, wn:d.wn||"", loc:best.loc, dist:Math.round(bestDist), captured_at:new Date().toISOString() });
      }
    }
    return pairs;
  }

  // ========= 検出（拡大キャンバス + BD + jsQR 反復） =========
  let stream=null, rafId=null, detector=null, useBD=('BarcodeDetector' in window) && !FORCE_LEGACY;
  let currentDeviceId=null;
  cap.textContent = useBD ? "BarcodeDetector + jsQR" : "jsQR only (legacy)";

  function stopCam(){
    cancelAnimationFrame(rafId); rafId=null;
    if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
    $("#btnStart").disabled=false; $("#btnStop").disabled=true;
    setStatus("停止中");
  }
  function showError(e){
    console.error(e);
    setError(`❌ ${e.name||''} ${e.message||e}`);
    if(e.name==='NotAllowedError') setError(errEl.textContent+'\nカメラ権限を許可してください。');
    if(e.name==='NotReadableError') setError(errEl.textContent+'\n他アプリがカメラ使用中の可能性。');
  }
  async function listCameras(){
    const devices = await navigator.mediaDevices.enumerateDevices();
    const cams = devices.filter(d=>d.kind==='videoinput');
    selDevice.innerHTML="";
    cams.forEach((c,i)=>{
      const opt=document.createElement("option");
      opt.value=c.deviceId; opt.textContent=c.label || `カメラ ${i+1}`;
      selDevice.appendChild(opt);
    });
    if(!currentDeviceId && cams.length){
      currentDeviceId = cams[0].deviceId;
      selDevice.value = currentDeviceId;
    }else if(currentDeviceId){
      const m=[...selDevice.options].find(o=>o.value===currentDeviceId);
      if(m) selDevice.value=currentDeviceId;
    }
  }

  async function startCam(){
    stopCam(); setError("");
    const idealW = FORCE_LEGACY ? 640 : 1280;
    const idealH = FORCE_LEGACY ? 480 : 720;
    const constraints = {
      video: currentDeviceId
        ? { deviceId:{ exact: currentDeviceId }, width:{ideal: idealW}, height:{ideal: idealH} }
        : { facingMode:{ ideal:'environment' }, width:{ideal: idealW}, height:{ideal: idealH} },
      audio:false
    };
    try{
      stream = await navigator.mediaDevices.getUserMedia(constraints);
    }catch(e){
      showError(e);
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video:{ width:640, height:480 }, audio:false });
      }catch(e2){
        showError(e2); setStatus("カメラ起動失敗"); return;
      }
    }
    v.srcObject=stream;
    try{ await v.play(); }catch(e){ showError(e); setStatus("再生失敗"); return; }
    $("#btnStart").disabled=true; $("#btnStop").disabled=false;
    await listCameras(); setStatus("スキャン中…");

    detector=null;
    if(useBD){ try{ detector=new BarcodeDetector({ formats:['qr_code'] }); }catch{ useBD=false; detector=null; } }
    tick();
  }

  function drawBoxes(boxes, color='rgba(0,255,0,0.8)'){
    ctx.strokeStyle=color; ctx.lineWidth=3;
    for(const b of boxes){ ctx.beginPath(); ctx.moveTo(b[0].x,b[0].y); for(let i=1;i<b.length;i++) ctx.lineTo(b[i].x,b[i].y); ctx.closePath(); ctx.stroke(); }
  }
  function handleFound(found){
    for(const f of found){
      const raw=(f.raw||"").trim();
      const kind=classify(raw);
      const parsed=parseFromQr(raw);
      const row={ ...parsed, _kind:kind };
      if(Array.isArray(f.corners) && f.corners.length>=4){
        const c0=centroid(f.corners); row._cx=c0.x; row._cy=c0.y;
      }
      const key=keyOf(row);
      if(!scanned.has(key)) scanned.set(key,row);
    }
    render();
  }

  // jsQR 反復（オフスクリーンのImageDataで）
  function jsqrDetectAllFromImageData(imgData, ow, oh){
    const out=[];
    const copy = new ImageData(new Uint8ClampedArray(imgData.data), ow, oh);
    const maskRect=(loc)=>{
      const xs=[loc.topLeftCorner.x, loc.topRightCorner.x, loc.bottomRightCorner.x, loc.bottomLeftCorner.x];
      const ys=[loc.topLeftCorner.y, loc.topRightCorner.y, loc.bottomRightCorner.y, loc.bottomLeftCorner.y];
      const x0=Math.max(0, Math.min(...xs)|0), x1=Math.min(ow, Math.max(...xs)|0);
      const y0=Math.max(0, Math.min(...ys)|0), y1=Math.min(oh, Math.max(...ys)|0);
      for(let y=y0;y<y1;y++){
        for(let x=x0;x<x1;x++){
          const i=(y*ow+x)*4; copy.data[i]=copy.data[i+1]=copy.data[i+2]=255; copy.data[i+3]=255;
        }
      }
    };
    for(let k=0;k<12;k++){
      const hit = jsQR(copy.data, ow, oh, { inversionAttempts:'attemptBoth' });
      if(!hit) break;
      out.push(hit);
      maskRect(hit.location);
    }
    return out;
  }

  async function detectFromCanvas(baseCanvas){
    // 解析用オフスクリーン（拡大）
    const ow = baseCanvas.width * SCAN_SCALE;
    const oh = baseCanvas.height * SCAN_SCALE;
    const off = new OffscreenCanvas(ow, oh);
    const octx = off.getContext("2d", { willReadFrequently:true });
    octx.imageSmoothingEnabled = false;
    octx.drawImage(baseCanvas, 0, 0, ow, oh);

    let found=[];

    // BarcodeDetector（対応端末のみ）
    if(useBD && detector){
      try{
        const codes=await detector.detect(off);
        for(const b of codes){
          const cs=b.cornerPoints.map(p=>({x:p.x/SCAN_SCALE, y:p.y/SCAN_SCALE}));
          found.push({ raw:b.rawValue, corners:cs });
        }
      }catch{ useBD=false; detector=null; }
    }

    // jsQR 反復（複数）
    const imgData=octx.getImageData(0,0,ow,oh);
    const hits=jsqrDetectAllFromImageData(imgData, ow, oh);
    const raws=new Set(found.map(f=>f.raw));
    for(const h of hits){
      const cs=[
        h.location.topLeftCorner, h.location.topRightCorner,
        h.location.bottomRightCorner, h.location.bottomLeftCorner
      ].map(p=>({x:p.x/SCAN_SCALE, y:p.y/SCAN_SCALE}));
      if(!raws.has(h.data)) found.push({ raw:h.data, corners:cs });
    }

    return found;
  }

  async function tick(){
    if(!stream) return;
    if(v.videoWidth){
      // 表示キャンバス
      c.width=v.videoWidth; c.height=v.videoHeight;
      ctx.imageSmoothingEnabled=false;
      ctx.drawImage(v,0,0,c.width,c.height);

      const found = await detectFromCanvas(c);

      if(found.length){
        drawBoxes(found.map(f=>f.corners));
        // ★このフレームの検出結果だけを使う：前フレームの座標を捨てる
       scanned.clear();
        handleFound(found);
      }
      info.textContent = `w×h: ${c.width}×${c.height} / found: ${found.length}`;
    }
    rafId=requestAnimationFrame(tick);
  }

  // ========= イベント =========
  $("#btnStart").addEventListener("click", startCam);
  $("#btnStop").addEventListener("click", stopCam);
  $("#btnClear").addEventListener("click", ()=>{ scanned.clear(); render(); setStatus("一覧をクリアしました"); });
  selDevice.addEventListener("change", async (e)=>{ currentDeviceId=e.target.value||null; await startCam(); });
  window.addEventListener("pagehide", stopCam);
  window.addEventListener("visibilitychange", ()=>{ if(document.visibilityState==='hidden') stopCam(); });

  $("#btnAssign").addEventListener("click", async ()=>{
    const pairs = assignNearest();
    if(!pairs.length){ alert("die/loc の組み合わせが見つかりません。QRサイズや距離を調整してください。"); return; }
    const msg = pairs.map(p=>`• ${p.book}-${p.wc} → ${p.loc} (${p.dist}px)`).join("\n");
    if(!confirm(`以下を Google Sheets に反映します。\n\n${msg}\n\n実行しますか？`)) return;
    try{
      const r = await fetch(SHEET_ENDPOINT, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ items: pairs }) });
      if(!r.ok) throw new Error(await r.text());
      const j = await r.json();
      if(!j.ok) throw new Error(JSON.stringify(j));
      alert("Google Sheets を更新しました。");
    }catch(e){ alert("更新に失敗しました: " + (e.message||e)); }
  });

  // 画像からテスト（複数検出・拡大スキャン）
  $("#fileTest").addEventListener("change", async (ev)=>{
    const file = ev.target.files?.[0]; if(!file) return;
    const img = new Image();
    img.onload = async ()=>{
      c.width = img.width; c.height = img.height;
      ctx.imageSmoothingEnabled=false;
      ctx.drawImage(img, 0, 0, c.width, c.height);

      const found = await detectFromCanvas(c);
      if(found.length){
        drawBoxes(found.map(f=>f.corners));
        handleFound(found);
        info.textContent = `w×h: ${c.width}×${c.height} / found: ${found.length} (file)`;
      } else {
        alert("画像から検出できません。QRの実寸（短辺≥150px）や余白、コントラストを調整してください。");
      }
      ev.target.value = "";
    };
    img.src = URL.createObjectURL(file);
  });

  (async ()=>{ if(navigator.mediaDevices?.enumerateDevices) await listCameras(); })();
  </script>
</body>
</html>
