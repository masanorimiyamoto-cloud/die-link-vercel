<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>Google Drive マスター図面ビューア（Drive-only｜die-check経由）</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<style>
  :root{ --bd:#e9ecef; --tx:#212529; --ok:#1c7ed6; --muted:#6c757d; }
  html,body{margin:0;background:#f7f9fc;color:var(--tx);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  h1{margin:0 0 14px;font-size:clamp(18px,2.8vw,24px)}
  .card{background:#fff;border:1px solid var(--bd);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.05);padding:16px;margin:12px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{display:flex;align-items:center;gap:6px}
  input[type=text]{padding:8px 10px;border:1px solid var(--bd);border-radius:10px;font-size:14px;min-width:10ch;background:#fff}
  button{padding:10px 16px;border-radius:10px;border:1px solid var(--bd);background:#fff;cursor:pointer;font-size:14px;font-weight:600}
  button.primary{background:var(--ok);color:#fff;border-color:var(--ok)}
  .muted{color:var(--muted);font-size:13px}
  .kvs{display:grid;grid-template-columns:max-content 1fr;gap:6px 10px;font-size:14px}
  .out{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;background:#f8fafc;border:1px solid var(--bd);border-radius:10px;padding:10px}
  img.preview{max-width:100%;height:auto;border:1px solid var(--bd);border-radius:10px;background:#fff}
  .hint{padding:8px;border:1px dashed var(--bd);border-radius:10px;background:#fcfcff}
</style>
</head>
<body>
<div class="wrap">
  <h1>Google Drive マスター図面ビューア（Drive-only）</h1>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <label>Book: <input type="text" id="inBook" value="Ta" placeholder="例: Ta"></label>
        <label>WC: <input type="text" id="inWc" value="9892" placeholder="例: 9892"></label>
      </div>
      <div class="row">
        <button id="btnOpen" class="primary">Drive 図面を開く（proxy）</button>
        <button id="btnJson">die-check(JSON)を表示</button>
      </div>
    </div>
    <div class="hint" style="margin-top:10px">
      ※ サーバー側は既存の <code>/api/die-check</code> と <code>/api/drive-proxy</code> を使用します。<br>
      ※ Vercel 環境変数に <b>GOOGLE_SA_JSON</b> と <b>DRIVE_FOLDER_ID</b> が設定されている前提です。Airtable は参照しません。
    </div>
  </div>

  <div class="card" id="boxDrive" style="display:none">
    <h3 style="margin:0 0 10px">Drive から取得</h3>
    <div class="kvs" style="margin-bottom:8px">
      <b>webViewLink</b><div id="drvLink" class="muted">—</div>
      <b>fileId</b><div id="drvId" class="muted">—</div>
      <b>proxy URL</b><div id="drvProxy" class="muted">—</div>
    </div>
    <div class="row" style="gap:12px;margin:8px 0">
      <a id="aOpenView" href="#" target="_blank" rel="noopener noreferrer">
        <button>Google Drive（webView）を開く</button>
      </a>
      <a id="aOpenProxy" href="#" target="_blank" rel="noopener noreferrer">
        <button class="primary">proxy 経由で開く/保存</button>
      </a>
    </div>
    <div id="imgWrap" style="margin-top:10px;display:none">
      <div class="muted" style="margin-bottom:6px">画像プレビュー（proxy経由）</div>
      <img id="imgPrev" class="preview" alt="">
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">die-check 応答(JSON)</h3>
    <pre id="out" class="out">—</pre>
  </div>
</div>

<script>
    async function go(ev){
    ev.preventDefault();
    const book = document.getElementById('book').value.trim();
    const wc   = document.getElementById('wc').value.trim();
    const dev  = document.getElementById('dev').checked ? '1':'0';
    const msg  = document.getElementById('msg');
    const out  = document.getElementById('out');
    msg.textContent = ''; out.innerHTML = '';
    if(!book || !wc){ alert('BookとWorkCordを入力してください'); return; }

    try{
        // --- Step1: Driveフォルダ内検索 ---
        const r = await fetch(`/api/drive-find?book=${encodeURIComponent(book)}&wc=${encodeURIComponent(wc)}&dev=${dev}`);
        const j = await r.json();
        if(!j.ok || !j.fileId){
        msg.textContent = '❌ Google Driveに該当ファイルがありません。';
        out.innerHTML = '<pre>'+JSON.stringify(j,null,2)+'</pre>';
        return;
        }

        const fileId = j.fileId;
        const fileName = j.fileName;
        msg.textContent = `✅ ファイルID取得成功: ${fileId}`;

        // --- Step2: drive-proxyで実体を取得 ---
        const rr = await fetch(`/api/drive-proxy?id=${encodeURIComponent(fileId)}&name=${encodeURIComponent(fileName)}&dev=${dev}`);
        if(!rr.ok){
        msg.textContent = '❌ Drive取得失敗: ' + rr.status;
        out.innerHTML = '<pre>'+await rr.text()+'</pre>';
        return;
        }
        const blob = await rr.blob();
        const objUrl = URL.createObjectURL(blob);
        if(blob.type.startsWith('image/')){
        out.innerHTML = `<img src="${objUrl}" style="max-width:100%;border:1px solid #ccc">`;
        }else if(blob.type === 'application/pdf'){
        out.innerHTML = `<iframe src="${objUrl}" style="width:100%;height:70vh;border:1px solid #ccc"></iframe>`;
        }else{
        out.innerHTML = `<a href="${objUrl}" download="${fileName}">ダウンロード (${blob.type})</a>`;
        }
        msg.textContent += ` ｜ファイル取得成功 (${blob.type}, ${blob.size} bytes)`;
    }catch(e){
        msg.textContent = '⚠️ エラー: ' + e.message;
        console.error(e);
    }
    }
</script>

</body>
</html>
