<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>Google Drive ãƒã‚¹ã‚¿ãƒ¼å›³é¢ãƒ“ãƒ¥ãƒ¼ã‚¢ï¼ˆDrive-onlyï½œdie-checkçµŒç”±ï¼‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<style>
  :root{ --bd:#e9ecef; --tx:#212529; --ok:#1c7ed6; --muted:#6c757d; }
  html,body{margin:0;background:#f7f9fc;color:var(--tx);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  h1{margin:0 0 14px;font-size:clamp(18px,2.8vw,24px)}
  .card{background:#fff;border:1px solid var(--bd);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.05);padding:16px;margin:12px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{display:flex;align-items:center;gap:6px}
  input[type=text]{padding:8px 10px;border:1px solid var(--bd);border-radius:10px;font-size:14px;min-width:10ch;background:#fff}
  button{padding:10px 16px;border-radius:10px;border:1px solid var(--bd);background:#fff;cursor:pointer;font-size:14px;font-weight:600}
  button.primary{background:var(--ok);color:#fff;border-color:var(--ok)}
  .muted{color:var(--muted);font-size:13px}
  .kvs{display:grid;grid-template-columns:max-content 1fr;gap:6px 10px;font-size:14px}
  .out{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;background:#f8fafc;border:1px solid var(--bd);border-radius:10px;padding:10px}
  img.preview{max-width:100%;height:auto;border:1px solid var(--bd);border-radius:10px;background:#fff}
  .hint{padding:8px;border:1px dashed var(--bd);border-radius:10px;background:#fcfcff}
</style>
</head>
<body>
<div class="wrap">
  <h1>Google Drive ãƒã‚¹ã‚¿ãƒ¼å›³é¢ãƒ“ãƒ¥ãƒ¼ã‚¢ï¼ˆDrive-onlyï¼‰</h1>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <label>Book: <input type="text" id="inBook" value="Ta" placeholder="ä¾‹: Ta"></label>
        <label>WC: <input type="text" id="inWc" value="9892" placeholder="ä¾‹: 9892"></label>
      </div>
      <div class="row">
        <button id="btnOpen" class="primary">Drive å›³é¢ã‚’é–‹ãï¼ˆproxyï¼‰</button>
        <button id="btnJson">die-check(JSON)ã‚’è¡¨ç¤º</button>
      </div>
    </div>
    <div class="hint" style="margin-top:10px">
      â€» ã‚µãƒ¼ãƒãƒ¼å´ã¯æ—¢å­˜ã® <code>/api/die-check</code> ã¨ <code>/api/drive-proxy</code> ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>
      â€» Vercel ç’°å¢ƒå¤‰æ•°ã« <b>GOOGLE_SA_JSON</b> ã¨ <b>DRIVE_FOLDER_ID</b> ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å‰æã§ã™ã€‚Airtable ã¯å‚ç…§ã—ã¾ã›ã‚“ã€‚
    </div>
  </div>

  <div class="card" id="boxDrive" style="display:none">
    <h3 style="margin:0 0 10px">Drive ã‹ã‚‰å–å¾—</h3>
    <div class="kvs" style="margin-bottom:8px">
      <b>webViewLink</b><div id="drvLink" class="muted">â€”</div>
      <b>fileId</b><div id="drvId" class="muted">â€”</div>
      <b>proxy URL</b><div id="drvProxy" class="muted">â€”</div>
    </div>
    <div class="row" style="gap:12px;margin:8px 0">
      <a id="aOpenView" href="#" target="_blank" rel="noopener noreferrer">
        <button>Google Driveï¼ˆwebViewï¼‰ã‚’é–‹ã</button>
      </a>
      <a id="aOpenProxy" href="#" target="_blank" rel="noopener noreferrer">
        <button class="primary">proxy çµŒç”±ã§é–‹ã/ä¿å­˜</button>
      </a>
    </div>
    <div id="imgWrap" style="margin-top:10px;display:none">
      <div class="muted" style="margin-bottom:6px">ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆproxyçµŒç”±ï¼‰</div>
      <img id="imgPrev" class="preview" alt="">
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 10px">die-check å¿œç­”(JSON)</h3>
    <pre id="out" class="out">â€”</pre>
  </div>
</div>

<script>
async function go(ev){
  ev.preventDefault();
  const book = document.getElementById('book').value.trim();
  const wc   = document.getElementById('wc').value.trim();
  const dev  = document.getElementById('dev').checked ? '1':'0';
  const msg  = document.getElementById('msg');
  const out  = document.getElementById('out');
  msg.textContent = '';
  out.innerHTML = '';

  if(!book || !wc){
    alert('Bookã¨WorkCordã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
    return;
  }

  try {
    // === Step 1: Driveãƒ•ã‚©ãƒ«ãƒ€å†…ã§ãƒ•ã‚¡ã‚¤ãƒ«æ¤œç´¢ ===
    msg.textContent = 'ğŸ” Google Driveå†…ã‚’æ¤œç´¢ã—ã¦ã„ã¾ã™...';
    const r = await fetch(`/api/drive-find?book=${encodeURIComponent(book)}&wc=${encodeURIComponent(wc)}&dev=${dev}`);
    const j = await r.json();

    if(!j.ok || !j.fileId){
      msg.textContent = 'âŒ Google Driveã«è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
      out.innerHTML = `<pre>${JSON.stringify(j, null, 2)}</pre>`;
      return;
    }

    const fileId = j.fileId;
    const fileName = j.fileName;
    msg.textContent = `âœ… ãƒ•ã‚¡ã‚¤ãƒ«è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: ${fileName}`;

    // === Step 2: drive-proxyã‹ã‚‰å®Ÿä½“ã‚’å–å¾— ===
    msg.textContent += 'ï½œç”»åƒã‚’å–å¾—ä¸­...';
    const rr = await fetch(`/api/drive-proxy?id=${encodeURIComponent(fileId)}&name=${encodeURIComponent(fileName)}&dev=${dev}`);

    if(!rr.ok){
      msg.textContent = 'âŒ Driveã‹ã‚‰ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ (' + rr.status + ')';
      out.innerHTML = `<pre>${await rr.text()}</pre>`;
      return;
    }

    const blob = await rr.blob();
    const objUrl = URL.createObjectURL(blob);

    if(blob.type.startsWith('image/')){
      out.innerHTML = `<img src="${objUrl}" style="max-width:100%;height:auto;border:1px solid #ccc;margin-top:10px;">`;
    }else if(blob.type === 'application/pdf'){
      out.innerHTML = `<iframe src="${objUrl}" style="width:100%;height:70vh;border:1px solid #ccc;margin-top:10px;"></iframe>`;
    }else{
      out.innerHTML = `<a href="${objUrl}" download="${fileName}">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (${blob.type})</a>`;
    }

    msg.textContent = `âœ… å›³é¢ã‚’å–å¾—ã—ã¾ã—ãŸ (${blob.type}, ${blob.size} bytes)`;

  } catch (e) {
    msg.textContent = 'âš ï¸ ã‚¨ãƒ©ãƒ¼: ' + e.message;
    console.error(e);
  }
}
</script>


</body>
</html>
