<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>Google Drive ãƒã‚¹ã‚¿ãƒ¼å›³é¢ãƒ“ãƒ¥ãƒ¼ã‚¢ï¼ˆDrive-onlyï½œdie-checkçµŒç”±ï¼‰</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<style>
  :root{ --bd:#e9ecef; --tx:#212529; --ok:#1c7ed6; --muted:#6c757d; }
  html,body{margin:0;background:#f7f9fc;color:var(--tx);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  .wrap{max-width:960px;margin:0 auto;padding:16px}
  h1{margin:0 0 14px;font-size:clamp(18px,2.8vw,24px)}
  .card{background:#fff;border:1px solid var(--bd);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.05);padding:16px;margin:12px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{display:flex;align-items:center;gap:6px}
  input[type=text]{padding:8px 10px;border:1px solid var(--bd);border-radius:10px;font-size:14px;min-width:10ch;background:#fff}
  button{padding:10px 16px;border-radius:10px;border:1px solid var(--bd);background:#fff;cursor:pointer;font-size:14px;font-weight:600}
  button.primary{background:var(--ok);color:#fff;border-color:var(--ok)}
  .muted{color:var(--muted);font-size:13px}
  .kvs{display:grid;grid-template-columns:max-content 1fr;gap:6px 10px;font-size:14px}
  .out{white-space:pre-wrap;font-family:ui-monospace,Consolas,monospace;background:#f8fafc;border:1px solid var(--bd);border-radius:10px;padding:10px}
  img.preview{max-width:100%;height:auto;border:1px solid var(--bd);border-radius:10px;background:#fff}
  .hint{padding:8px;border:1px dashed var(--bd);border-radius:10px;background:#fcfcff}
</style>
</head>
<body>
<!-- â–¼ ã“ã“ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ ï¼†ãƒœã‚¿ãƒ³ä¸€å¼ï¼ˆç½®ãæ›ãˆï¼‰ â–¼ -->
<div class="card" style="max-width:720px;margin:0 auto 16px">
  <h2 style="margin:0 0 10px;">Google Drive å›³é¢ãƒ“ãƒ¥ãƒ¼ã‚¢ï¼ˆAirtableä¸ä½¿ç”¨ï¼‰</h2>
  <form id="driveForm">
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <label>Book:
        <input id="book" type="text" placeholder="ä¾‹: Ta" required
               style="padding:8px 10px;border:1px solid #ccc;border-radius:8px">
      </label>
      <label>WC:
        <input id="wc" type="text" placeholder="ä¾‹: 9892" required
               style="padding:8px 10px;border:1px solid #ccc;border-radius:8px">
      </label>
      <label title="æœ¬ç•ªã§CSRFã‚’é¿ã‘ã‚‹ãŸã‚ã®ç·©å’Œãƒ•ãƒ©ã‚°">
        <input id="dev" type="checkbox" checked> dev=1
      </label>

      <button id="btnOpen" type="button"
              style="padding:10px 16px;border-radius:10px;border:1px solid #1c7ed6;background:#1c7ed6;color:#fff;font-weight:700;cursor:pointer">
        å›³é¢ã‚’é–‹ã
      </button>
    </div>
  </form>
  <div id="msg" style="margin-top:10px;color:#333;font-weight:600"></div>
</div>




<script>
"use strict";

(function(){
  // ã¾ãšã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã‚ã¦ã„ã‚‹ã‹ã‚’ç¢ºèª
  console.log("[google-drive-spec] script loaded");

  // DOM æ§‹ç¯‰å®Œäº†å¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’å¼µã‚‹
  document.addEventListener("DOMContentLoaded", () => {
    console.log("[google-drive-spec] DOM ready");
    const btn = document.getElementById("btnOpen");
    const form = document.getElementById("driveForm");

    if (btn) {
      btn.addEventListener("click", go);
    } else {
      console.warn("btnOpen ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚IDã®ã‚¹ãƒšãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
    }

    if (form) {
      form.addEventListener("submit", (e) => { e.preventDefault(); go(e); });
    }
  });

  async function go(ev){
    ev && ev.preventDefault && ev.preventDefault();

    const bookEl = document.getElementById("book");
    const wcEl   = document.getElementById("wc");
    const devEl  = document.getElementById("dev");
    const msgEl  = document.getElementById("msg");
    const outEl  = document.getElementById("out");

    if (!bookEl || !wcEl || !devEl || !msgEl || !outEl) {
      alert("å¿…é ˆè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆIDåã®ã‚ºãƒ¬ã‚’ç¢ºèªï¼‰");
      return;
    }

    const book = bookEl.value.trim();
    const wc   = wcEl.value.trim();
    const dev  = devEl.checked ? "1" : "0";

    msgEl.textContent = "";
    outEl.innerHTML = "";

    if(!book || !wc){
      alert("Book ã¨ WorkCord ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
      return;
    }

    try {
      // Step1: Drive æ¤œç´¢
      msgEl.textContent = "ğŸ” Google Drive å†…ã‚’æ¤œç´¢ã—ã¦ã„ã¾ã™...";
      const r = await fetch(`/api/drive-find?book=${encodeURIComponent(book)}&wc=${encodeURIComponent(wc)}&dev=${dev}`, { cache: "no-store" });
      if (!r.ok) {
        const t = await r.text();
        throw new Error(`drive-find HTTP ${r.status}: ${t.slice(0,200)}`);
      }
      const j = await r.json();
      console.log("[drive-find] response:", j);

      if(!j.ok || !j.fileId){
        msgEl.textContent = "âŒ Google Drive ã«è©²å½“ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
        outEl.innerHTML = `<pre style="white-space:pre-wrap">${escapeHtml(JSON.stringify(j, null, 2))}</pre>`;
        return;
      }

      const fileId   = j.fileId;
      const fileName = j.fileName || `${book}-${wc}.bin`;
      msgEl.textContent = `âœ… è¦‹ã¤ã‹ã‚Šã¾ã—ãŸ: ${fileName}ï½œå–å¾—ä¸­...`;

      // Step2: Drive Proxy ã§å®Ÿä½“å–å¾—
      const rr = await fetch(`/api/drive-proxy?id=${encodeURIComponent(fileId)}&name=${encodeURIComponent(fileName)}&dev=${dev}`, { cache: "no-store" });
      if(!rr.ok){
        const t = await rr.text();
        throw new Error(`drive-proxy HTTP ${rr.status}: ${t.slice(0,200)}`);
      }

      const blob = await rr.blob();
      const objUrl = URL.createObjectURL(blob);
      console.log("[drive-proxy] blob:", blob.type, blob.size);

      // ç”»åƒ or PDF or ãã®ä»–ã§è¡¨ç¤ºåˆ‡æ›¿
      if (blob.type.startsWith("image/")) {
        outEl.innerHTML = `<img src="${objUrl}" alt="${escapeHtml(fileName)}"
            style="max-width:100%;height:auto;border:1px solid #ccc;border-radius:8px">`;
      } else if (blob.type === "application/pdf") {
        outEl.innerHTML = `<iframe src="${objUrl}" style="width:100%;height:75vh;border:1px solid #ccc;border-radius:8px"></iframe>`;
      } else {
        outEl.innerHTML = `<a href="${objUrl}" download="${escapeHtml(fileName)}">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (${escapeHtml(blob.type)})</a>`;
      }
      msgEl.textContent = `âœ… å›³é¢ã‚’å–å¾—ã—ã¾ã—ãŸ (${blob.type}, ${blob.size} bytes)`;

    } catch (e) {
      console.error(e);
      const msgEl = document.getElementById("msg");
      const outEl = document.getElementById("out");
      if(msgEl) msgEl.textContent = "âš ï¸ ã‚¨ãƒ©ãƒ¼: " + (e.message || e);
      if(outEl) outEl.innerHTML = "";
    }
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"]/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;" }[c]));
  }
})();
</script>



</body>
</html>
