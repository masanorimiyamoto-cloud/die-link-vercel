<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>QRã‚³ãƒ¼ãƒ‰ç…§ä¼šï½œç”Ÿç”£ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<style>
  :root{
    --ok:#1c7ed6; --ng:#e03131; --info:#0b7285;
    --tx:#212529; --sub:#6c757d; --bg:#f8f9fa; --bd:#dee2e6;
    --primary:#1c7ed6; --secondary:#6c757d; --success:#22c55e; --warning:#f59e0b;
  }
  html,body{margin:0;background:var(--bg);color:var(--tx);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  
  /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
  .page-header {
    background: #fff;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    border: 1px solid var(--bd);
  }
  .header-content {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
  }
  .back-btn {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 10px;
    transition: background 0.2s;
    color: var(--sub);
  }
  .back-btn:hover {
    background: #f1f3f5;
  }
  .header-text {
    flex: 1;
  }
  .header-text h1 {
    margin: 0 0 6px 0;
    font-size: 24px;
    font-weight: 700;
    color: var(--tx);
  }
  .subtitle {
    margin: 0;
    font-size: 14px;
    color: var(--sub);
  }
  .header-badges {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .status-badge {
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 12px;
    font-weight: 600;
    background: #e9ecef;
    color: #495057;
    border: 1px solid #dee2e6;
  }
  .status-badge.on {
    background: #e7f5ff;
    color: var(--ok);
    border-color: #a5d8ff;
  }
  .status-badge.off {
    background: #fff5f5;
    color: var(--ng);
    border-color: #ffc9c9;
  }

  /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
  .tab-nav {
    display: flex;
    background: #f8f9fa;
    border-radius: 12px;
    padding: 6px;
    gap: 4px;
  }
  .tab-btn {
    flex: 1;
    padding: 12px 16px;
    border: none;
    background: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    transition: all 0.2s;
    color: var(--sub);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }
  .tab-btn.active {
    background: #fff;
    color: var(--primary);
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  }
  .tab-btn .icon {
    font-size: 16px;
  }

  /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
  .tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
  }
  .tab-content.active {
    display: block;
  }
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* ã‚«ãƒ¼ãƒ‰ */
  .card {
    background: #fff;
    border: 1px solid var(--bd);
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    padding: 20px;
    margin-bottom: 20px;
    transition: box-shadow 0.2s;
  }
  .card:hover {
    box-shadow: 0 6px 20px rgba(0,0,0,0.08);
  }
  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    gap: 12px;
  }
  .card-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--tx);
    flex: 1;
  }

  /* ã‚¹ã‚­ãƒ£ãƒŠãƒ¼ */
  .scanner-container {
    position: relative;
  }
  .stack {
    position: relative;
    border: 1px solid var(--bd);
    border-radius: 12px;
    overflow: hidden;
    background: #000;
    margin-bottom: 16px;
  }
  video {
    display: block;
    width: 100%;
    max-width: 580px;
    background: #000;
    border-radius: 8px;
  }
  canvas {
    position: absolute;
    inset: 0;
    pointer-events: none;
    border-radius: 8px;
  }
  #freeze {
    z-index: 1;
    display: none;
  }
  #overlay {
    z-index: 2;
  }

  /* ã‚¹ã‚­ãƒ£ãƒ³ã‚¬ã‚¤ãƒ‰ */
  .scan-guide {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1;
    pointer-events: none;
  }
  .guide-frame {
    width: 200px;
    height: 200px;
    border: 3px solid #fff;
    border-radius: 12px;
    box-shadow: 0 0 0 1000px rgba(0,0,0,0.4);
    position: relative;
  }
  .guide-frame::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 180px;
    height: 180px;
    border: 2px dashed rgba(255,255,255,0.6);
    border-radius: 8px;
  }
  .guide-text {
    color: #fff;
    text-align: center;
    margin-top: 220px;
    font-weight: 600;
    font-size: 14px;
    text-shadow: 0 1px 3px rgba(0,0,0,0.7);
    background: rgba(0,0,0,0.7);
    padding: 8px 16px;
    border-radius: 20px;
    backdrop-filter: blur(10px);
  }

  /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
  .scanner-controls {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 16px;
  }
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border: none;
    border-radius: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    font-size: 14px;
    border: 1px solid transparent;
  }
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
  }
  .btn:not(:disabled):hover {
    transform: translateY(-2px);
  }
  .btn.primary {
    background: var(--primary);
    color: #fff;
    box-shadow: 0 2px 8px rgba(28,126,214,0.3);
  }
  .btn.primary:not(:disabled):hover {
    background: #1971c2;
    box-shadow: 0 4px 12px rgba(28,126,214,0.4);
  }
  .btn.secondary {
    background: var(--secondary);
    color: #fff;
  }
  .btn.outline {
    background: transparent;
    border: 1px solid var(--bd);
    color: var(--sub);
  }
  .btn.outline:hover {
    background: #f8f9fa;
    border-color: var(--primary);
    color: var(--primary);
  }
  .btn.icon {
    padding: 12px;
    aspect-ratio: 1;
  }
  .btn.large {
    padding: 14px 24px;
    font-size: 16px;
  }
  .btn-icon {
    font-size: 16px;
  }

  /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
  .scan-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .scan-status {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    border: 1px solid;
  }
  .scan-status.ready {
    background: #e7f5ff;
    color: var(--ok);
    border-color: #a5d8ff;
  }
  .scan-status.scanning {
    background: #fff9db;
    color: #e67700;
    border-color: #ffd8a8;
  }
  .scan-status.error {
    background: #fff5f5;
    color: var(--ng);
    border-color: #ffc9c9;
  }
  .scan-status.locked {
    background: #f3f0ff;
    color: #7048e8;
    border-color: #d0bfff;
  }

  /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
  .scanner-message {
    text-align: center;
  }
  .scanner-message p {
    margin: 0 0 8px 0;
    color: var(--sub);
    font-size: 14px;
  }
  .error-message {
    background: #fff5f5;
    color: var(--ng);
    padding: 12px 16px;
    border-radius: 8px;
    border: 1px solid #ffc9c9;
    font-size: 14px;
    font-weight: 500;
  }

  /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */
  .input-group {
    display: flex;
    gap: 16px;
    margin-bottom: 20px;
  }
  .input-field {
    flex: 1;
  }
  .input-field label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--tx);
    font-size: 14px;
  }
  .text-input {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--bd);
    border-radius: 10px;
    font-size: 14px;
    transition: all 0.2s;
    background: #fff;
  }
  .text-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(28,126,214,0.1);
  }
  .text-input::placeholder {
    color: #adb5bd;
  }

  .action-buttons {
    display: flex;
    gap: 12px;
  }
  .action-buttons .btn {
    flex: 1;
  }

  /* çµæœè¡¨ç¤º */
  .result-section {
    margin-bottom: 24px;
  }
  .result-content {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
  }
  .kvs {
    display: grid;
    grid-template-columns: max-content 1fr;
    gap: 8px 12px;
    font-size: 14px;
  }
  .kvs b {
    color: var(--sub);
    font-weight: 500;
    white-space: nowrap;
  }
  .kvs div {
    font-weight: 500;
    word-break: break-all;
  }
  .thumbs {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  .thumbs img {
    height: 60px;
    max-width: 100px;
    object-fit: contain;
    border: 1px solid #eee;
    border-radius: 6px;
    background: #fff;
    transition: transform 0.2s;
  }
  .thumbs img:hover {
    transform: scale(1.05);
  }
  .tbl {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
  }
  .tbl th, .tbl td {
    padding: 8px 10px;
    border: 1px solid #eee;
    vertical-align: top;
  }
  .tbl thead th {
    background: #f8f9fb;
    color: var(--sub);
    font-weight: 600;
  }
  .tbl tbody tr:hover {
    background: #fcfcff;
  }

  /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
  @media (max-width: 768px) {
    .wrap {
      padding: 12px;
    }
    .header-content {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
    }
    .header-badges {
      align-self: stretch;
      justify-content: flex-start;
    }
    .input-group {
      flex-direction: column;
      gap: 12px;
    }
    .scanner-controls {
      justify-content: center;
    }
    .guide-frame {
      width: 150px;
      height: 150px;
    }
    .guide-text {
      margin-top: 170px;
      font-size: 12px;
    }
    .tab-btn {
      padding: 10px 12px;
      font-size: 13px;
    }
    .grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }
  }

  /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }

  /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ */
  .muted {
    color: var(--sub);
    font-size: 13px;
  }
  .hint {
    padding: 12px;
    border: 1px dashed #ccc;
    border-radius: 10px;
    background: #fff9f0;
    color: #8c5b0c;
  }

  /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
  .toast {
    position: absolute;
    padding: 8px 12px;
    background: #000c;
    color: #fff;
    border-radius: 8px;
    font-size: 13px;
    transform: translate(-50%, -150%);
    pointer-events: none;
    animation: fade-out 1.2s forwards;
    z-index: 1000;
  }
  @keyframes fade-out {
    from { opacity: 1; }
    to { opacity: 0; }
  }

  /* ã‚¹ãƒ¯ã‚¤ãƒ—ãƒ’ãƒ³ãƒˆ */
  .swipe-hint {
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    background: rgba(33,37,41,.92);
    color: #fff;
    padding: 10px 14px;
    border-radius: 999px;
    font-size: 14px;
    box-shadow: 0 6px 16px rgba(0,0,0,.25);
    z-index: 9999;
    animation: hint-pop 1.6s ease-out forwards;
  }
  @keyframes hint-pop {
    0% { opacity: 0; transform: translateX(-50%) translateY(6px); }
    15% { opacity: 1; transform: translateX(-50%) translateY(0); }
    75% { opacity: 1; }
    100% { opacity: 0; transform: translateX(-50%) translateY(6px); }
  }

  /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
  #loading {
    display: none;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    color: var(--sub);
    margin: 20px 0;
    justify-content: center;
    padding: 20px;
  }
  @keyframes spin {
    from { transform: rotate(0); }
    to { transform: rotate(360deg); }
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- æ”¹è‰¯ã•ã‚ŒãŸãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="page-header">
    <div class="header-content">
      <button class="back-btn" onclick="history.back()" aria-label="æˆ»ã‚‹">â†</button>
      <div class="header-text">
        <h1>QRã‚³ãƒ¼ãƒ‰ç…§ä¼š</h1>
        <p class="subtitle">order/die QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ä»•æ§˜æƒ…å ±ã‚’ç¢ºèª</p>
      </div>
      <div class="header-badges">
        <span id="atState" class="status-badge off">AT:OFF</span>
        <span id="detectorInfo" class="status-badge">æº–å‚™ä¸­</span>
        <span id="csrfStatus" class="status-badge">CSRF:æ¤œæŸ»ä¸­</span>
      </div>
    </div>
    
    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="camera">
        <span class="icon">ğŸ“·</span>
        ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒ³
      </button>
      <button class="tab-btn" data-tab="manual">
        <span class="icon">âŒ¨ï¸</span>
        æ‰‹å…¥åŠ›
      </button>
      <button class="tab-btn" data-tab="results">
        <span class="icon">ğŸ“Š</span>
        ç…§ä¼šçµæœ
      </button>
    </div>
  </div>

  <!-- ã‚«ãƒ¡ãƒ©ã‚¹ã‚­ãƒ£ãƒ³ã‚¿ãƒ– -->
  <div class="tab-content active" id="camera-tab">
    <div class="card">
      <div class="card-header">
        <h3>QRã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h3>
        <div class="scan-indicator">
          <span id="scanStatus" class="scan-status ready">æº–å‚™å®Œäº†</span>
        </div>
      </div>
      
      <div class="scanner-container">
        <div class="stack" id="stack">
          <video id="video" playsinline webkit-playsinline muted></video>
          <canvas id="freeze"></canvas>
          <canvas id="overlay"></canvas>
          
          <!-- ã‚¹ã‚­ãƒ£ãƒ³ã‚¬ã‚¤ãƒ‰ -->
          <div class="scan-guide">
            <div class="guide-frame"></div>
            <div class="guide-text">QRã‚³ãƒ¼ãƒ‰ã‚’æ å†…ã«ã‹ã–ã—ã¦ãã ã•ã„</div>
          </div>
        </div>
        
        <div class="scanner-controls">
          <button id="btnStart" class="btn primary large">
            <span class="btn-icon">ğŸ“·</span>
            ã‚«ãƒ¡ãƒ©é–‹å§‹
          </button>
          <button id="btnStop" class="btn secondary" disabled>
            <span class="btn-icon">â¹ï¸</span>
            åœæ­¢
          </button>
          <button class="btn icon outline" id="btnFlipCamera" title="ã‚«ãƒ¡ãƒ©åˆ‡æ›¿" disabled>
            ğŸ”„
          </button>
          <label class="btn icon outline" style="cursor:pointer" title="ç”»åƒãƒ†ã‚¹ãƒˆ">
            ğŸ“
            <input id="fileTest" type="file" accept="image/*" style="display:none">
          </label>
        </div>
        
        <div class="scanner-message">
          <p id="scanMsg">order / die ã©ã¡ã‚‰ã§ã‚‚ã‹ã–ã™ã¨è‡ªå‹•ç…§ä¼šã—ã¾ã™</p>
          <div id="errCam" class="error-message" style="display:none"></div>
        </div>
      </div>
    </div>

    <!-- CSRFè¨­å®šã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
      <div class="card-header">
        <h3>æ¥ç¶šè¨­å®š</h3>
      </div>
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <span id="csrfStatusText" class="muted">CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®çŠ¶æ…‹ã‚’ç¢ºèªä¸­...</span>
        <button id="btnEnableCsrf" class="btn outline">CSRFã‚’æœ‰åŠ¹åŒ–</button>
      </div>
      <div id="csrfWarn" class="hint" style="display:none;margin-top:12px;">
        âš ï¸ CSRF Cookie (<code>xcsrf</code>) ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚<br>
        ä¸‹ã®ã€ŒCSRFã‚’æœ‰åŠ¹åŒ–ã€ã‚’æŠ¼ã™ã‹ã€ç¤¾å†…ãƒšãƒ¼ã‚¸ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
      </div>
    </div>
  </div>

  <!-- æ‰‹å…¥åŠ›ã‚¿ãƒ– -->
  <div class="tab-content" id="manual-tab">
    <div class="card">
      <div class="card-header">
        <h3>æ‰‹å…¥åŠ›ç…§ä¼š</h3>
        <span class="muted">Bookã¨WCã‚’ç›´æ¥æŒ‡å®šã—ã¦ç…§ä¼š</span>
      </div>
      
      <div class="input-group">
        <div class="input-field">
          <label for="inBook">Bookã‚³ãƒ¼ãƒ‰</label>
          <input type="text" id="inBook" placeholder="ä¾‹: Ta" class="text-input">
        </div>
        <div class="input-field">
          <label for="inWc">WCã‚³ãƒ¼ãƒ‰</label>
          <input type="text" id="inWc" placeholder="ä¾‹: 2356" class="text-input">
        </div>
      </div>
      
      <div class="action-buttons">
        <button id="btnFillTarget" class="btn outline">
          <span class="btn-icon">ğŸ“‹</span>
          ã‚¹ã‚­ãƒ£ãƒ³ä¸­ã®å€¤ã§åŸ‹ã‚ã‚‹
        </button>
        <button id="btnQuery" class="btn primary">
          <span class="btn-icon">ğŸ”</span>
          ç…§ä¼šå®Ÿè¡Œ
        </button>
      </div>
    </div>

    <!-- ç¾åœ¨ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¡¨ç¤º -->
    <div class="card">
      <div class="card-header">
        <h3>ç¾åœ¨ã®ç…§ä¼šå¯¾è±¡</h3>
      </div>
      <div style="display:flex;gap:20px;align-items:center;flex-wrap:wrap">
        <div style="display:flex;gap:8px;align-items:center;">
          <span class="muted">Book:</span>
          <span id="tBN" style="font-weight:600;font-size:16px;">-</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <span class="muted">WC:</span>
          <span id="tWC" style="font-weight:600;font-size:16px;">-</span>
        </div>
        <button id="btnOpenHtml" class="btn outline" disabled>
          <span class="btn-icon">ğŸ“„</span>
          è©³ç´°ã‚’åˆ¥ã‚¿ãƒ–ã§è¡¨ç¤º
        </button>
      </div>
    </div>
  </div>

  <!-- çµæœè¡¨ç¤ºã‚¿ãƒ– -->
  <div class="tab-content" id="results-tab">
    <div class="card">
      <div class="card-header">
        <h3>ç…§ä¼šçµæœ</h3>
        <div class="scan-indicator">
          <span class="muted" id="resultStatus">ãƒ‡ãƒ¼ã‚¿ã‚’ç…§ä¼šã—ã¦ãã ã•ã„</span>
        </div>
      </div>
      
      <div id="loading" style="display:none;margin:20px 0;">
        <div style="display:flex;align-items:center;gap:12px;justify-content:center;padding:20px;">
          <div style="width:24px;height:24px;border:3px solid #f1f3f5;border-top:3px solid var(--primary);border-radius:50%;animation:spin .8s linear infinite"></div>
          <span style="color:var(--sub);font-weight:600;">ç…§ä¼šä¸­...</span>
        </div>
      </div>
      
      <div id="errApi" class="error-message" style="display:none;margin:10px 0;"></div>

      <div id="result" style="display:none">
        <!-- çµæœè¡¨ç¤ºå†…å®¹ã¯å‹•çš„ã«ç”Ÿæˆ -->
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" crossorigin="anonymous"></script>
<script>
(() => {
  // ====== â–¼â–¼ è¨­å®šï¼šã“ã“ã ã‘ã§ ON/OFF â–¼â–¼ ======
  const FEATURE = {
    AIRTABLE_FETCH: false,   // â† â† â† ã“ã“ã‚’ false ã«ã™ã‚‹ã¨ Airtable å–å¾—ã‚’å®Œå…¨ã‚ªãƒ•
  };
  // ==============================================

  // ===== DOM =====
  const D = {
    video: document.getElementById('video'),
    overlay: document.getElementById('overlay'),
    freeze: document.getElementById('freeze'),
    stack: document.getElementById('stack'),
    btnStart: document.getElementById('btnStart'),
    btnStop: document.getElementById('btnStop'),
    fileTest: document.getElementById('fileTest'),
    detectorInfo: document.getElementById('detectorInfo'),
    scanStatus: document.getElementById('scanStatus'),
    scanMsg: document.getElementById('scanMsg'),
    errCam: document.getElementById('errCam'),
    errApi: document.getElementById('errApi'),
    loading: document.getElementById('loading'),
    tBN: document.getElementById('tBN'),
    tWC: document.getElementById('tWC'),
    result: document.getElementById('result'),
    inBook: document.getElementById('inBook'),
    inWc: document.getElementById('inWc'),
    btnQuery: document.getElementById('btnQuery'),
    btnFillTarget: document.getElementById('btnFillTarget'),
    btnOpenHtml: document.getElementById('btnOpenHtml'),
    csrfWarn: document.getElementById('csrfWarn'),
    csrfStatus: document.getElementById('csrfStatus'),
    btnEnableCsrf: document.getElementById('btnEnableCsrf'),
    atState: document.getElementById('atState'),
    csrfStatusText: document.getElementById('csrfStatusText'),
    resultStatus: document.getElementById('resultStatus'),
    btnFlipCamera: document.getElementById('btnFlipCamera')
  };

  const ctx = D.overlay.getContext('2d', { willReadFrequently:true });
  const freezeCtx = D.freeze.getContext('2d', { willReadFrequently:true });

  // Airtableã‚ªãƒ•æ™‚ã®è¨­å®š
  if(!FEATURE.AIRTABLE_FETCH){
    D.btnOpenHtml.disabled = true;
    D.btnOpenHtml.title = 'Airtableå–å¾—OFFä¸­';
    D.atState.textContent = 'AT:OFF';
    D.atState.className = 'status-badge off';
  } else {
    D.atState.textContent = 'AT:ON';
    D.atState.className = 'status-badge on';
  }

  // ===== Config =====
  const CFG = { JSQR_MAX_LOOPS: 10, DOWNSCALE: 1 };

  // ===== State =====
  const S = {
    stream: null,
    rafId: null,
    detector: null,
    useBarcodeDetector: ('BarcodeDetector' in window),
    current: { book:'', wc:'' },
    lastQueryKey: '',
    csrf: '',
    locked: false,
    facingMode: 'environment'
  };

  // ===== ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ =====
  document.addEventListener('DOMContentLoaded', function() {
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabBtns.forEach(btn => {
      btn.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        
        // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
        tabBtns.forEach(b => b.classList.remove('active'));
        tabContents.forEach(c => c.classList.remove('active'));
        
        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
        this.classList.add('active');
        document.getElementById(`${tabId}-tab`).classList.add('active');
        
        // ã‚«ãƒ¡ãƒ©ã‚¿ãƒ–ã«æˆ»ã£ãŸã¨ãã«ã‚«ãƒ¡ãƒ©ã‚’å†é–‹
        if (tabId === 'camera' && S.stream) {
          setTimeout(() => {
            fitOverlay();
          }, 100);
        }
      });
    });
    
    // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®æ”¹å–„
    document.querySelector('.back-btn').addEventListener('click', function() {
      if (S.stream) {
        stopCam();
      }
      history.back();
    });
  });

  // ===== Utils =====
  function readCookie(name){
    const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')+'=([^;]*)'));
    return m ? decodeURIComponent(m[1]) : '';
  }
  
  function normHyphen(s){ return (s||'').replace(/[â€-â€’â€“â€”â€•ãƒ¼âˆ’]/g,'-').trim(); }
  
  const dieKey = (bn,wc)=> `${(bn||'').toLowerCase()}@@${(wc||'').toLowerCase()}`;
  
  function setStatus(text, kind='ready'){
    D.scanStatus.textContent = text;
    D.scanStatus.className = `scan-status ${kind}`;
  }
  
  function showToastNear(text, pts){
    if(!pts || pts.length<2) return;
    const el = document.createElement('div');
    el.className = 'toast';
    el.textContent = text;
    const x = (pts[0].x + pts[1].x) / 2;
    const y = Math.min(pts[0].y, pts[1].y);
    const rx = x / D.overlay.width * D.video.clientWidth;
    const ry = y / D.overlay.height * D.video.clientHeight;
    el.style.left = rx + 'px';
    el.style.top = ry + 'px';
    D.stack.appendChild(el);
    setTimeout(() => {
      if (el.parentNode) {
        el.parentNode.removeChild(el);
      }
    }, 1200);
  }
  
  function drawBox(points, color, solid=true){
    if(!points || points.length<4) return;
    ctx.save();
    ctx.lineWidth = solid ? 5 : 3;
    ctx.setLineDash(solid ? [] : [8,6]);
    ctx.shadowColor = color;
    ctx.shadowBlur = 8;
    ctx.strokeStyle = color;
    ctx.beginPath();
    ctx.moveTo(points[0].x, points[0].y);
    for(let i=1; i<points.length; i++) {
      ctx.lineTo(points[i].x, points[i].y);
    }
    ctx.closePath();
    ctx.stroke();
    ctx.restore();
  }
  
  function fitOverlay(){
    if(!D.video.videoWidth) return;
    D.overlay.width = D.video.videoWidth;
    D.overlay.height = D.video.videoHeight;
    D.overlay.style.width = D.video.clientWidth + 'px';
    D.overlay.style.height = D.video.clientHeight + 'px';
    D.freeze.width = D.video.videoWidth;
    D.freeze.height = D.video.videoHeight;
    D.freeze.style.width = D.video.clientWidth + 'px';
    D.freeze.style.height = D.video.clientHeight + 'px';
  }

  // ===== CSRF bootstrap =====
  function isLocal(){
    return location.protocol === 'http:' && /localhost|127\.0\.0\.1/.test(location.host);
  }
  
  async function requestSession(){
    const url = isLocal() ? '/api/session?dev=1' : '/api/session';
    await fetch(url, { method:'GET', credentials:'same-origin', cache:'no-store' }).catch(()=>{});
  }
  
  async function ensureCsrf(){
    let t = readCookie('xcsrf');
    if(!t){
      await requestSession();
      t = readCookie('xcsrf');
    }
    if(!t) throw new Error('CSRF Cookie(xcsrf)ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
    S.csrf = t;
    D.csrfStatusText.textContent = 'CSRF: æœ‰åŠ¹';
    D.csrfStatus.className = 'status-badge on';
    D.csrfStatus.textContent = 'CSRF:æœ‰åŠ¹';
    D.csrfWarn.style.display = 'none';
  }
  
  // CSRFåˆæœŸåŒ–
  (async function initCsrf() {
    try {
      await ensureCsrf();
    } catch(e) {
      D.csrfStatusText.textContent = 'CSRF: ç„¡åŠ¹ï¼ˆæœªå–å¾—ï¼‰';
      D.csrfStatus.className = 'status-badge off';
      D.csrfStatus.textContent = 'CSRF:ç„¡åŠ¹';
      D.csrfWarn.style.display = 'block';
    }
  })();
  
  D.btnEnableCsrf.addEventListener('click', async () => {
    try {
      await requestSession();
      await ensureCsrf();
      showToastNear('CSRFã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ', [{x:100, y:100}, {x:200, y:200}]);
    } catch(e) {
      alert('CSRFã®å–å¾—ã«å¤±æ•—: ' + (e.message||e));
    }
  });

  // ===== Parse & classify =====
  function classify(raw){
    const t = normHyphen(raw);
    if(/^order[_-]?plain/i.test(t) || /^order-/i.test(t)) return 'order';
    if(/^die-/i.test(t)) return 'die';
    try {
      const u = new URL(t);
      if(/order[_-]?plain/i.test(u.pathname+u.search)) return 'order';
      if(u.searchParams.has('book') || u.searchParams.has('wc')) return 'die';
    } catch {}
    return 'other';
  }
  
  function parseOrder(raw){
    const t = normHyphen(raw);
    try {
      const u = new URL(t);
      if(/order[_-]?plain/i.test(u.pathname+u.search)){
        const book = (u.searchParams.get('book')||u.searchParams.get('Book')||'').trim();
        const wc = (u.searchParams.get('wc')||u.searchParams.get('WorkCord')||'').trim();
        if(book||wc) return { bn:book, wc:wc };
      }
    } catch {}
    const m = /order[_-]?plain[:\s-]+([^\s/:-]+)[\s/:-]+([^\s/:-]+)/i.exec(t) || /^order-([^-\n]+)-([^-]+)/i.exec(t);
    return m ? { bn:m[1].trim(), wc:m[2].trim() } : null;
  }
  
  function parseDie(raw){
    const t = normHyphen(raw);
    const m = /^die-([^-\n]+)-([^-]+)/i.exec(t);
    if(m) return { bn:m[1].trim(), wc:m[2].trim() };
    try {
      const u = new URL(t);
      const book = (u.searchParams.get('book')||'').trim();
      const wc = (u.searchParams.get('wc')||'').trim();
      if(book||wc) return { bn:book, wc:wc };
    } catch {}
    return null;
  }

  // ===== Camera =====
  function reallyStopStreamTracks(){
    if(S.stream){
      try {
        S.stream.getTracks().forEach(t => t.stop());
      } catch {}
    }
    S.stream = null;
  }
  
  function stopCam({keepFrame=false}={}){
    if(S.rafId) {
      cancelAnimationFrame(S.rafId);
      S.rafId = null;
    }
    if(!keepFrame){
      ctx.clearRect(0, 0, D.overlay.width, D.overlay.height);
      D.freeze.style.display = 'none';
      D.video.style.visibility = 'visible';
    }
    reallyStopStreamTracks();
    D.btnStart.disabled = false;
    D.btnStop.disabled = true;
    D.btnFlipCamera.disabled = true;
    setStatus('åœæ­¢ä¸­', 'ready');
  }
  
  async function startCam(){
    D.freeze.style.display = 'none';
    D.video.style.visibility = 'visible';
    S.locked = false;

    stopCam();
    D.errCam.style.display = 'none';
    D.errCam.textContent = '';
    
    try {
      S.stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: S.facingMode },
          width: { ideal: 1280, min: 640, max: 1920 },
          height: { ideal: 720, min: 480, max: 1080 },
          advanced: [{ focusMode: 'continuous' }]
        },
        audio: false
      });
      
      D.video.srcObject = S.stream;
      await D.video.play();
      D.btnStart.disabled = true;
      D.btnStop.disabled = false;
      D.btnFlipCamera.disabled = false;

      if(S.useBarcodeDetector){
        try {
          const fmts = (typeof BarcodeDetector.getSupportedFormats === 'function') ?
            await BarcodeDetector.getSupportedFormats() : [];
          if(!fmts || !fmts.includes('qr_code')) throw new Error('qr_code unsupported');
          S.detector = new BarcodeDetector({ formats: ['qr_code'] });
        } catch {
          S.useBarcodeDetector = false;
          S.detector = null;
        }
      }
      
      D.detectorInfo.textContent = S.useBarcodeDetector ? 'BarcodeDetector' : 'jsQR';
      setStatus('æ¢ç´¢ä¸­â€¦', 'scanning');
      fitOverlay();
      tick();
    } catch(e) {
      D.errCam.style.display = 'block';
      D.errCam.textContent = `âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ${e.name||''} ${e.message||e}`;
      setStatus('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼', 'error');
    }
  }

  // ã‚«ãƒ¡ãƒ©åˆ‡æ›¿æ©Ÿèƒ½
  D.btnFlipCamera.addEventListener('click', async () => {
    S.facingMode = S.facingMode === 'environment' ? 'user' : 'environment';
    await startCam();
  });

  function freezeFrameAndStopCam(){
    try {
      fitOverlay();
      freezeCtx.clearRect(0, 0, D.freeze.width, D.freeze.height);
      freezeCtx.drawImage(D.video, 0, 0, D.freeze.width, D.freeze.height);
      D.freeze.style.display = 'block';
      D.video.style.visibility = 'hidden';
    } catch {}
    stopCam({keepFrame:true});
    setStatus('ãƒ­ãƒƒã‚¯ä¸­', 'locked');
  }

  // ===== MULTI-PASS DETECTOR =====
  async function detectCombined(){
    if(!D.video.videoWidth) return [];
    const scale = Math.max(1, Number(CFG.DOWNSCALE)||1);
    const srcW = D.video.videoWidth, srcH = D.video.videoHeight;
    const w = Math.floor(srcW/scale), h = Math.floor(srcH/scale);

    const tmp = document.createElement('canvas');
    tmp.width = w;
    tmp.height = h;
    const tctx = tmp.getContext('2d', { willReadFrequently:true });
    tctx.imageSmoothingEnabled = false;
    tctx.drawImage(D.video, 0, 0, w, h);

    const all = new Map();

    if(S.useBarcodeDetector && S.detector){
      try {
        const codes = await S.detector.detect(tmp);
        for(const c of codes){
          const raw = (c.rawValue||'').trim();
          if(raw && !all.has(raw)) {
            all.set(raw, {
              rawValue: raw,
              cornerPoints: c.cornerPoints?.map(p => ({ x:p.x*scale, y:p.y*scale })) || null
            });
          }
        }
      } catch {
        S.useBarcodeDetector = false;
        S.detector = null;
      }
    }

    const img = tctx.getImageData(0, 0, w, h);
    const masked = new Uint8ClampedArray(img.data);
    for(let k=0; k<CFG.JSQR_MAX_LOOPS; k++){
      const hit = jsQR(masked, w, h, { inversionAttempts: 'attemptBoth' });
      if(!hit) break;
      const raw = (hit.data||'').trim();
      if(raw && !all.has(raw)){
        const pts = [
          hit.location.topLeftCorner,
          hit.location.topRightCorner,
          hit.location.bottomRightCorner,
          hit.location.bottomLeftCorner
        ].map(p => ({ x:p.x*scale, y:p.y*scale }));
        all.set(raw, { rawValue: raw, cornerPoints: pts });
      }
      const tl = hit.location.topLeftCorner;
      const br = hit.location.bottomRightCorner;
      const minX = Math.max(0, Math.floor(Math.min(tl.x, br.x)));
      const maxX = Math.min(w, Math.ceil(Math.max(tl.x, br.x)));
      const minY = Math.max(0, Math.floor(Math.min(tl.y, br.y)));
      const maxY = Math.min(h, Math.ceil(Math.max(tl.y, br.y)));
      for(let y=minY; y<maxY; y++){
        for(let x=minX; x<maxX; x++){
          const i = (y * w + x) * 4;
          masked[i] = masked[i+1] = masked[i+2] = 255;
        }
      }
    }
    return Array.from(all.values());
  }

  async function tick(){
    if(!S.stream) return;
    if(D.video.readyState === D.video.HAVE_ENOUGH_DATA){
      fitOverlay();
      ctx.clearRect(0, 0, D.overlay.width, D.overlay.height);
      const ds = await detectCombined();
      applyDetections(ds);
    }
    S.rafId = requestAnimationFrame(tick);
  }

  function applyDetections(ds){
    for(const d of ds){
      const raw = (d.rawValue||'').trim();
      if(!raw) continue;
      const kind = classify(raw);
      const pts = d.cornerPoints;
      
      if(kind === 'order'){
        const od = parseOrder(raw);
        if(od && (od.bn || od.wc)){
          drawBox(pts, '#f59f00', true);
          showToastNear(`order: ${od.bn||'-'}/${od.wc||'-'}`, pts);
          setTarget(od.bn||'', od.wc||'');
          querySpec();
        } else {
          drawBox(pts, '#e03131', false);
          showToastNear('order(ä¸æ˜å½¢å¼)', pts);
        }
      } else if(kind === 'die'){
        const p = parseDie(raw);
        if(p && (p.bn || p.wc)){
          drawBox(pts, '#1c7ed6', true);
          showToastNear('ãƒ­ãƒƒã‚¯ï½œã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è¨­å®šã—ã¾ã—ãŸ', pts);
          setTarget(p.bn||'', p.wc||'');

          if(!S.locked){
            S.locked = true;
            freezeFrameAndStopCam();
            showSwipeHint();
            querySpec();
          }
        } else {
          drawBox(pts, '#e03131', false);
          showToastNear('die(ä¸æ˜å½¢å¼)', pts);
        }
      } else {
        drawBox(pts, '#e03131', false);
        showToastNear('åˆ¥QR', pts);
      }
    }
  }

  function setTarget(book, wc){
    S.current.book = String(book||'').trim();
    S.current.wc = String(wc||'').trim();
    D.tBN.textContent = S.current.book || '-';
    D.tWC.textContent = S.current.wc || '-';
    
    // çµæœã‚¿ãƒ–ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    if(S.current.book && S.current.wc){
      D.resultStatus.textContent = `ç…§ä¼šå¯¾è±¡: ${S.current.book} / ${S.current.wc}`;
      D.btnOpenHtml.disabled = !FEATURE.AIRTABLE_FETCH;
    }
  }

  // ===== Query to /api/die-check (JSON) =====
  async function querySpec(){
    const book = S.current.book, wc = S.current.wc;
    if(!book || !wc) return;
    const key = dieKey(book, wc);
    if(key === S.lastQueryKey) return;
    S.lastQueryKey = key;

    D.errApi.style.display = 'none';
    D.errApi.textContent = '';
    D.loading.style.display = 'block';
    D.result.style.display = 'none';
    D.resultStatus.textContent = 'ç…§ä¼šä¸­...';

    try {
      if(!S.csrf) {
        await ensureCsrf();
      }

      const body = {
        book,
        wc,
        json: true,
        limit: FEATURE.AIRTABLE_FETCH ? 200 : 0,
        noAirtable: !FEATURE.AIRTABLE_FETCH,
        gsOnly: !FEATURE.AIRTABLE_FETCH
      };

      const r = await fetch('/api/die-check', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF': S.csrf
        },
        body: JSON.stringify(body)
      });
      
      const txt = await r.text();
      let j = {};
      try {
        j = JSON.parse(txt);
      } catch {
        throw new Error(`JSON Parse error: ${txt.slice(0,200)}`);
      }
      if(!r.ok || j.ok !== true){
        throw new Error(j?.error || `HTTP ${r.status}: ${txt.slice(0,200)}`);
      }

      if(!FEATURE.AIRTABLE_FETCH){
        j.hits = [];
        j.note = 'Airtable fetch disabled on client';
      }
      
      renderResult(j);
      D.resultStatus.textContent = `ç…§ä¼šå®Œäº†: ${book} / ${wc}`;
      
      // çµæœã‚¿ãƒ–ã«è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ
      const resultsTab = document.querySelector('[data-tab="results"]');
      if(resultsTab) resultsTab.click();
      
    } catch(e) {
      D.errApi.style.display = 'block';
      D.errApi.textContent = `âŒ APIã‚¨ãƒ©ãƒ¼: ${e?.message || e}`;
      D.resultStatus.textContent = 'ç…§ä¼šã‚¨ãƒ©ãƒ¼';
    } finally {
      D.loading.style.display = 'none';
    }
  }

  function renderResult(payload){
    const { gs, hits = [], book, workcord } = payload || {};

    // çµæœè¡¨ç¤ºç”¨HTMLã‚’å‹•çš„ã«æ§‹ç¯‰
    let resultHTML = `
      <div class="grid">
        <div class="result-section">
          <h3 style="margin:0 0 12px 0;font-size:16px;color:var(--tx);">ğŸ“Š Google Sheetsï¼ˆä»•æ§˜ï¼‰</h3>
          <div class="result-content">
    `;

    // Sheets æƒ…å ±
    if(gs){
      resultHTML += `
        <div class="kvs">
          <b>ItemName</b><div>${esc(gs.ItemName||'')}</div>
          <b>Kname</b><div>${esc(gs.Kname||'')}</div>
          <b>Material</b><div>${esc(gs.Material||'')}</div>
          <b>Paper_Size</b><div>${esc(gs.Paper_Size||'')}</div>
          <b>Cut_Size</b><div>${esc(gs.Cut_Size||'')}</div>
          <b>Location</b><div>${esc(gs.Location||'')}</div>
          <b>LastSeen</b><div>${esc(gs.LastSeen||'')}</div>
          <b>Ndate</b><div>${esc(gs.Ndate||'')}</div>
        </div>
      `;
    } else {
      resultHTML += `<div class="muted" style="padding:20px;text-align:center;">ï¼ˆGoogle Sheets ã«ä¸€è‡´è¡Œãªã—ï¼‰</div>`;
    }

    resultHTML += `
          </div>
        </div>
        <div class="result-section">
          <h3 style="margin:0 0 12px 0;font-size:16px;color:var(--tx);">ğŸ“ Airtableï¼ˆå—æ³¨ãƒ»å›³é¢ï¼‰</h3>
          <div class="result-content">
    `;

    // Airtable æƒ…å ±
    if(!FEATURE.AIRTABLE_FETCH){
      resultHTML += `<div class="muted" style="padding:20px;text-align:center;">ï¼ˆAirtableç…§ä¼šã¯ç¾åœ¨OFFï¼‰</div>`;
    } else if(hits.length > 0){
      const latest = hits[0];
      const atts = (latest.attachments||[]).slice(0,4);
      const thumbs = atts.map(a => {
        const isImg = String(a.type||'').startsWith('image/');
        const thumb = (a.thumbnails && (a.thumbnails.small?.url || a.thumbnails.large?.url)) || a.url;
        return isImg
          ? `<a href="${esc(a.url)}" target="_blank" rel="noopener noreferrer" referrerpolicy="no-referrer" style="display:block;">
               <img src="${esc(thumb)}" alt="${esc(a.filename||'')}" style="height:60px;max-width:100px;object-fit:contain;border:1px solid #eee;border-radius:6px;">
             </a>`
          : `<a href="${esc(a.url)}" target="_blank" rel="noopener noreferrer" referrerpolicy="no-referrer" style="display:inline-block;padding:4px 8px;background:#e9ecef;border-radius:4px;font-size:12px;text-decoration:none;color:var(--tx);">
               ${esc(a.filename||'æ·»ä»˜')}
             </a>`;
      });

      resultHTML += `
        <div>
          <div class="kvs" style="margin-bottom:12px;">
            <b>æœ€ã‚‚æ—©ã„ç´æœŸ</b><div style="font-weight:600;color:var(--ok);">${esc(latest.ndate||'')}</div>
            <b>å“å</b><div>${esc(latest.itemName||'')}</div>
            <b>æ•°é‡</b><div>${latest.amount ?? ''}</div>
            <b>Kname</b><div>${esc(latest.kname||'')}</div>
            <b>Material</b><div>${esc(latest.material||'')}</div>
            <b>Paper_Size</b><div>${esc(latest.paperSize||'')}</div>
            <b>Cut_Size</b><div>${esc(latest.cutSize||'')}</div>
          </div>
          <div><b>å›³é¢ãƒ»æ·»ä»˜</b></div>
          <div class="thumbs" style="margin-top:8px;gap:8px;">${thumbs.join('') || '<span class="muted">ï¼ˆæ·»ä»˜ãªã—ï¼‰</span>'}</div>
          ${ (latest.attachments||[]).length > 4 ? `<div class="muted" style="margin-top:8px;">â€¦ä»– ${(latest.attachments.length-4)} ä»¶</div>` : '' }
        </div>
      `;
    } else {
      resultHTML += `<div class="muted" style="padding:20px;text-align:center;">ï¼ˆã“ã®æŠœå‹ã«ç´ã¥ãå—æ³¨ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼‰</div>`;
    }

    resultHTML += `
          </div>
        </div>
      </div>
    `;

    // å—æ³¨ä¸€è¦§
    if(FEATURE.AIRTABLE_FETCH && hits.length > 0){
      resultHTML += `
        <div class="result-section">
          <h3 style="margin:0 0 12px 0;font-size:16px;color:var(--tx);">ğŸ“‹ é–¢é€£å—æ³¨ï¼ˆç´æœŸã®æ—©ã„é †ï¼‰</h3>
          <div style="overflow-x:auto;">
            <table class="tbl">
              <thead>
                <tr>
                  <th>ç´æœŸ</th><th>å“å</th><th>æ•°é‡</th><th>Material</th><th>Paper</th><th>Cut</th><th>ç”»åƒ</th><th>Kname</th>
                </tr>
              </thead>
              <tbody>
      `;

      resultHTML += hits.map(r => {
        const a = (r.attachments||[])[0];
        let cell = 'â€”';
        if(a){
          const isImg = String(a.type||'').startsWith('image/');
          const thumb = (a.thumbnails && (a.thumbnails.small?.url || a.thumbnails.large?.url)) || a.url;
          cell = isImg
            ? `<a href="${esc(a.url)}" target="_blank" rel="noopener noreferrer" referrerpolicy="no-referrer">
                 <img src="${esc(thumb)}" alt="" style="height:40px;max-width:80px;object-fit:contain;border:1px solid #eee;border-radius:4px">
               </a>`
            : `<a href="${esc(a.url)}" target="_blank" rel="noopener noreferrer" referrerpolicy="no-referrer" style="font-size:12px;">${esc(a.filename||'æ·»ä»˜')}</a>`;
          if((r.attachments||[]).length > 1) {
            cell += ` <span class="muted" style="font-size:11px;">(+${r.attachments.length-1})</span>`;
          }
        }
        return `
          <tr>
            <td style="font-weight:600;">${esc(r.ndate||'')}</td>
            <td>${esc(r.itemName||'')}</td>
            <td style="text-align:right;">${r.amount ?? ''}</td>
            <td>${esc(r.material||'')}</td>
            <td>${esc(r.paperSize||'')}</td>
            <td>${esc(r.cutSize||'')}</td>
            <td>${cell}</td>
            <td>${esc(r.kname||'')}</td>
          </tr>
        `;
      }).join('');

      resultHTML += `
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    D.result.innerHTML = resultHTML;
    D.result.style.display = 'block';
    D.inBook.value = book || '';
    D.inWc.value = workcord || '';
  }

  // åˆ¥ã‚¿ãƒ– HTMLè¡¨ç¤º
  D.btnOpenHtml.addEventListener('click', async () => {
    if(!FEATURE.AIRTABLE_FETCH){
      alert('Airtableç…§ä¼šãŒOFFã®ãŸã‚ã€è©³ç´°è¡¨ç¤ºã¯åˆ©ç”¨ã§ãã¾ã›ã‚“');
      return;
    }
    const book = S.current.book, wc = S.current.wc;
    if(!book || !wc){
      alert('å…ˆã« QR ã‚’èª­ã¾ã›ã‚‹ã‹ã€æ‰‹å…¥åŠ›ã§ Book / WC ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚');
      return;
    }
    try {
      if(!S.csrf) {
        await ensureCsrf();
      }
      const r = await fetch('/api/die-check', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF': S.csrf
        },
        body: JSON.stringify({ book, wc, json: false, limit: 200 })
      });
      const html = await r.text();
      if(!r.ok) throw new Error(html.slice(0,300));
      const w = window.open('', '_blank');
      if(!w) throw new Error('ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
      w.document.open();
      w.document.write(html);
      w.document.close();
    } catch(e) {
      alert('HTMLè¡¨ç¤ºã«å¤±æ•—: ' + (e.message||e));
    }
  });

  // æ‰‹å…¥åŠ›ç…§ä¼š
  D.btnQuery.addEventListener('click', () => {
    setTarget(D.inBook.value, D.inWc.value);
    if(!S.current.book || !S.current.wc){
      alert('Book / WC ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      return;
    }
    S.lastQueryKey = '';
    querySpec();
  });
  
  D.btnFillTarget.addEventListener('click', () => {
    D.inBook.value = S.current.book || '';
    D.inWc.value = S.current.wc || '';
  });

  // ã‚«ãƒ¡ãƒ©åˆ¶å¾¡
  D.btnStart.addEventListener('click', startCam);
  D.btnStop.addEventListener('click', () => stopCam());
  window.addEventListener('resize', fitOverlay);

  // ç”»åƒé™æ­¢ç”»ãƒ†ã‚¹ãƒˆ
  D.fileTest.addEventListener('change', async ev => {
    const file = ev.target.files?.[0];
    if(!file) return;
    const img = new Image();
    img.onload = () => {
      const c = document.createElement('canvas');
      c.width = img.width;
      c.height = img.height;
      const cctx = c.getContext('2d', { willReadFrequently: true });
      cctx.imageSmoothingEnabled = false;
      cctx.drawImage(img, 0, 0);
      const data = cctx.getImageData(0, 0, c.width, c.height);
      const hits = jsqrMulti(data);
      D.overlay.width = c.width;
      D.overlay.height = c.height;
      ctx.clearRect(0, 0, D.overlay.width, D.overlay.height);
      for(const h of hits){
        drawBox(h.cornerPoints, '#1c7ed6', true);
      }
      if(hits[0]){
        const raw = hits[0].rawValue;
        const kind = classify(raw);
        if(kind === 'order'){
          const od = parseOrder(raw);
          if(od){
            setTarget(od.bn||'', od.wc||'');
          }
        } else if(kind === 'die'){
          const d = parseDie(raw);
          if(d){
            setTarget(d.bn||'', d.wc||'');
          }
        }
        S.lastQueryKey = '';
        querySpec();
      }
      ev.target.value = "";
    };
    img.src = URL.createObjectURL(file);
  });

  function jsqrMulti(imgData){
    const hits = [];
    const w = imgData.width, h = imgData.height;
    const masked = new Uint8ClampedArray(imgData.data);
    for(let k=0; k<CFG.JSQR_MAX_LOOPS; k++){
      const hit = jsQR(masked, w, h, { inversionAttempts: 'attemptBoth' });
      if(!hit) break;
      hits.push({
        rawValue: hit.data,
        cornerPoints: [
          hit.location.topLeftCorner,
          hit.location.topRightCorner,
          hit.location.bottomRightCorner,
          hit.location.bottomLeftCorner
        ]
      });
      const tl = hit.location.topLeftCorner;
      const br = hit.location.bottomRightCorner;
      const minX = Math.max(0, Math.floor(Math.min(tl.x, br.x)));
      const maxX = Math.min(w, Math.ceil(Math.max(tl.x, br.x)));
      const minY = Math.max(0, Math.floor(Math.min(tl.y, br.y)));
      const maxY = Math.min(h, Math.ceil(Math.max(tl.y, br.y)));
      for(let y=minY; y<maxY; y++){
        for(let x=minX; x<maxX; x++){
          const i = (y * w + x) * 4;
          masked[i] = masked[i+1] = masked[i+2] = 255;
        }
      }
    }
    return hits;
  }

  // URL ã§äº‹å‰æŒ‡å®š
  (function initFromParams(){
    const p = new URLSearchParams(location.search);
    const book = (p.get('book')||'').trim();
    const wc = (p.get('wc')||'').trim();
    if(book || wc){
      setTarget(book, wc);
      S.lastQueryKey = '';
      querySpec();
    }
  })();

  function showSwipeHint(){
    const el = document.createElement('div');
    el.className = 'swipe-hint';
    el.textContent = 'ä¸‹ã«ã‚¹ãƒ¯ã‚¤ãƒ—ã—ã¦æƒ…å ±ã‚’ç¢ºèª';
    document.body.appendChild(el);
    setTimeout(() => {
      if (el.parentNode) {
        el.parentNode.removeChild(el);
      }
    }, 1800);
  }

  function esc(s){
    return String(s??'').replace(/[&<>"]/g, c => ({
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;'
    }[c]));
  }
})();
</script>
</body>
</html>