<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>æŠœå‹ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼ QRï¼ˆé«˜è§£åƒåº¦/ã‚ºãƒ¼ãƒ UIãªã—ãƒ»ãƒˆãƒƒãƒ—ãƒãƒ¼å›ºå®šï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    :root {
      --ok: #1c7ed6; --ng: #e03131; --loc: #2b8a3e; --info:#f59f00;
      --bd: #dee2e6; --tx: #212529; --sub: #6c757d; --bg: #f8f9fa;
      --bg-ok: #e7f5ff; --bg-ng: #fff5f5; --bg-loc: #e6fcf5;
    }
    html,body{margin:0;background:var(--bg);color:var(--tx);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}

    /* â˜… å¸¸æ™‚è¡¨ç¤ºã®ãƒˆãƒƒãƒ—ãƒãƒ¼ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚å›ºå®šï¼‰ */
    .topbar{
      position: sticky; top: 0; z-index: 1000;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      padding:10px; background:#fff; border-bottom:1px solid var(--bd);
      box-shadow: 0 4px 12px rgba(0,0,0,.06);
    }
    .chip{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--bd);background:#fff;font-size:12px;font-weight:700}
    .chip.ok{background:#e7f5ff;color:#1c7ed6;border-color:#a5d8ff}
    .chip.ng{background:#fff5f5;color:#e03131;border-color:#ffc9c9}
    .chip.loc{background:var(--bg-loc);color:var(--loc);border-color:#96f2d7}
    .btn{padding:10px 14px;border:1px solid var(--bd);border-radius:10px;background:#fff;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--ok);color:#fff;border-color:var(--ok)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .wrap{max-width:1200px;margin:0 auto;padding:12px}
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start}
    .panel{flex:1 1 360px;min-width:320px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    h3,h4{margin:0 0 8px 0}
    .muted{color:var(--sub);font-size:14px}
    .legend{font-size:12px;color:#555;margin-top:8px}
    .stack{position:relative;border:1px solid var(--bd);border-radius:12px;overflow:hidden;background:#000}
    video{display:block;width:100%;max-width:520px;border-radius:12px;background:#000}
    canvas{position:absolute;inset:0;pointer-events:none}
    #overlay{z-index:2} #freeze{z-index:1;display:none}

    /* ã‚¬ã‚¤ãƒ‰ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆä¸­å¿ƒæ ï¼‰ */
    .target-scope{
      position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
      width:200px;height:200px;border:2px solid rgba(28,126,214,0.8);border-radius:12px;
      pointer-events:none;z-index:10;box-shadow:0 0 0 9999px rgba(0,0,0,.3);
    }
    .target-scope .corner-tl,.target-scope .corner-tr,.target-scope .corner-bl,.target-scope .corner-br{
      position:absolute;width:20px;height:20px;border:3px solid rgba(28,126,214,0.8)}
    .target-scope .corner-tl{top:-2px;left:-2px;border-right:none;border-bottom:none;border-radius:4px 0 0 0}
    .target-scope .corner-tr{top:-2px;right:-2px;border-left:none;border-bottom:none;border-radius:0 4px 0 0}
    .target-scope .corner-bl{bottom:-2px;left:-2px;border-right:none;border-top:none;border-radius:0 0 0 4px}
    .target-scope .corner-br{bottom:-2px;right:-2px;border-left:none;border-top:none;border-radius:0 0 4px 0}
    .target-scope .scan-line{position:absolute;top:0;left:0;width:100%;height:2px;background:linear-gradient(90deg,transparent,rgba(28,126,214,.8),transparent);animation:scan 2s linear infinite}
    @keyframes scan{0%{top:0}100%{top:100%}}

    .toast{position:absolute;padding:8px 12px;background:#000c;color:#fff;border-radius:8px;font-size:14px;transform:translate(-50%,-150%);pointer-events:none;animation:fade-out 1.2s forwards}
    @keyframes fade-out{from{opacity:1}to{opacity:0}}

    .bigmsg{
      position:fixed;left:50%;top:18%;transform:translateX(-50%);z-index:1200;
      background:rgba(28,126,214,.95);color:#fff;padding:16px 22px;border-radius:12px;font-size:clamp(18px,3.2vw,26px);
      box-shadow:0 8px 24px rgba(0,0,0,.2);letter-spacing:.02em;text-align:center;pointer-events:none;animation:bigmsg-fade 1.2s ease-out forwards
    }
    .bigmsg .sub{display:block;font-size:.8em;opacity:.9;margin-top:2px}
    @keyframes bigmsg-fade{0%{opacity:0;transform:translateX(-50%) translateY(-8px)}10%{opacity:1;transform:translateX(-50%) translateY(0)}80%{opacity:1}100%{opacity:0;transform:translateX(-50%) translateY(-8px)}}

    .kvs{display:grid;grid-template-columns:max-content 1fr;gap:6px 10px;font-size:14px}
    .kvs b{color:#333}

    /* æ£šã‚«ãƒ¼ãƒ‰ï¼šå¤§ããå³å¯„ã›è¡¨ç¤º */
    .shelf-card{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .shelf-label{font-weight:700;font-size:clamp(18px,3.5vw,28px);color:var(--sub);margin:0}
    .shelf-value{margin-left:auto;text-align:right;font-weight:800;font-size:clamp(24px,5vw,36px);letter-spacing:.02em;padding:2px 0}

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå±¥æ­´ï¼‰ */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,.5)}
    .modal-content{background:#fff;margin:10% auto;padding:20px;border:1px solid var(--bd);width:90%;max-width:640px;border-radius:12px}
    .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--bd);padding-bottom:10px;margin-bottom:10px}
    .close-button{color:#aaa;font-size:28px;font-weight:bold;cursor:pointer}
    #historyList li{padding:6px 0;border-bottom:1px solid #eee;font-size:14px}
  </style>
</head>
<body>

  <!-- â˜… å¸¸æ™‚è¡¨ç¤ºãƒˆãƒƒãƒ—ãƒãƒ¼ -->
  <div class="topbar">
    <button id="btnStart" class="btn primary">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
    <button id="btnStop" class="btn" disabled>åœæ­¢</button>
    <span id="scanStatus" class="chip">å¾…æ©Ÿä¸­</span>
    <span id="detectorInfo" class="chip">æ¤œå‡ºå™¨: â€”</span>
    <span id="csrfStatus" class="chip">CSRF: æ¤œæŸ»ä¸­â€¦</span>
    <span id="targetNow" class="chip">Target: â€” / â€”</span>
  </div>

  <div class="wrap">
    <div class="row">
      <!-- å·¦ï¼šã‚«ãƒ¡ãƒ© -->
      <div class="panel">
        <div class="card">
          <h4>ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³</h4>
          <div class="stack" id="stack">
            <video id="video" playsinline muted></video>
            <canvas id="overlay"></canvas>
          </div>
          <div class="legend">
            <span class="chip ok">ä¸€è‡´(å‹)</span>
            <span class="chip loc">ä¸€è‡´(æ£š)</span>
            <span class="chip ng">ä¸ä¸€è‡´</span>
            <span class="chip" style="cursor:pointer">é™æ­¢ç”»ãƒ†ã‚¹ãƒˆ<input id="fileTest" type="file" accept="image/*" style="display:none" /></span>
          </div>
          <div id="error" class="muted" style="color:#b00;white-space:pre-wrap;margin-top:8px;"></div>
        </div>
      </div>

      <!-- å³ï¼šæƒ…å ± -->
      <div class="panel">
        <div class="card">
          <h4>ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</h4>
          <div class="kvs">
            <b>Book</b><div id="tgtBN">-</div>
            <b>WC</b><div id="tgtWC">-</div>
            <b>WorkName</b><div id="tgtWN" class="muted">â€”</div>
          </div>
        </div>

        <div class="card shelf-card">
          <h4 class="shelf-label">æ¢ã™ã¹ãæ£šï¼š</h4>
          <div id="currentShelf" class="shelf-value">ï¼ˆURLæœªæŒ‡å®šï¼‰</div>
        </div>

        <div class="card">
          <h4>âš™ï¸ æ“ä½œ</h4>
          <div class="legend" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <button id="btnHistory">ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´</button>
            <!-- æ‰‹å…¥åŠ›ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®šï¼ˆå¾“æ¥ã©ãŠã‚Šæ®‹ã™ï¼‰ -->
            <label>Book:
              <select id="inBook" style="padding:8px 10px;border:1px solid var(--bd);border-radius:10px;font-size:14px">
                <option value="" disabled selected>é¸æŠ</option>
                <option value="Ko">Ko</option>
                <option value="Ta">Ta</option>
                <option value="Yo">Yo</option>
              </select>
            </label>
            <label>WC:
              <input id="inWc" type="text" placeholder="ä¾‹: 2356" style="padding:8px 10px;border:1px solid var(--bd);border-radius:10px;font-size:14px;min-width:10ch">
            </label>
            <button id="btnSetTarget" class="btn">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®š</button>
          </div>
          <div class="muted" style="font-size:12px;margin-top:6px">
            ãƒ»Order QRï¼ˆorder_plainï¼‰ã‚’èª­ã‚ã°è‡ªå‹•ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®šã•ã‚Œã¾ã™ã€‚<br>
            ãƒ»Book ã¯ Ko / Ta / Yo ã‹ã‚‰é¸æŠã§ãã¾ã™ã€‚
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h4>Google Sheetsï¼ˆä»•æ§˜ï¼‰</h4>
            <span id="loading" class="muted" style="display:none">ç…§ä¼šä¸­â€¦</span>
          </div>
          <div id="gsBox" class="kvs"><div class="muted">ï¼ˆæœªå–å¾—ï¼‰</div></div>
          <div id="errApi" class="muted" style="display:none;margin-top:6px"></div>
        </div>

        <div class="card">
          <h4>Google Driveï¼ˆå›³é¢ï¼‰</h4>
          <div id="driveStatus" class="muted">â€”</div>
          <div id="driveView" style="margin-top:6px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="historyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h4>ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´</h4>
        <span id="closeModal" class="close-button">&times;</span>
      </div>
      <ul id="historyList"></ul>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" crossorigin="anonymous"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const DOM = {
      // Topbar
      btnStart: $('#btnStart'), btnStop: $('#btnStop'),
      scanStatus: $('#scanStatus'), detectorInfo: $('#detectorInfo'),
      csrfStatus: $('#csrfStatus'), targetNow: $('#targetNow'),
      // Camera
      stack: $('#stack'), video: $('#video'), overlay: $('#overlay'),
      fileTest: $('#fileTest'), error: $('#error'),
      // Target
      tgtBN: $('#tgtBN'), tgtWC: $('#tgtWC'), tgtWN: $('#tgtWN'),
      currentShelf: $('#currentShelf'),
      // Ops / history
      btnHistory: $('#btnHistory'), historyModal: $('#historyModal'),
      historyList: $('#historyList'), closeModal: $('#closeModal'),
      inBook: $('#inBook'), inWc: $('#inWc'), btnSetTarget: $('#btnSetTarget'),
      // Spec / drive
      loading: $('#loading'), gsBox: $('#gsBox'), errApi: $('#errApi'),
      driveStatus: $('#driveStatus'), driveView: $('#driveView')
    };
    const ctx = DOM.overlay.getContext('2d', { willReadFrequently:true });

    const state = {
      stream:null, rafId:null,
      detector:null, useBarcodeDetector: ('BarcodeDetector' in window),
      isLocked:false, holdTimer:null,
      currentTarget:{ book:'', wc:'', wn:'' }, targetKey:'',
      currentShelf:null,
      scanHistory:new Map(),
      __lastOrderKey:'', __orderSetAt:0,
      csrf:''
    };

    /* ==== å°ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==== */
    function $(s){ return document.querySelector(s); }
    function esc(s){ return String(s??'').replace(/[&<>"]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    const isLocal = () => location.protocol==='http:' && /localhost|127\.0\.0\.1/.test(location.host);
    const readCookie = name => { const m=document.cookie.match(new RegExp('(?:^|; )'+name.replace(/[-/\\^$*+?.()|[\\]{}]/g,'\\$&')+'=([^;]*)')); return m?decodeURIComponent(m[1]):''; };
    const dieKey = (bn,wc)=>`${(bn||'').trim().toLowerCase()}@@${(wc||'').trim().toLowerCase()}`;
    const normalizeHyphen = s => (s||"").replace(/[â€-â€’â€“â€”â€•ãƒ¼âˆ’]/g,"-").trim();

    async function ensureCsrf(){
      let t = readCookie('xcsrf');
      if(!t){ const url = isLocal()?'/api/session?dev=1':'/api/session'; await fetch(url,{method:'GET',credentials:'same-origin',cache:'no-store'}).catch(()=>{}); t = readCookie('xcsrf'); }
      if(t){ state.csrf=t; DOM.csrfStatus.textContent='CSRF: æœ‰åŠ¹'; DOM.csrfStatus.className='chip ok'; }
      else { DOM.csrfStatus.textContent='CSRF: æœªå–å¾—'; DOM.csrfStatus.className='chip ng'; }
    }

    /* ==== TTSï¼ˆæ®ãˆç½®ãï¼‰ ==== */
    let __jpVoices=[]; let __lastSpeak=0; let __lastLocSpeak=0; let __lastGenericSpeak=0;
    const __speakCooldownMs=1500, __locSpeakCooldownMs=3000;
    function initTTS(){ if(!('speechSynthesis' in window)) return;
      const synth=window.speechSynthesis;
      function load(){ const voices=synth.getVoices(); __jpVoices=voices.filter(v => /ja|jpn|æ—¥æœ¬èª/i.test(v.lang)||/æ—¥æœ¬èª/i.test(v.name)); }
      load(); synth.onvoiceschanged=load;
    }
    function unlockTTS(){ if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(' '); u.lang='ja-JP'; u.volume=0; try{ speechSynthesis.speak(u);}catch{} }
    const punct = s => String(s||"").replace(/\s+/g,' ').trim();
    function speakAfterReady(u){ if(!('speechSynthesis' in window)) return; const synth=window.speechSynthesis; try{ synth.cancel(); }catch{}; if(__jpVoices.length) u.voice=__jpVoices[0]; try{ synth.speak(u);}catch{} }
    function speakLineOnce(text,{rate=1.08,pitch=1.4,cooldown=1200}={}){ if(!('speechSynthesis' in window)) return; const now=performance.now(); if(now-__lastGenericSpeak<cooldown) return; __lastGenericSpeak=now; const u=new SpeechSynthesisUtterance(punct(text)); u.lang='ja-JP';u.rate=rate;u.pitch=pitch;u.volume=1.0; speakAfterReady(u); }
    function speakFoundOnce(workName){ if(!('speechSynthesis' in window)) return; const now=performance.now(); if(now-__lastSpeak<__speakCooldownMs) return; __lastSpeak=now; const txt = workName ? `ãŠæ¢ã—ã®å‹ã€${workName}ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚` : `ãŠæ¢ã—ã®å‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚`; const u=new SpeechSynthesisUtterance(punct(txt)); u.lang='ja-JP'; u.rate=1.0; u.pitch=1.1; u.volume=1.0; speakAfterReady(u); }
    function speakTargetLocFound(){ if(!('speechSynthesis' in window)) return; const now=performance.now(); if(now-__lastLocSpeak<__locSpeakCooldownMs) return; __lastLocSpeak=now; const u=new SpeechSynthesisUtterance('ç›®çš„ã®æ£šã§ã™'); u.lang='ja-JP'; u.rate=1.0; u.pitch=1.1; u.volume=0.8; speakAfterReady(u); }
    function promptScanShelf(){ if(state.currentShelf){ speakLineOnce(`æ£š ${state.currentShelf} ã®å‹ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚`,{cooldown:2500}); } else { speakLineOnce(`æ£šã®QRã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„ã€‚`,{cooldown:2500}); } }

    /* ==== ç¨®åˆ¥åˆ¤å®š/ãƒ‘ãƒ¼ã‚¹ ==== */
    const classify = (raw) => {
      const text = normalizeHyphen((raw || "").trim());
      if (/^loc-/i.test(text)) return "loc";
      try { const url = new URL(text); if (url.searchParams.has("loc")) return "loc"; } catch {}
      if (/^die-/i.test(text)) return "die";
      try { const url = new URL(text); if (url.searchParams.has("book") || url.searchParams.has("wc")) return "die"; } catch {}
      if (/^order-/i.test(text)) return "order";
      if (/order[_-]?plain/i.test(text)) return "order";
      try { const url = new URL(text); if (/order[_-]?plain/i.test(url.pathname + url.search)) return "order"; } catch {}
      return "other";
    };
    const tryExtractWN = (rawUrl) => {
      try {
        const u = new URL(rawUrl);
        const m = /[#&]d=([^&]+)/.exec(u.hash || "");
        if (!m) return "";
        const b64 = m[1].replace(/-/g, '+').replace(/_/g, '/');
        const pad = b64.length % 4 ? '='.repeat(4 - (b64.length % 4)) : '';
        const json = atob(b64 + pad);
        const obj = JSON.parse(json);
        return (obj.wn || "").trim();
      } catch { return ""; }
    };
    const parseDie = (raw) => {
      const t = normalizeHyphen((raw || "").trim());
      let m = /^die-([^-\n]+)-([^-]+)(?:-(.+))?$/i.exec(t);
      if (m) return { bn: m[1].trim(), wc: m[2].trim(), wn: (m[3] || "").trim() };
      try { const u=new URL(t); const bn=(u.searchParams.get("book")||"").trim(); const wc=(u.searchParams.get("wc")||"").trim(); if(bn||wc){ const wnParam=(u.searchParams.get("wn")||"").trim(); const wnHash=tryExtractWN(t); return { bn, wc, wn: wnParam||wnHash}; } } catch {}
      return null;
    };
    const parseLoc = (raw) => {
      const t = normalizeHyphen((raw || "").trim());
      let m = /^loc-(.+)$/i.exec(t);
      if (m) return { loc: m[1].trim() };
      try { const u=new URL(t); const loc=(u.searchParams.get("loc")||"").trim(); if(loc) return { loc }; } catch {}
      return null;
    };
    const parseOrderPlain = (raw) => {
      const t = normalizeHyphen((raw || "").trim());
      let m = /^order-([^-\n]+)-([^-]+)(?:-(.+))?$/i.exec(t);
      if (m) return { bn: m[1].trim(), wc: m[2].trim() };
      try {
        const url = new URL(t);
        if (/order[_-]?plain/i.test(url.pathname + url.search)) {
          const book = (url.searchParams.get("book") || url.searchParams.get("Book") || "").trim();
          const wc   = (url.searchParams.get("wc")   || url.searchParams.get("WorkCord") || "").trim();
          if (book || wc) return { bn: book, wc };
        }
      } catch {}
      m = /order(?:[_-]?plain)?[:\s-]+([^\s/:-]+)[\s/:-]+([^\s/:-]+)/i.exec(t);
      return m ? { bn: m[1].trim(), wc: m[2].trim() } : null;
    };

    /* ==== UIæç”» ==== */
    function fitOverlay(){
      if(DOM.video.videoWidth===0) return;
      DOM.overlay.width = DOM.video.videoWidth;
      DOM.overlay.height= DOM.video.videoHeight;
      DOM.overlay.style.width  = DOM.video.clientWidth + 'px';
      DOM.overlay.style.height = DOM.video.clientHeight + 'px';
    }
    function updateStatus(text,type=''){ DOM.scanStatus.textContent=text; DOM.scanStatus.className='chip '+(type?type:''); }
    function drawBox(points,color,label,style='solid',alpha=1){
      if(!points||points.length<4) return;
      ctx.save(); ctx.globalAlpha=alpha;
      const isNG = (color === '#e03131');
      ctx.lineWidth = isNG ? 4 : (color === '#1c7ed6' ? 5 : 3);
      ctx.setLineDash(style==='dashed'?[8,6]:[]);
      ctx.shadowColor=color; ctx.shadowBlur=4; ctx.strokeStyle=color;
      ctx.beginPath(); ctx.moveTo(points[0].x,points[0].y); for(let i=1;i<points.length;i++) ctx.lineTo(points[i].x,points[i].y); ctx.closePath(); ctx.stroke(); ctx.restore();
    }
    function showToastNearBox(text,pts){
      if(!pts||pts.length<2) return;
      const el=document.createElement('div'); el.className='toast'; el.textContent=text;
      const x=(pts[0].x+pts[1].x)/2, y=Math.min(pts[0].y,pts[1].y);
      const rx=x/DOM.overlay.width*DOM.video.clientWidth; const ry=y/DOM.overlay.height*DOM.video.clientHeight;
      el.style.left=rx+'px'; el.style.top=ry+'px'; DOM.stack.appendChild(el); setTimeout(()=>el.remove(),1200);
    }
    function showBigMessage(text,sub=""){
      document.querySelectorAll('.bigmsg').forEach(el=>el.remove());
      const el=document.createElement('div'); el.className='bigmsg'; el.textContent=text;
      if(sub){ const s=document.createElement('span'); s.className='sub'; s.textContent=sub; el.appendChild(s); }
      document.body.appendChild(el); setTimeout(()=>el.remove(),1500);
    }
    function addTargetScope(){
      const exist=document.querySelector('.target-scope'); if(exist) exist.remove();
      const scope=document.createElement('div'); scope.className='target-scope';
      ['tl','tr','bl','br'].forEach(k=>{ const d=document.createElement('div'); d.className='corner-'+k; scope.appendChild(d); });
      const line=document.createElement('div'); line.className='scan-line'; scope.appendChild(line);
      DOM.stack.appendChild(scope);
    }

    /* ==== ã‚«ãƒ¡ãƒ© ==== */
    async function startCam(){
      stopCam();
      DOM.error.textContent='';
      try{
        // æ¨™æº– 1280x720ï¼ˆé«˜è§£åƒåº¦/ã‚ºãƒ¼ãƒ ã®UIã¯æ’¤å»ã—ãŸãŸã‚å›ºå®šé‹ç”¨ï¼‰
        state.stream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720}, frameRate:{ideal:30} },
          audio:false
        });
        DOM.video.srcObject = state.stream;
        await DOM.video.play();
        DOM.btnStart.disabled=true; DOM.btnStop.disabled=false;

        // æ¤œå‡ºå™¨è¡¨ç¤º
        if(state.useBarcodeDetector){
          try{ state.detector=new BarcodeDetector({formats:['qr_code']}); }
          catch{ state.useBarcodeDetector=false; state.detector=null; }
        }
        DOM.detectorInfo.textContent = state.useBarcodeDetector ? 'æ¤œå‡ºå™¨: BarcodeDetector' : 'æ¤œå‡ºå™¨: jsQR';

        fitOverlay(); addTargetScope(); tick();
        updateStatus('æ¢ç´¢ä¸­â€¦');
      }catch(e){
        console.error(e);
        DOM.error.textContent = `âŒ ${e.name||''} ${e.message||e}`;
        updateStatus('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼','ng');
      }
    }
    function stopCam(){
      if(state.rafId) cancelAnimationFrame(state.rafId); state.rafId=null;
      if(state.stream){ try{ state.stream.getTracks().forEach(t=>t.stop()); }catch{} }
      state.stream=null;
      DOM.btnStart.disabled=false; DOM.btnStop.disabled=true; updateStatus('åœæ­¢ä¸­');
    }
    function holdScan(ms){
      if(state.holdTimer) clearTimeout(state.holdTimer);
      if(state.rafId) cancelAnimationFrame(state.rafId); state.rafId=null;
      updateStatus('ãƒ­ãƒƒã‚¯ä¸­','ok');
      state.holdTimer=setTimeout(()=>{ if(!state.rafId) tick(); state.holdTimer=null; }, ms);
    }

    /* ==== æ¤œå‡º ==== */
    async function detectCombined(){
      if(!DOM.video.videoWidth) return [];
      // å‹•ç”»ãƒ•ãƒ«è§£åƒåº¦ã§1æšã‚¹ãƒŠãƒƒãƒ—
      const c=document.createElement('canvas'); c.width=DOM.video.videoWidth; c.height=DOM.video.videoHeight;
      const tctx=c.getContext('2d',{willReadFrequently:true}); tctx.drawImage(DOM.video,0,0,c.width,c.height);
      const all=new Map();

      if(state.useBarcodeDetector && state.detector){
        try{ const codes=await state.detector.detect(c); for(const cd of codes){ const raw=(cd.rawValue||'').trim(); if(raw && !all.has(raw)) all.set(raw, {rawValue:raw, cornerPoints:cd.cornerPoints}); } }
        catch(e){ console.warn('BarcodeDetectorå¤±æ•—',e); }
      }

      const img=tctx.getImageData(0,0,c.width,c.height);
      const masked=new Uint8ClampedArray(img.data);
      for(let k=0;k<10;k++){
        const hit=jsQR(masked,img.width,img.height,{ inversionAttempts:'dontInvert' });
        if(!hit) break;
        const raw=(hit.data||'').trim();
        if(raw && !all.has(raw)){
          all.set(raw,{ rawValue:raw, cornerPoints:[
            hit.location.topLeftCorner, hit.location.topRightCorner,
            hit.location.bottomRightCorner, hit.location.bottomLeftCorner
          ]});
        }
        const {topLeftCorner, bottomRightCorner}=hit.location;
        for(let y=Math.floor(topLeftCorner.y); y<Math.ceil(bottomRightCorner.y); y++){
          for(let x=Math.floor(topLeftCorner.x); x<Math.ceil(bottomRightCorner.x); x++){
            const i=(y*img.width+x)*4; masked[i]=masked[i+1]=masked[i+2]=255;
          }
        }
      }
      return Array.from(all.values());
    }

    function isDetectionInScope(cornerPoints){
      if(!cornerPoints||cornerPoints.length<4) return false;
      const stackW=DOM.stack.clientWidth, stackH=DOM.stack.clientHeight; if(!stackW||!stackH) return true;
      const scopeCssSize=200, scopeCssX=(stackW/2)-(scopeCssSize/2), scopeCssY=(stackH/2)-(scopeCssSize/2);
      const scaleX=DOM.overlay.width/stackW, scaleY=DOM.overlay.height/stackH;
      const scopeX=scopeCssX*scaleX, scopeY=scopeCssY*scaleY, scopeW=scopeCssSize*scaleX, scopeH=scopeCssSize*scaleY;
      const marginX=12*scaleX, marginY=12*scaleY;
      for(const pt of cornerPoints){
        if(pt.x<scopeX-marginX) return false;
        if(pt.x>scopeX+scopeW+marginX) return false;
        if(pt.y<scopeY-marginY) return false;
        if(pt.y>scopeY+scopeH+marginY) return false;
      }
      return true;
    }

    function updateHistory(raw,kind,isMatch){
      if(state.scanHistory.has(raw)) return;
      state.scanHistory.set(raw,{kind,isMatch,time:new Date()});
    }

    function applyDetections(detections){
      let anyMatch=false, anyLocMatch=false;
      ctx.clearRect(0,0,DOM.overlay.width,DOM.overlay.height);

      for(const d of (detections||[])){
        const raw=(d.rawValue||'').trim(); if(!raw) continue;
        const pts=d.cornerPoints;
        if(!isDetectionInScope(pts)){ drawBox(pts,'#e03131','ã‚¬ã‚¤ãƒ‰å¤–','dashed',0.3); continue; }

        const kind=classify(raw);
        if(kind==='die'){
          const p=parseDie(raw);
          const key=p?dieKey(p.bn,p.wc):'';
          const isMatch= key && key===state.targetKey; anyMatch = anyMatch || isMatch;
          drawBox(pts, isMatch?'#1c7ed6':'#e03131', isMatch?'ä¸€è‡´':'ä¸ä¸€è‡´', isMatch?'solid':'dashed');
          updateHistory(raw,'die',isMatch);
          if(isMatch && !state.isLocked){
            state.isLocked=true;
            if(navigator.vibrate) navigator.vibrate(150);
            showBigMessage('ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚','ä¸€è‡´ã—ãŸQRã‚’é’æ ã§å¼·èª¿è¡¨ç¤ºã—ã¦ã„ã¾ã™');
            showToastNearBox('ãƒ­ãƒƒã‚¯',pts);
            speakFoundOnce(state.currentTarget.wn || (p&&p.wn) || '');
            holdScan(3000);
            setTimeout(()=>{ state.isLocked=false; },700);
          }
        }else if(kind==='loc'){
          const locData=parseLoc(raw);
          const isLocMatch = state.currentShelf && locData && locData.loc.toLowerCase()===state.currentShelf.toLowerCase();
          anyLocMatch = anyLocMatch || isLocMatch;
          drawBox(pts, isLocMatch?'#2b8a3e':'#e03131', isLocMatch?`æ£š ä¸€è‡´ [${locData?.loc}]`:`æ£š é•ã„ [${locData?.loc||'?'}]`, isLocMatch?'solid':'dashed');
          updateHistory(raw,'loc',!!isLocMatch);
          if(isLocMatch) { showToastNearBox('ç›®çš„ã®æ£šã§ã™',pts); speakTargetLocFound(); }
          else if(state.currentShelf){ showToastNearBox(`æ£šãŒé•ã„ã¾ã™ (â†’ ${state.currentShelf})`,pts); }
        }else if(kind==='order'){
          const od=parseOrderPlain(raw);
          if(od && (od.bn||od.wc)){
            const newKey=dieKey(od.bn, od.wc);
            const now=performance.now();
            const same=(newKey===state.__lastOrderKey);
            const cooling=(now - state.__orderSetAt) < 2000;

            drawBox(pts,'#f59f00',`ä½œæ¥­æŒ‡ç¤º [${od.bn||'-'}/${od.wc||'-'}]`,'solid');
            updateHistory(raw,'order',true);

            if(!same || !cooling || newKey!==state.targetKey){
              setTarget(od.bn||'', od.wc||'', '');
              state.__lastOrderKey=newKey; state.__orderSetAt=now;
              showBigMessage('ä½œæ¥­æŒ‡ç¤ºQRã‚’èª­ã¿å–ã‚Šã¾ã—ãŸ','ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’è¨­å®šã—ã¾ã—ãŸã€€æŠœå‹ã®QRã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„');
              showToastNearBox('ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ›´æ–°',pts);
              speakLineOnce(`ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ book ${state.currentTarget.book} ã€ ${state.currentTarget.wc} ã«è¨­å®šã—ã¾ã—ãŸã€‚ã€€æŠœå‹ã®QRã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„`,{cooldown:2500});
              if(!state.currentShelf){ fetchShelfFromGSheet(state.currentTarget.book, state.currentTarget.wc); } else { promptScanShelf(); }
              holdScan(800);
            }
          }else{
            drawBox(pts,'#e03131','ä½œæ¥­æŒ‡ç¤ºï¼ˆå½¢å¼ä¸æ˜ï¼‰','dashed'); updateHistory(raw,'order',false);
          }
        }else{
          drawBox(pts,'#e03131','åˆ¥QR','dashed'); updateHistory(raw,'other',false);
        }
      }

      if(!state.holdTimer){
        let msg='æ¢ç´¢ä¸­...'; let type='';
        if(detections.length>0){
          if(anyMatch){ msg='ã‚¿ãƒ¼ã‚²ãƒƒãƒˆç™ºè¦‹'; type='ok'; }
          else if(anyLocMatch){ msg='ç›®çš„ã®æ£šã‚’æ¤œçŸ¥'; type='loc'; }
          else { msg=`${detections.length}ä»¶æ¤œçŸ¥`; type='ng'; }
        }
        updateStatus(msg,type);
      }
    }

    async function tick(){
      if(!state.stream) return;
      if(DOM.video.readyState===DOM.video.HAVE_ENOUGH_DATA){
        fitOverlay();
        const detections = await detectCombined();
        applyDetections(detections);
      }
      state.rafId = requestAnimationFrame(tick);
    }

    /* ==== ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ/æ£š ==== */
    function setTarget(book,wc,wn=''){
      state.currentTarget = { book:(book||'').trim(), wc:(wc||'').trim(), wn:(wn||'').trim() };
      state.targetKey = dieKey(state.currentTarget.book, state.currentTarget.wc);
      DOM.tgtBN.textContent = state.currentTarget.book || '-';
      DOM.tgtWC.textContent = state.currentTarget.wc || '-';
      DOM.tgtWN.textContent = state.currentTarget.wn || 'â€”';
      DOM.targetNow.textContent = `Target: ${DOM.tgtBN.textContent} / ${DOM.tgtWC.textContent}`;
    }

    async function fetchShelfFromGSheet(book,wc){
      if(!book||!wc) return;
      if(state.currentShelf && state.currentShelf!=='ï¼ˆURLæœªæŒ‡å®šï¼‰') return;

      DOM.currentShelf.textContent='ï¼ˆæ£šæƒ…å ±ã‚’å–å¾—ä¸­â€¦ï¼‰'; DOM.currentShelf.className='shelf-value';
      let ok=false;
      try{
        const csrf=await ensureCsrf();
        const r=await fetch('/api/die-check',{ method:'POST', credentials:'same-origin',
          headers:{'Content-Type':'application/json', ...(csrf?{'X-CSRF':csrf}:{})},
          body:JSON.stringify({ book, wc, json:true, limit:1 })
        });
        const txt=await r.text(); let j={}; try{ j=JSON.parse(txt);}catch{ throw new Error('JSON parse error'); }
        if(!r.ok || j.ok!==true) throw new Error(j?.error||`HTTP ${r.status}`);
        const gs=j.gs||j.GS||j.sheet||{};
        const loc=(gs.Location??gs.location??gs.Loc??gs.loc??'').toString().trim();
        if(loc){ state.currentShelf=loc; DOM.currentShelf.textContent=loc; DOM.currentShelf.className='shelf-value'; ok=true; promptScanShelf(); }
        else { DOM.currentShelf.textContent='ï¼ˆGSheetã«æ£šæƒ…å ±ãªã—ï¼‰'; DOM.currentShelf.className='shelf-value'; }
      }catch(e){ console.warn('æ£šæƒ…å ±POSTå¤±æ•—',e); }
      if(ok) return;

      try{
        const qs=new URLSearchParams({book,wc,json:'1',limit:'1'}).toString();
        const r2=await fetch('/api/die-check?'+qs,{credentials:'same-origin'});
        const t2=await r2.text(); let j2={}; try{ j2=JSON.parse(t2);}catch{ throw new Error('JSON parse error'); }
        if(!r2.ok || j2.ok!==true) throw new Error(j2?.error||`HTTP ${r2.status}`);
        const gs2=j2.gs||j2.GS||j2.sheet||{};
        const loc2=(gs2.Location??gs2.location??gs2.Loc??gs2.loc??'').toString().trim();
        if(loc2){ state.currentShelf=loc2; DOM.currentShelf.textContent=loc2; DOM.currentShelf.className='shelf-value'; promptScanShelf(); }
        else { DOM.currentShelf.textContent='ï¼ˆGSheetã«æ£šæƒ…å ±ãªã—ï¼‰'; DOM.currentShelf.className='shelf-value'; }
      }catch(e){
        console.warn('æ£šæƒ…å ±GETå¤±æ•—',e);
        DOM.currentShelf.textContent='ï¼ˆæ£šæƒ…å ±ã®å–å¾—ã«å¤±æ•—ï¼‰'; DOM.currentShelf.className='shelf-value';
      }
    }

    /* ==== ä»•æ§˜ï¼‹å›³é¢ ==== */
    async function querySpec(){
      const {book,wc}=state.currentTarget; if(!book||!wc) return;
      DOM.errApi.style.display='none'; DOM.errApi.textContent=''; DOM.loading.style.display='inline';
      DOM.gsBox.innerHTML='<div class="muted">å–å¾—ä¸­â€¦</div>'; DOM.driveStatus.textContent='â€”'; DOM.driveView.innerHTML='';
      try{
        if(!state.csrf) await ensureCsrf();
        const r=await fetch('/api/die-check',{ method:'POST', credentials:'same-origin',
          headers:{'Content-Type':'application/json', ...(state.csrf?{'X-CSRF':state.csrf}:{})},
          body:JSON.stringify({ book, wc, json:true, limit:0, noAirtable:true, gsOnly:true })
        });
        const txt=await r.text(); let j={}; try{ j=JSON.parse(txt);}catch{ throw new Error(`JSON Parse error: ${txt.slice(0,200)}`); }
        if(!r.ok || j.ok!==true) throw new Error(j?.error||`HTTP ${r.status}`);
        renderSpec(j);
        openDriveFigure((j.book||book),(j.workcord||wc));
      }catch(e){
        DOM.errApi.style.display='block'; DOM.errApi.textContent='âŒ APIã‚¨ãƒ©ãƒ¼: '+(e.message||e);
        DOM.gsBox.innerHTML='<div class="muted">ï¼ˆGoogle Sheets ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰</div>';
      }finally{ DOM.loading.style.display='none'; }
    }

    function renderSpec(payload){
      const gs = payload?.gs || {};
      if(gs && (gs.ItemName||gs.Kname||gs.Material)){
        DOM.gsBox.innerHTML=`
          <div class="kvs">
            <b>ItemName</b><div>${esc(gs.ItemName||'')}</div>
            <b>Kname</b><div>${esc(gs.Kname||'')}</div>
            <b>Material</b><div>${esc(gs.Material||'')}</div>
            <b>Paper_Size</b><div>${esc(gs.Paper_Size||'')}</div>
            <b>Cut_Size</b><div>${esc(gs.Cut_Size||'')}</div>
            <b>Location</b><div>${esc(gs.Location||'')}</div>
            <b>LastSeen</b><div>${esc(gs.LastSeen||'')}</div>
            <b>Ndate</b><div>${esc(gs.Ndate||'')}</div>
          </div>`;
      }else{
        DOM.gsBox.innerHTML='<div class="muted">ï¼ˆä¸€è‡´è¡Œãªã—ï¼‰</div>';
      }
      const loc=(gs?.Location??gs?.Loc??'').toString().trim();
      if(loc){ state.currentShelf=loc; DOM.currentShelf.textContent=loc; DOM.currentShelf.className='shelf-value'; }
    }

    async function openDriveFigure(book,wc){
      if(!book||!wc){ DOM.driveStatus.textContent='Book/WC æœªæŒ‡å®š'; DOM.driveView.innerHTML=''; return; }
      DOM.driveStatus.textContent='æ¤œç´¢ä¸­â€¦'; DOM.driveView.innerHTML='';
      try{
        const r=await fetch(`/api/drive-find?book=${encodeURIComponent(book)}&wc=${encodeURIComponent(wc)}`,{ credentials:'same-origin', cache:'no-store' });
        if(!r.ok){ const t=await r.text().catch(()=> ''); throw new Error(`drive-find HTTP ${r.status}: ${t.slice(0,200)}`); }
        const j=await r.json().catch(()=> ({}));
        if(j?.ok!==true){ DOM.driveStatus.textContent='NG: å¿œç­”ä¸æ­£'; return; }
        const cands = Array.isArray(j.candidates)&&j.candidates.length ? j.candidates : (j.fileId ? [{id:j.fileId,name:j.fileName||`${book}-${wc}`}]:[]);
        if(cands.length===0){ DOM.driveStatus.textContent='ä¸€è‡´ãƒ•ã‚¡ã‚¤ãƒ«ãªã—'; DOM.driveView.innerHTML=''; return; }

        const score = f => { const n=(f?.name||'').toLowerCase(); const isPdf=n.endsWith('.pdf'); const isImg=/\.(jpeg|jpg|png)$/.test(n);
          const hasZu=/-zu\.(jpeg|jpg|png)$/.test(n); const hasSi=/-si\.(jpeg|jpg|png)$/.test(n);
          if(isImg&&hasZu) return 1; if(isImg&&hasSi) return 2; if(isImg) return 3; if(isPdf) return 9; return 99; };
        cands.sort((a,b)=>score(a)-score(b));
        const primary=cands[0];
        const isPdf=(primary.name||'').toLowerCase().endsWith('.pdf');
        const src=`/api/drive-proxy?id=${encodeURIComponent(primary.id)}&name=${encodeURIComponent(primary.name||`${book}-${wc}`)}`;
        DOM.driveView.innerHTML = isPdf
          ? `<iframe src="${src}" style="width:100%;height:60vh;border:1px solid #e9ecef;border-radius:10px"></iframe>`
          : `<img src="${src}" alt="${esc(primary.name||'figure')}" style="max-width:100%;height:auto;border:1px solid #e9ecef;border-radius:10px;background:#fff" />`;
        DOM.driveStatus.textContent = `ãƒ’ãƒƒãƒˆ: ${cands.length}ï¼ˆè¡¨ç¤º: ${primary.name||'-'}ï¼‰`;
      }catch(e){ DOM.driveStatus.textContent='NG: '+(e.message||e); DOM.driveView.innerHTML=''; }
    }

    /* ==== å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« ==== */
    function showHistoryModal(){
      DOM.historyList.innerHTML='';
      if(state.scanHistory.size===0){ DOM.historyList.innerHTML='<li>ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</li>'; }
      else{
        const items=Array.from(state.scanHistory.entries()).reverse();
        for(const [raw,data] of items){
          const li=document.createElement('li');
          let status=''; if(data.kind==='die'){ status=data.isMatch?'âœ”ï¸ ä¸€è‡´ (å‹)':'âŒ ä¸ä¸€è‡´ (å‹)'; }
          else if(data.kind==='loc'){ status=data.isMatch?'âœ”ï¸ ä¸€è‡´ (æ£š)':'âŒ ä¸ä¸€è‡´ (æ£š)'; }
          else if(data.kind==='order'){ status='ğŸ§¾ ä½œæ¥­æŒ‡ç¤º èª­ã¿å–ã‚Š'; }
          else{ status='â“ ãã®ä»–'; }
          li.innerHTML = `<strong>${status}:</strong> ${raw.substring(0,60)}${raw.length>60?'...':''}`;
          DOM.historyList.appendChild(li);
        }
      }
      DOM.historyModal.style.display='block';
    }

    /* ==== ã‚¤ãƒ™ãƒ³ãƒˆ ==== */
    DOM.btnStart.addEventListener('click', ()=>{ initTTS(); unlockTTS(); startCam(); });
    DOM.btnStop.addEventListener('click', stopCam);
    window.addEventListener('resize', fitOverlay);
    DOM.btnHistory.addEventListener('click', showHistoryModal);
    DOM.closeModal.addEventListener('click', ()=> DOM.historyModal.style.display='none');
    window.addEventListener('click', (ev)=>{ if(ev.target===DOM.historyModal) DOM.historyModal.style.display='none'; });

    // æ‰‹å…¥åŠ›ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®šï¼ˆå¾“æ¥ã©ãŠã‚Šï¼‰
    if(DOM.btnSetTarget){
      DOM.btnSetTarget.addEventListener('click', ()=>{
        const book=DOM.inBook?.value||''; const wc=DOM.inWc?.value||'';
        if(!book||!wc){ alert('book ã¨ wc ã‚’å…¥åŠ›ï¼ˆé¸æŠï¼‰ã—ã¦ãã ã•ã„'); return; }
        setTarget(book,wc,''); updateStatus('ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®š','ok');
        showBigMessage('æ‰‹å‹•ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨­å®š', `ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: Book=${book} / WC=${wc}`);
        speakLineOnce(`ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ book ${book} ã€ ${wc} ã«è¨­å®šã—ã¾ã—ãŸã€‚ã€€æŠœå‹ã®QRã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ãã ã•ã„`);
        if(!state.currentShelf){ fetchShelfFromGSheet(book,wc); } else { promptScanShelf(); }
        // ä»•æ§˜ã¨å›³é¢
        querySpec();
      });
    }

    // é™æ­¢ç”»ãƒ†ã‚¹ãƒˆï¼ˆæ®ãˆç½®ãï¼‰
    DOM.fileTest.addEventListener('change', async (ev)=>{
      const file=ev.target.files?.[0]; if(!file) return;
      const img=new Image();
      img.onload=async ()=>{
        const c=document.createElement('canvas'); c.width=img.width; c.height=img.height;
        const ictx=c.getContext('2d',{willReadFrequently:true}); ictx.drawImage(img,0,0);
        const imgData=ictx.getImageData(0,0,c.width,c.height);
        const hits=jsqrMulti(imgData).map(h=>({ rawValue:h.rawValue, cornerPoints:h.cornerPoints }));
        DOM.overlay.width=img.width; DOM.overlay.height=img.height;
        applyDetections(hits);
        updateStatus(`é™æ­¢ç”»ãƒ†ã‚¹ãƒˆ: ${hits.length}ä»¶æ¤œçŸ¥`);
        ev.target.value="";
      };
      img.src=URL.createObjectURL(file);
    });
    function jsqrMulti(imgData){
      const hits=[]; const w=imgData.width,h=imgData.height; const masked=new Uint8ClampedArray(imgData.data);
      for(let k=0;k<10;k++){
        const hit=jsQR(masked,w,h,{inversionAttempts:'dontInvert'}); if(!hit) break;
        hits.push({ rawValue:hit.data, cornerPoints:[ hit.location.topLeftCorner, hit.location.topRightCorner, hit.location.bottomRightCorner, hit.location.bottomLeftCorner ] });
        const tl=hit.location.topLeftCorner, br=hit.location.bottomRightCorner;
        for(let y=Math.floor(tl.y); y<Math.ceil(br.y); y++){ for(let x=Math.floor(tl.x); x<Math.ceil(br.x); x++){ const i=(y*w+x)*4; masked[i]=masked[i+1]=masked[i+2]=255; } }
      }
      return hits;
    }

    // åˆæœŸåŒ–ï¼šURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã€CSRFå–å¾—
    (function initialize(){
      ensureCsrf();
      const params=new URLSearchParams(location.search);
      const book=(params.get('book')||'').trim(); const wc=(params.get('wc')||'').trim(); const wn=(params.get('wn')||'').trim();
      if(book||wc){ setTarget(book,wc,wn); updateStatus('æº–å‚™å®Œäº†'); querySpec(); }
      const locParam=(params.get('loc')||'').trim();
      if(locParam){ state.currentShelf=locParam; DOM.currentShelf.textContent=state.currentShelf; DOM.currentShelf.className='shelf-value'; promptScanShelf(); }
      else if(book&&wc){ fetchShelfFromGSheet(book,wc); }
      addTargetScope();
    })();
  });
  </script>
</body>
</html>
