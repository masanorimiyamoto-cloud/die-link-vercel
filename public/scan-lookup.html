<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>æŠœå‹ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼ QRï¼ˆé«˜ç²¾åº¦ãƒ»å®‰å®šç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <style>
    /* ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ»ã‚¹ã‚¿ã‚¤ãƒ«ã¯æ—¢å­˜ã®ã‚‚ã®ã‚’ç¶™æ‰¿ã—ã¤ã¤æœ€é©åŒ– */
    :root {
      --ok:#1c7ed6; --ng:#e03131; --loc:#2b8a3e; --info:#f59f00;
      --bd:#dee2e6; --tx:#212529; --sub:#6c757d; --bg:#f8f9fa;
      --bg-ok:#e7f5ff; --bg-ng:#fff5f5; --bg-loc:#e6fcf5;
    }
    html,body{margin:0;background:var(--bg);color:var(--tx);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
    .topbar{position: sticky; top: 0; z-index: 1000; display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding:10px; background:#fff; border-bottom:1px solid var(--bd); box-shadow:0 4px 12px rgba(0,0,0,.06); }
    .chip{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--bd);background:#fff;font-size:12px;font-weight:700}
    .chip.ok{background:#e7f5ff;color:#1c7ed6;border-color:#a5d8ff}
    .chip.ng{background:#fff5f5;color:#e03131;border-color:#ffc9c9}
    .chip.loc{background:var(--bg-loc);color:var(--loc);border-color:#96f2d7}
    .btn{padding:10px 14px;border:1px solid var(--bd);border-radius:10px;background:#fff;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--ok);color:#fff;border-color:var(--ok)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .wrap{max-width:1200px;margin:0 auto;padding:12px}
    .row{display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start}
    .panel{flex:1 1 360px;min-width:320px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 2px 8px rgba(0,0,0,.04)}
    h4{margin:0 0 8px 0}
    .muted{color:var(--sub);font-size:14px}
    .stack{position:relative;border:1px solid var(--bd);border-radius:12px;overflow:hidden;background:#000}
    video{display:block;width:100%;max-width:520px;border-radius:12px;background:#000}
    canvas{position:absolute;inset:0;pointer-events:none}
    #overlay{z-index:2}
    .target-scope{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%); width:200px;height:200px;border:2px solid rgba(28,126,214,0.8);border-radius:12px; pointer-events:none;z-index:10;box-shadow:0 0 0 9999px rgba(0,0,0,.3); }
    .scan-line{position:absolute;top:0;left:0;width:100%;height:2px;background:linear-gradient(90deg,transparent,rgba(28,126,214,.8),transparent);animation:scan 2s linear infinite}
    @keyframes scan{0%{top:0}100%{top:100%}}
    .toast{position:absolute;padding:8px 12px;background:#000c;color:#fff;border-radius:8px;font-size:14px;transform:translate(-50%,-150%);pointer-events:none;animation:fade-out 1.2s forwards}
    @keyframes fade-out{from{opacity:1}to{opacity:0}}
    .bigmsg{position:fixed;left:50%;top:18%;transform:translateX(-50%);z-index:1200; background:rgba(28,126,214,.95);color:#fff;padding:16px 22px;border-radius:12px;font-size:clamp(18px,3.2vw,26px); box-shadow:0 8px 24px rgba(0,0,0,.2);text-align:center;pointer-events:none;animation:bigmsg-fade 1.2s ease-out forwards}
    @keyframes bigmsg-fade{0%{opacity:0;transform:translate(-50%,-8px)}10%{opacity:1;transform:translate(-50%,0)}80%{opacity:1}100%{opacity:0;transform:translate(-50%,-8px)}}
    .kvs{display:grid;grid-template-columns:max-content 1fr;gap:6px 10px;font-size:14px}
    .shelf-value{margin-left:auto;text-align:right;font-weight:800;font-size:clamp(24px,5vw,36px);letter-spacing:.02em;padding:2px 0}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.5)}
    .modal-content{background:#fff;margin:10% auto;padding:20px;width:90%;max-width:640px;border-radius:12px}
  </style>
</head>
<body>

  <div class="topbar">
    <button id="btnStart" class="btn primary">ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
    <button id="btnStop" class="btn" disabled>åœæ­¢</button>
    <span id="scanStatus" class="chip">å¾…æ©Ÿä¸­</span>
    <span id="detectorInfo" class="chip">æ¤œå‡ºå™¨: â€”</span>
    <span id="targetNow" class="chip">Target: â€” / â€”</span>
  </div>

  <div class="wrap">
    <div class="row">
      <div class="panel">
        <div class="card">
          <h4>ğŸ“· ã‚¹ã‚­ãƒ£ãƒ³</h4>
          <div class="stack" id="stack">
            <video id="video" playsinline muted></video>
            <canvas id="overlay"></canvas>
          </div>
          <div id="error" class="muted" style="color:#b00;white-space:pre-wrap;margin-top:8px;"></div>
        </div>
      </div>

      <div class="panel">
        <div class="card">
          <h4>ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ</h4>
          <div class="kvs">
            <b>Book</b><div id="tgtBN">-</div>
            <b>WC</b><div id="tgtWC">-</div>
            <b>Name</b><div id="tgtWN" class="muted">â€”</div>
          </div>
        </div>

        <div class="card" style="display:flex;align-items:center;">
          <h4>æ¢ã™ã¹ãæ£šï¼š</h4>
          <div id="currentShelf" class="shelf-value">ï¼ˆæœªæŒ‡å®šï¼‰</div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h4>Google Sheetsï¼ˆä»•æ§˜ï¼‰</h4>
            <span id="loading" class="muted" style="display:none">ç…§ä¼šä¸­â€¦</span>
          </div>
          <div id="gsBox" class="kvs"><div class="muted">ï¼ˆæœªå–å¾—ï¼‰</div></div>
        </div>

        <div class="card">
          <h4>Google Driveï¼ˆå›³é¢ï¼‰</h4>
          <div id="driveStatus" class="muted">â€”</div>
          <div id="driveView" style="margin-top:6px"></div>
        </div>

        <button id="btnHistory" class="btn" style="width:100%">ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´ã‚’è¡¨ç¤º</button>
      </div>
    </div>
  </div>

  <div id="historyModal" class="modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between">
        <h4>ã‚¹ã‚­ãƒ£ãƒ³å±¥æ­´</h4>
        <span id="closeModal" style="cursor:pointer;font-size:24px">&times;</span>
      </div>
      <ul id="historyList" style="list-style:none;padding:0;max-height:400px;overflow-y:auto"></ul>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const DOM = {
      btnStart: document.querySelector('#btnStart'), btnStop: document.querySelector('#btnStop'),
      scanStatus: document.querySelector('#scanStatus'), detectorInfo: document.querySelector('#detectorInfo'),
      video: document.querySelector('#video'), overlay: document.querySelector('#overlay'),
      stack: document.querySelector('#stack'), error: document.querySelector('#error'),
      tgtBN: document.querySelector('#tgtBN'), tgtWC: document.querySelector('#tgtWC'), tgtWN: document.querySelector('#tgtWN'),
      currentShelf: document.querySelector('#currentShelf'),
      loading: document.querySelector('#loading'), gsBox: document.querySelector('#gsBox'),
      driveStatus: document.querySelector('#driveStatus'), driveView: document.querySelector('#driveView'),
      btnHistory: document.querySelector('#btnHistory'), historyModal: document.querySelector('#historyModal'),
      historyList: document.querySelector('#historyList'), closeModal: document.querySelector('#closeModal'),
      targetNow: document.querySelector('#targetNow')
    };
    const ctx = DOM.overlay.getContext('2d', { willReadFrequently: true });

    const state = {
      stream: null, rafId: null,
      detector: ('BarcodeDetector' in window) ? new BarcodeDetector({formats:['qr_code']}) : null,
      offCanvas: document.createElement('canvas'),
      isLocked: false, holdTimer: null,
      currentTarget: { book:'', wc:'', wn:'' }, targetKey: '',
      currentShelf: null, scanHistory: new Map(),
      lastOrderKey: '', lastOrderAt: 0, lastQueryKey: '',
      csrf: ''
    };

    /* utils */
    const esc = s => String(s??'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const dieKey = (bn, wc) => `${(bn||'').trim().toLowerCase()}@${(wc||'').trim().toLowerCase()}`;
    const normalize = s => (s||"").replace(/[â€-â€’â€“â€”â€•ãƒ¼âˆ’]/g, "-").trim();

    /* TTS */
    function speak(text, cooldown = 1500) {
      if (!('speechSynthesis' in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'ja-JP'; u.rate = 1.1;
      window.speechSynthesis.speak(u);
    }

    /* ã‚«ãƒ¡ãƒ©ãƒ»ã‚¹ã‚­ãƒ£ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ */
    async function startCam() {
      try {
        state.stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
        });
        DOM.video.srcObject = state.stream;
        await DOM.video.play();
        
        DOM.btnStart.disabled = true; DOM.btnStop.disabled = false;
        DOM.detectorInfo.textContent = state.detector ? 'æ¤œå‡ºå™¨: Native' : 'æ¤œå‡ºå™¨: jsQR';

        // ã‚«ãƒ¡ãƒ©å®‰å®šå¾…ã¡ (é‡è¦)
        updateStatus('ã‚«ãƒ¡ãƒ©èª¿æ•´ä¸­...');
        setTimeout(() => { if(state.stream) { tick(); updateStatus('æ¢ç´¢ä¸­â€¦'); } }, 500);
        addTargetScope();
      } catch (e) {
        DOM.error.textContent = `âŒ ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: ${e.message}`;
      }
    }

    function stopCam() {
      if(state.rafId) cancelAnimationFrame(state.rafId);
      if(state.stream) state.stream.getTracks().forEach(t => t.stop());
      state.stream = null; DOM.btnStart.disabled = false; DOM.btnStop.disabled = true;
    }

    async function tick() {
      if (!state.stream || DOM.video.readyState !== 4) {
        state.rafId = requestAnimationFrame(tick);
        return;
      }

      // è§£æç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã®æ›´æ–°
      if (state.offCanvas.width !== DOM.video.videoWidth) {
        state.offCanvas.width = DOM.video.videoWidth;
        state.offCanvas.height = DOM.video.videoHeight;
        DOM.overlay.width = DOM.video.videoWidth;
        DOM.overlay.height = DOM.video.videoHeight;
      }
      const octx = state.offCanvas.getContext('2d', {willReadFrequently:true});
      octx.drawImage(DOM.video, 0, 0);

      const detections = await detectAll();
      processDetections(detections);

      state.rafId = requestAnimationFrame(tick);
    }

    async function detectAll() {
      const results = new Map();
      // 1. Nativeå„ªå…ˆ
      if (state.detector) {
        try {
          const codes = await state.detector.detect(state.offCanvas);
          codes.forEach(c => results.set(c.rawValue, { raw: c.rawValue, pts: c.cornerPoints }));
        } catch {}
      }
      // 2. jsQRè£œå®Œ (Nativeã§è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ)
      if (results.size === 0) {
        const img = octx.getImageData(0, 0, state.offCanvas.width, state.offCanvas.height);
        const code = jsQR(img.data, img.width, img.height);
        if (code) results.set(code.data, { raw: code.data, pts: [code.location.topLeftCorner, code.location.topRightCorner, code.location.bottomRightCorner, code.location.bottomLeftCorner] });
      }
      return Array.from(results.values());
    }

    function processDetections(detections) {
      ctx.clearRect(0, 0, DOM.overlay.width, DOM.overlay.height);
      detections.forEach(d => {
        const raw = normalize(d.raw);
        // ç¨®åˆ¥åˆ¤å®š
        if (raw.includes('order')) {
          handleOrder(raw, d.pts);
        } else if (raw.includes('die') || raw.includes('book=')) {
          handleDie(raw, d.pts);
        } else if (raw.includes('loc=')) {
          handleLoc(raw, d.pts);
        }
      });
    }

    function handleOrder(raw, pts) {
      // ä½œæ¥­æŒ‡ç¤ºQRã®ãƒ‘ãƒ¼ã‚¹
      const url = new URL(raw.startsWith('http') ? raw : 'http://x?' + raw);
      const bn = url.searchParams.get('book') || url.searchParams.get('Book');
      const wc = url.searchParams.get('wc') || url.searchParams.get('WorkCord');
      
      if (bn && wc) {
        const key = dieKey(bn, wc);
        if (key !== state.targetKey && Date.now() - state.lastOrderAt > 2000) {
          state.currentTarget = { book: bn, wc: wc, wn: '' };
          state.targetKey = key;
          state.lastOrderAt = Date.now();
          updateTargetUI();
          showBigMsg('ä½œæ¥­æŒ‡ç¤ºã‚’å—ç†', `ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ: ${bn} / ${wc}`);
          speak(`ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚’ãƒ–ãƒƒã‚¯${bn}ã€ãƒ¯ãƒ¼ã‚¯ã‚³ãƒ¼ãƒ‰${wc}ã«è¨­å®šã—ã¾ã—ãŸ`);
          querySpec(); // å³åº§ã«ãƒ‡ãƒ¼ã‚¿å–å¾—
        }
        drawBox(pts, '#f59f00', 'æŒ‡ç¤ºæ›¸');
      }
    }

    function handleDie(raw, pts) {
      const key = raw.includes('die-') ? raw.replace('die-', '') : dieKey(new URL(raw).searchParams.get('book'), new URL(raw).searchParams.get('wc'));
      const isMatch = state.targetKey && key.toLowerCase().includes(state.targetKey);

      if (isMatch && !state.isLocked) {
        state.isLocked = true;
        if(navigator.vibrate) navigator.vibrate([100, 50, 100]);
        showBigMsg('ä¸€è‡´ã—ã¾ã—ãŸï¼', state.currentTarget.book + '-' + state.currentTarget.wc);
        speak('å‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
        querySpec(); // ä¸€è‡´ã—ãŸã¨ãã‚‚å¿µã®ãŸã‚æœ€æ–°ã‚’å–å¾—
        setTimeout(() => state.isLocked = false, 3000);
      }
      drawBox(pts, isMatch ? '#1c7ed6' : '#e03131', isMatch ? 'ä¸€è‡´' : 'ä¸ä¸€è‡´');
    }

    function handleLoc(raw, pts) {
      const loc = new URL(raw.startsWith('http') ? raw : 'http://x?' + raw).searchParams.get('loc');
      const isMatch = state.currentShelf && loc === state.currentShelf;
      drawBox(pts, isMatch ? '#2b8a3e' : '#e03131', isMatch ? 'æ£šä¸€è‡´' : 'æ£šé•ã„');
    }

    /* UIè£œåŠ© */
    function updateStatus(txt, cls='') { DOM.scanStatus.textContent = txt; DOM.scanStatus.className = 'chip ' + cls; }
    function updateTargetUI() {
      DOM.tgtBN.textContent = state.currentTarget.book;
      DOM.tgtWC.textContent = state.currentTarget.wc;
      DOM.targetNow.textContent = `Target: ${state.currentTarget.book} / ${state.currentTarget.wc}`;
    }
    function drawBox(pts, color, label) {
      ctx.strokeStyle = color; ctx.lineWidth = 4;
      ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
      pts.forEach(p => ctx.lineTo(p.x, p.y)); ctx.closePath(); ctx.stroke();
    }
    function showBigMsg(txt, sub) {
      const el = document.createElement('div'); el.className = 'bigmsg';
      el.innerHTML = `<div>${txt}</div><div style="font-size:0.6em; opacity:0.8">${sub}</div>`;
      document.body.appendChild(el); setTimeout(() => el.remove(), 2000);
    }

    /* Data Fetch */
    async function querySpec() {
      const {book, wc} = state.currentTarget;
      if (!book || !wc || state.lastQueryKey === state.targetKey) return;
      state.lastQueryKey = state.targetKey;

      DOM.loading.style.display = 'inline';
      try {
        const res = await fetch(`/api/die-check?book=${book}&wc=${wc}&json=1`, { credentials: 'same-origin' });
        const data = await res.json();
        if (data.ok) {
          renderGS(data.gs || data.sheet);
          if (data.fileId) renderDrive(data);
        }
      } catch (e) { console.error(e); }
      finally { DOM.loading.style.display = 'none'; }
    }

    function renderGS(gs) {
      if(!gs) return;
      DOM.gsBox.innerHTML = `<b>å“å</b><div>${esc(gs.ItemName||'')}</div><b>æè³ª</b><div>${esc(gs.Material||'')}</div><b>æ£š</b><div>${esc(gs.Location||'')}</div>`;
      if(gs.Location) {
        state.currentShelf = gs.Location;
        DOM.currentShelf.textContent = gs.Location;
      }
    }

    function renderDrive(data) {
      const src = `/api/drive-proxy?id=${data.fileId}`;
      DOM.driveStatus.textContent = 'å›³é¢ã‚ã‚Š';
      DOM.driveView.innerHTML = `<img src="${src}" style="width:100%; border-radius:8px" />`;
    }

    function addTargetScope() {
      const s = document.createElement('div'); s.className = 'target-scope';
      s.innerHTML = '<div class="scan-line"></div>';
      DOM.stack.appendChild(s);
    }

    /* ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² */
    DOM.btnStart.onclick = startCam;
    DOM.btnStop.onclick = stopCam;
    DOM.btnHistory.onclick = () => {
      DOM.historyModal.style.display = 'block';
      // å±¥æ­´è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã¯æ—¢å­˜ã®ã‚‚ã®ã‚’æµç”¨å¯èƒ½
    };
    DOM.closeModal.onclick = () => DOM.historyModal.style.display = 'none';

    // åˆæœŸåŒ–
    const params = new URLSearchParams(location.search);
    if(params.get('book')) {
      state.currentTarget = { book: params.get('book'), wc: params.get('wc'), wn: '' };
      state.targetKey = dieKey(state.currentTarget.book, state.currentTarget.wc);
      updateTargetUI();
      querySpec();
    }
  });
  </script>
</body>
</html>