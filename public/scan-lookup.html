<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>scan-spec｜最小UI（カメラ＋仕様＋図面）</title>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<style>
  :root{--ok:#1c7ed6;--ng:#e03131;--loc:#2b8a3e;--tx:#212529;--sub:#6c757d;--bg:#f8f9fa;--bd:#dee2e6}
  html,body{margin:0;background:var(--bg);color:var(--tx);font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:12px}
  .top{position:sticky;top:0;z-index:10;display:flex;gap:10px;align-items:center;padding:10px;border:1px solid var(--bd);border-radius:12px;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:10px}
  .chip{display:inline-block;padding:4px 10px;border-radius:999px;border:1px solid var(--bd);background:#fff;font-size:12px;font-weight:700}
  .chip.ok{background:#e7f5ff;color:#1c7ed6;border-color:#a5d8ff}
  .chip.ng{background:#fff5f5;color:#e03131;border-color:#ffc9c9}
  .btn{padding:10px 14px;border:1px solid var(--bd);border-radius:10px;background:#fff;font-weight:600;cursor:pointer}
  .btn.primary{background:#1c7ed6;color:#fff;border-color:#1c7ed6}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:#fff;border:1px solid var(--bd);border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:12px}
  .title{display:flex;justify-content:space-between;align-items:center;margin:0 0 8px}
  .title h2{margin:0;font-size:16px}
  .muted{color:var(--sub);font-size:12px}
  .stack{position:relative;border:1px solid var(--bd);border-radius:12px;overflow:hidden;background:#000}
  video{display:block;width:100%;background:#000}
  canvas{position:absolute;inset:0;pointer-events:none}
  #freeze{z-index:1;display:none}
  #overlay{z-index:2}
  .kvs{display:grid;grid-template-columns:max-content 1fr;gap:6px 10px;font-size:14px}
  .kvs b{color:#333}
  .shelf{display:flex;gap:10px;align-items:center;margin-top:8px}
  .shelf .label{font-weight:700}
  .shelf .value{margin-left:auto;font-weight:800;font-size:clamp(20px,4.5vw,34px)}
</style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <button id="btnStart" class="btn primary">カメラ開始</button>
    <button id="btnStop" class="btn" disabled>停止</button>
    <span id="scanStatus" class="chip">待機中</span>
    <span id="detectorInfo" class="chip">jsQR</span>
    <span id="csrfStatus" class="chip">CSRF: 検査中…</span>
    <span id="targetNow" class="chip">Target: — / —</span>
  </div>

  <div class="grid">
    <!-- 左：カメラ -->
    <div class="card">
      <div class="title"><h2>スキャン</h2><span id="errCam" class="muted"></span></div>
      <div class="stack" id="stack">
        <video id="video" playsinline webkit-playsinline muted></video>
        <canvas id="freeze"></canvas>
        <canvas id="overlay"></canvas>
        <canvas id="scanCanvas" style="display:none"></canvas>
      </div>
    </div>

    <!-- 右：結果 -->
    <div class="card">
      <div class="title">
        <h2>結果</h2>
        <span id="loading" class="muted" style="display:none">照会中…</span>
      </div>

      <!-- ターゲット＆棚 -->
      <div class="kvs" style="margin-bottom:6px">
        <b>Book</b><div id="tBN">-</div>
        <b>WC</b><div id="tWC">-</div>
        <b>WorkName</b><div id="tWN" class="muted">—</div>
      </div>
      <div class="shelf">
        <span class="label">探すべき棚:</span>
        <div id="shelfVal" class="value">—</div>
      </div>

      <!-- 仕様 -->
      <div style="margin-top:14px">
        <h3 style="margin:0 0 6px;font-size:15px">Google Sheets（仕様）</h3>
        <div id="gsBox" class="kvs"><div class="muted">（未取得）</div></div>
        <div id="errApi" class="muted" style="display:none;margin-top:6px"></div>
      </div>

      <!-- 図面 -->
      <div style="margin-top:14px">
        <h3 style="margin:0 0 6px;font-size:15px">Google Drive（図面）</h3>
        <div id="driveStatus" class="muted">—</div>
        <div id="driveView" style="margin-top:6px"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js" crossorigin="anonymous"></script>
<script>
(() => {
  const D = {
    // UI
    btnStart: q('#btnStart'), btnStop: q('#btnStop'),
    scanStatus: q('#scanStatus'), detectorInfo: q('#detectorInfo'), csrfStatus: q('#csrfStatus'),
    errCam: q('#errCam'), loading: q('#loading'),
    // Video/canvas
    stack: q('#stack'), video: q('#video'), overlay: q('#overlay'), freeze: q('#freeze'), scanCanvas: q('#scanCanvas'),
    // Target/result
    targetNow: q('#targetNow'), tBN: q('#tBN'), tWC: q('#tWC'), tWN: q('#tWN'),
    shelfVal: q('#shelfVal'), gsBox: q('#gsBox'),
    driveStatus: q('#driveStatus'), driveView: q('#driveView'), errApi: q('#errApi')
  };
  const ctx = D.overlay.getContext('2d', { willReadFrequently:true });
  const fctx = D.freeze.getContext('2d', { willReadFrequently:true });
  const sctx = D.scanCanvas.getContext('2d', { willReadFrequently:true });

  const S = {
    stream:null, rafId:null, csrf:'', locked:false,
    current:{ book:'', wc:'', wn:'' }, lastKey:''
  };

  // ---------- helpers ----------
  function q(s){ return document.querySelector(s); }
  function esc(s){ return String(s??'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
  const dieKey = (bn,wc) => (bn||'').toLowerCase()+'@@'+(wc||'').toLowerCase();
  const normHyphen = s => (s||'').replace(/[‐-‒–—―ー−]/g,'-').trim();
  const classify = raw => {
    const t = normHyphen(raw||'');
    if(/^die-/i.test(t)) return 'die';
    if(/^order-/i.test(t) || /order[_-]?plain/i.test(t)) return 'order';
    try{ const u=new URL(t);
      if(/order[_-]?plain/i.test(u.pathname+u.search)) return 'order';
      if(u.searchParams.has('book')||u.searchParams.has('wc')) return 'die';
    }catch{}
    return 'other';
  };
  const parseOrder = raw => {
    const t=normHyphen(raw||''); let m=/^order-([^-\n]+)-([^-]+)/i.exec(t);
    if(m) return { bn:m[1].trim(), wc:m[2].trim() };
    try{ const u=new URL(t);
      if(/order[_-]?plain/i.test(u.pathname+u.search)){
        const bn=(u.searchParams.get('book')||u.searchParams.get('Book')||'').trim();
        const wc=(u.searchParams.get('wc')||u.searchParams.get('WorkCord')||'').trim();
        if(bn||wc) return { bn, wc };
      }
    }catch{}
    m=/order(?:[_-]?plain)?[:\s-]+([^\s/:-]+)[\s/:-]+([^\s/:-]+)/i.exec(t);
    return m?{ bn:m[1].trim(), wc:m[2].trim() }:null;
  };
  const parseDie = raw => {
    const t=normHyphen(raw||''); const m=/^die-([^-\n]+)-([^-]+)(?:-(.+))?$/i.exec(t);
    if(m) return { bn:m[1].trim(), wc:m[2].trim(), wn:(m[3]||'').trim() };
    try{ const u=new URL(t);
      const bn=(u.searchParams.get('book')||'').trim(), wc=(u.searchParams.get('wc')||'').trim();
      if(bn||wc) return { bn, wc, wn:(u.searchParams.get('wn')||'').trim() };
    }catch{}
    return null;
  };

  // ---------- CSRF ----------
  const isLocal = () => location.protocol==='http:' && /localhost|127\.0\.0\.1/.test(location.host);
  const readCookie = name => { const m=document.cookie.match(new RegExp('(?:^|; )'+name.replace(/[-/\\^$*+?.()|[\]{}]/g,'\\$&')+'=([^;]*)')); return m?decodeURIComponent(m[1]):''; };
  async function ensureCsrf(){
    let t=readCookie('xcsrf');
    if(!t){ const url=isLocal()?'/api/session?dev=1':'/api/session'; await fetch(url,{method:'GET',credentials:'same-origin',cache:'no-store'}).catch(()=>{}); t=readCookie('xcsrf'); }
    if(t){ S.csrf=t; D.csrfStatus.textContent='CSRF: 有効'; D.csrfStatus.className='chip ok'; }
    else { D.csrfStatus.textContent='CSRF: 未取得'; D.csrfStatus.className='chip ng'; }
  }
  document.addEventListener('DOMContentLoaded', ensureCsrf);

  // ---------- camera ----------
  function fitOverlay(){
    if(!D.video.videoWidth) return;
    D.overlay.width=D.video.videoWidth; D.overlay.height=D.video.videoHeight;
    D.overlay.style.width=D.video.clientWidth+'px'; D.overlay.style.height=D.video.clientHeight+'px';
    D.freeze.width=D.video.videoWidth; D.freeze.height=D.video.videoHeight;
    D.freeze.style.width=D.video.clientWidth+'px'; D.freeze.style.height=D.video.clientHeight+'px';
  }
  function setStatus(text, kind=''){ D.scanStatus.textContent=text; D.scanStatus.className='chip'+(kind?' '+kind:''); }
  function reallyStop(){ if(S.stream){ try{ S.stream.getTracks().forEach(t=>t.stop()); }catch{} } S.stream=null; }
  function stopCam({keep=false}={}){ if(S.rafId) cancelAnimationFrame(S.rafId); S.rafId=null;
    if(!keep){ ctx.clearRect(0,0,D.overlay.width,D.overlay.height); D.freeze.style.display='none'; D.video.style.visibility='visible'; }
    reallyStop(); D.btnStart.disabled=false; D.btnStop.disabled=true; setStatus('停止中'); }
  async function startCam(){
    stopCam(); D.errCam.textContent=''; S.locked=false;
    try{
      S.stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'}, width:{ideal:1280}, height:{ideal:720} }, audio:false });
      D.video.srcObject=S.stream; await D.video.play(); D.btnStart.disabled=true; D.btnStop.disabled=false;
      fitOverlay();
      // downscale buffer for jsQR
      const vw=D.video.videoWidth||1280, vh=D.video.videoHeight||720, baseW=640, baseH=Math.round(baseW*(vh/vw));
      D.scanCanvas.width=baseW; D.scanCanvas.height=baseH;
      setStatus('探索中…'); tick();
    }catch(e){ D.errCam.textContent=`❌ ${e.name||''} ${e.message||e}`; setStatus('カメラエラー','ng'); }
  }
  function lockFrame(){
    try{
      fitOverlay(); fctx.clearRect(0,0,D.freeze.width,D.freeze.height); fctx.drawImage(D.video,0,0,D.freeze.width,D.freeze.height);
      D.freeze.style.display='block'; D.video.style.visibility='hidden'; ctx.clearRect(0,0,D.overlay.width,D.overlay.height);
    }catch{}
    setStatus('ロック完了','ok'); stopCam({keep:true});
  }

  // ---------- scan ----------
  function scanOnce(){
    if(D.video.readyState!==D.video.HAVE_ENOUGH_DATA) return null;
    sctx.drawImage(D.video,0,0,D.scanCanvas.width,D.scanCanvas.height);
    const img=sctx.getImageData(0,0,D.scanCanvas.width,D.scanCanvas.height);
    const hit=jsQR(img.data,img.width,img.height,{ inversionAttempts:'attemptBoth' });
    if(!hit) return null;
    const sx=D.overlay.width/D.scanCanvas.width, sy=D.overlay.height/D.scanCanvas.height;
    const pts=[hit.location.topLeftCorner,hit.location.topRightCorner,hit.location.bottomRightCorner,hit.location.bottomLeftCorner].map(p=>({x:p.x*sx,y:p.y*sy}));
    return { rawValue:(hit.data||'').trim(), cornerPoints:pts };
  }
  function drawBox(pts,color='#1c7ed6'){ if(!pts||pts.length<4)return; ctx.save(); ctx.lineWidth=5; ctx.strokeStyle=color; ctx.shadowColor=color; ctx.shadowBlur=6;
    ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y); for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x,pts[i].y); ctx.closePath(); ctx.stroke(); ctx.restore(); }

  async function tick(){
    if(!S.stream) return;
    if(D.video.readyState===D.video.HAVE_ENOUGH_DATA){
      fitOverlay(); ctx.clearRect(0,0,D.overlay.width,D.overlay.height);
      const hit=scanOnce();
      if(hit){
        drawBox(hit.cornerPoints);
        const kind=classify(hit.rawValue);
        let bn='', wc='', wn='';
        if(kind==='order'){ const od=parseOrder(hit.rawValue); if(od){ bn=od.bn||''; wc=od.wc||''; } }
        else if(kind==='die'){ const d=parseDie(hit.rawValue); if(d){ bn=d.bn||''; wc=d.wc||''; wn=d.wn||''; } }
        if(bn||wc){
          setTarget(bn,wc,wn);
          S.locked=true; lockFrame(); S.lastKey=''; querySpec();
          return;
        }
      }
    }
    S.rafId=requestAnimationFrame(tick);
  }

  function setTarget(book,wc,wn=''){
    S.current.book=(book||'').trim(); S.current.wc=(wc||'').trim(); S.current.wn=(wn||'').trim();
    D.targetNow.textContent=`Target: ${S.current.book||'—'} / ${S.current.wc||'—'}`;
    D.tBN.textContent=S.current.book||'-'; D.tWC.textContent=S.current.wc||'-'; D.tWN.textContent=S.current.wn||'—';
  }

  // ---------- fetch spec + drive ----------
  async function querySpec(){
    const {book,wc}=S.current; if(!book||!wc) return;
    const key=dieKey(book,wc); if(key===S.lastKey) return; S.lastKey=key;
    D.errApi.style.display='none'; D.errApi.textContent=''; D.loading.style.display='inline';
    D.gsBox.innerHTML='<div class="muted">取得中…</div>'; D.driveStatus.textContent='—'; D.driveView.innerHTML=''; D.shelfVal.textContent='—';
    try{
      if(!S.csrf) await ensureCsrf();
      const r=await fetch('/api/die-check',{ method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json', ...(S.csrf?{'X-CSRF':S.csrf}:{})}, body:JSON.stringify({ book, wc, json:true, limit:0, noAirtable:true, gsOnly:true }) });
      const txt=await r.text(); let j={}; try{ j=JSON.parse(txt); }catch{ throw new Error(`JSON Parse error: ${txt.slice(0,200)}`); }
      if(!r.ok || j.ok!==true) throw new Error(j?.error||`HTTP ${r.status}`);
      renderSpec(j);
      openDriveFigure((j.book||book),(j.workcord||wc));
    }catch(e){
      D.errApi.style.display='block'; D.errApi.textContent='❌ APIエラー: '+(e.message||e);
      D.gsBox.innerHTML='<div class="muted">（Google Sheets を取得できませんでした）</div>';
    }finally{ D.loading.style.display='none'; }
  }

  function renderSpec(payload){
    const gs = payload?.gs || {};
    // 仕様
    if(gs && (gs.ItemName||gs.Kname||gs.Material)){
      D.gsBox.innerHTML=`
        <div class="kvs">
          <b>ItemName</b><div>${esc(gs.ItemName||'')}</div>
          <b>Kname</b><div>${esc(gs.Kname||'')}</div>
          <b>Material</b><div>${esc(gs.Material||'')}</div>
          <b>Paper_Size</b><div>${esc(gs.Paper_Size||'')}</div>
          <b>Cut_Size</b><div>${esc(gs.Cut_Size||'')}</div>
          <b>Location</b><div>${esc(gs.Location||'')}</div>
          <b>LastSeen</b><div>${esc(gs.LastSeen||'')}</div>
          <b>Ndate</b><div>${esc(gs.Ndate||'')}</div>
        </div>`;
    }else{
      D.gsBox.innerHTML='<div class="muted">（一致行なし）</div>';
    }
    // 棚
    const loc = (gs?.Location ?? gs?.Loc ?? '').toString().trim();
    D.shelfVal.textContent = loc || '—';
  }

  async function openDriveFigure(book,wc){
    if(!book||!wc){ D.driveStatus.textContent='Book/WC 未指定'; D.driveView.innerHTML=''; return; }
    D.driveStatus.textContent='検索中…'; D.driveView.innerHTML='';
    try{
      const r=await fetch(`/api/drive-find?book=${encodeURIComponent(book)}&wc=${encodeURIComponent(wc)}`,{ credentials:'same-origin', cache:'no-store' });
      if(!r.ok){ const t=await r.text().catch(()=> ''); throw new Error(`drive-find HTTP ${r.status}: ${t.slice(0,200)}`); }
      const j=await r.json().catch(()=> ({}));
      if(j?.ok!==true){ D.driveStatus.textContent='NG: 応答不正'; return; }
      const cands = Array.isArray(j.candidates)&&j.candidates.length ? j.candidates : (j.fileId ? [{id:j.fileId,name:j.fileName||`${book}-${wc}`}]:[]);
      if(cands.length===0){ D.driveStatus.textContent='一致ファイルなし'; D.driveView.innerHTML=''; return; }

      // -zu > -si > 画像 > PDF
      const score = f => { const n=(f?.name||'').toLowerCase(); const isPdf=n.endsWith('.pdf'); const isImg=/\.(jpeg|jpg|png)$/.test(n);
        const hasZu=/-zu\.(jpeg|jpg|png)$/.test(n); const hasSi=/-si\.(jpeg|jpg|png)$/.test(n);
        if(isImg&&hasZu) return 1; if(isImg&&hasSi) return 2; if(isImg) return 3; if(isPdf) return 9; return 99; };
      cands.sort((a,b)=>score(a)-score(b));
      const primary=cands[0];
      const isPdf=(primary.name||'').toLowerCase().endsWith('.pdf');
      const src=`/api/drive-proxy?id=${encodeURIComponent(primary.id)}&name=${encodeURIComponent(primary.name||`${book}-${wc}`)}`;
      D.driveView.innerHTML = isPdf
        ? `<iframe src="${src}" style="width:100%;height:60vh;border:1px solid #e9ecef;border-radius:10px"></iframe>`
        : `<img src="${src}" alt="${esc(primary.name||'figure')}" style="max-width:100%;height:auto;border:1px solid #e9ecef;border-radius:10px;background:#fff" />`;
      D.driveStatus.textContent=`ヒット: ${cands.length}（表示: ${primary.name||'-'}）`;
    }catch(e){ D.driveStatus.textContent='NG: '+(e.message||e); D.driveView.innerHTML=''; }
  }

  // ---------- init / events ----------
  function initFromParams(){
    const p=new URLSearchParams(location.search);
    const bn=(p.get('book')||'').trim(), wc=(p.get('wc')||'').trim();
    if(bn||wc){ setTarget(bn,wc); querySpec(); }
  }

  D.btnStart.addEventListener('click', startCam);
  D.btnStop.addEventListener('click', ()=> stopCam());
  window.addEventListener('resize', fitOverlay);
  document.addEventListener('DOMContentLoaded', initFromParams);
})();
</script>
</body>
</html>
